function formatIOSDateStr(dateStr){return dateStr.replace(/-/g,"/")}function init(){var goodsList=document.getElementById("goods_list"),beginGoods=goodsList.querySelectorAll("li"),today=new Date;Array.prototype.forEach.call(beginGoods,function(curGoods,index){var curBtn=curGoods.querySelector("a.btn");if(curGoods.classList.contains("unbegin")){"1"==curGoods.dataset.issetcaution?curBtn.innerText="已关注":curBtn.innerText="提醒我";var startTime=new Date(formatIOSDateStr(curGoods.dataset.start)),dateDescription="";today.getFullYear()==startTime.getFullYear()&&today.getMonth()==startTime.getMonth()&&(today.getDate()==startTime.getDate()?dateDescription="今天":startTime.getDate()-today.getDate()==1&&(dateDescription="明天")),""!==dateDescription&&(curGoods.querySelector(".purchase_tip").innerHTML=dateDescription+("0"+startTime.getHours()).slice(-2)+":"+("0"+startTime.getMinutes()).slice(-2)+"开抢")}else new Date(formatIOSDateStr(curGoods.querySelector(".countdown").dataset.end)).getTime()<(new Date).getTime()?(curBtn.innerText="已结束",curGoods.classList.add("end"),curGoods.querySelector(".bottom .right").style.display="none",curBtn.href=curGoods.dataset.href):(curBtn.innerText="马上抢",curBtn.href=curGoods.dataset.href)});for(var countDownArr=document.querySelectorAll(".countdown"),i=0,len=countDownArr.length;len>i;i++)initializeClock(countDownArr[i],countDownArr[i].dataset.end);for(var unBeginGoods=document.querySelectorAll("li.unbegin"),i=0,len=unBeginGoods.length;len>i;i++)getTimeRemaining(unBeginGoods[i].dataset.start).total<=0&&start_buy(unBeginGoods[i]),function(i){unBeginGoods[i].timer=setInterval(function(){getTimeRemaining(unBeginGoods[i].dataset.start).total<=0&&start_buy(unBeginGoods[i])},1e3)}(i);var xhr=new XMLHttpRequest,shareSection=document.querySelector("#share_section"),followSection=document.querySelector("#follow_section");goodsList.addEventListener("click",function(event){if(event.target.classList.contains("btn")){var curBtn=event.target,curLi=getClosestParent(curBtn,"LI");if(!curLi.classList.contains("unbegin")||"1"==curLi.dataset.issetcaution)return;"1"==isFollowed?(shareSection.style.display="block",Array.prototype.forEach.call(shareSection.querySelectorAll(".lazy_load"),function(curVal,index){lazyLoad(curVal,curVal.dataset.src)})):(followSection.style.display="block",Array.prototype.forEach.call(followSection.querySelectorAll(".lazy_load"),function(curVal,index){console.log(curVal),lazyLoad(curVal,curVal.dataset.src)})),xhr.onreadystatechange=function(ev){var DONE=4,OK=200;xhr.readyState===DONE&&(xhr.status===OK?(curBtn.innerText="已关注",curLi.dataset.issetcaution="1",curLi.querySelector(".bottom .right").innerHTML="已有"+(parseInt(curLi.dataset.follow,10)+1)+"人关注"):(console.log("Error: "+xhr.status),alert("关注失败")))},xhr.open("GET","remindMe?wxShopId="+wxShopId+"&actId="+actId+"&pGoodsId="+curLi.dataset.pgoodsid+"&time="+(new Date).getTime(),!0),xhr.send()}},!1),shareSection.addEventListener("click",function(event){this.style.display="none"},!1),followSection.addEventListener("click",function(event){this.style.display="none"},!1),followSection.querySelector(".follow_btn").addEventListener("click",function(event){event.stopPropagation()},!1);var announcement=document.querySelector("#announcement_container"),announcementContent=announcement.querySelector("p"),announcementWidth=announcement.offsetWidth-12,announcementContentWidth=announcementContent.offsetWidth;announcementContentWidth>announcementWidth&&(announcement.innerHTML="<marquee direction='left' scrolldelay='16' scrollamount='2'>"+announcementContent.innerHTML+"</marquee>")}function lazyLoad(lazyObj,loadPath,cb){"IMG"===lazyObj.tagName&&(void 0!=cb&&(lazyObj.onload=function(){cb()},lazyObj.complete&&lazyObj.load(),lazyObj.onload=null),lazyObj.src=loadPath)}function getTimeRemaining(endtime){endtime=formatIOSDateStr(endtime);var t=Date.parse(endtime)-Date.parse(new Date),seconds=Math.floor(t/1e3%60),minutes=Math.floor(t/1e3/60%60),hours=Math.floor(t/36e5%24),days=Math.floor(t/864e5);return{total:t,days:days,hours:hours,minutes:minutes,seconds:seconds}}function initializeClock(relatedObj,endtime){function updateClock(){var t=getTimeRemaining(endtime);return t.total<=0?(end_buy(clock),void clearInterval(timeinterval)):void(clock.innerHTML=t.days+"天 <span>"+("0"+t.hours).slice(-2)+"</span> : <span>"+("0"+t.minutes).slice(-2)+"</span> : <span>"+("0"+t.seconds).slice(-2)+"</span>")}var clock=relatedObj;endtime=formatIOSDateStr(endtime),updateClock();var timeinterval=setInterval(updateClock,1e3)}function end_buy(relatedObj){var closestNode=getClosestParent(relatedObj,"li");closestNode.classList.add("end");var buyButton=closestNode.querySelector(".btn");buyButton.innerText="已结束",buyButton.href=closestNode.dataset.href,closestNode.querySelector(".bottom .right").style.display="none"}function start_buy(relatedObj){relatedObj.classList.remove("unbegin"),relatedObj.classList.add("begin");var buyButton=relatedObj.querySelector(".btn");buyButton.innerText="马上抢",buyButton.href=relatedObj.dataset.href;var endTime=relatedObj.dataset.end;relatedObj.querySelector(".bottom .right").innerHTML='还剩：<span class="countdown" data-end = "'+endTime+'"></span>';var newCountDown=relatedObj.querySelector(".countdown");initializeClock(newCountDown,newCountDown.dataset.end),clearInterval(relatedObj.timer),relatedObj.querySelector(".purchase_tip").innerHTML="已抢0件"}function getClosestParent(relatedObj,closestStr){for(var parentNode=null;null!=(parentNode=relatedObj.parentNode);){if(parentNode.tagName===closestStr.toUpperCase())return parentNode;relatedObj=relatedObj.parentNode}}init();