var vzan;
if (!vzan) {
	vzan = {}
}
(function(v) {
	var voice = {
		localId : "",
		serverId : ""
	};
	var timer;
	var recsecond = 0;
	v.voice_record_state = 0;
	v.playState = 0;
	v.canclerecord = function() {
		wx.stopRecord({
			success : function(res) {
			}
		});
		clearInterval(timer);
		recsecond = 0;
		v.resetrecord()
	};
	v.sumsecond = function() {
		recsecond += 1
	};
	v.showPlayUI = function(vstatus) {
		if (vstatus == 1) {
			v.voice_record_state = vstatus;
			$(".voice-record-volume-bg-p-span").addClass("voice-recording");
			$(".voice-record-bt-white-i").addClass(
					"voice-record-bt-whitei-recording");
			$(".voice-record-bt-white").addClass(
					"voice-record-bt-white-recording");
			$("#press-msg-tips").text("松开结束");
			$("#click-msg-tips").text("点击结束");
			$("#slide-btn-group").hide();
			$(".voice-record-button-local").hide()
		} else {
			if (vstatus == 2) {
			} else {
				if (vstatus == 3) {
				} else {
					v.voice_record_state = vstatus;
					$(".voice-record-volume-bg-p-span").removeClass(
							"voice-recording");
					$(".voice-record-bt-white-i").removeClass(
							"voice-record-bt-whitei-recording");
					$(".voice-record-bt-white").removeClass(
							"voice-record-bt-white-recording");
					$("#press-msg-tips").text("按住录音");
					$("#click-msg-tips").text("点一下录音");
					$("#slide-btn-group").show()
				}
			}
		}
	};
	v.startrecord = function() {
		wx.stopRecord();
		timer = setInterval("vzan.sumsecond()", 1000);
		wx.startRecord({
			success : function() {
				wx.onVoiceRecordEnd({
					complete : function(res) {
						clearInterval(timer);
						voice.localId = res.localId;
						$("#hidrecordTime").val(recsecond);
						$("#voice-time-show").html(recsecond + '"');
						voice.localId = res.localId;
						recsecond = 0;
						v.showPlayUI(2);
						v.completevoic()
					}
				});
				v.showPlayUI(1)
			},
			cancel : function() {
				clearInterval(timer);
				recsecond = 0
			},
			fail : function(res) {
				$(".temp-location-btn span").text("点击发送位置");
				layer.open({
					content : "启动录音失败",
					btn : [ "好的", "取消" ],
					shadeClose : false,
					yes : function() {
						layer.closeAll()
					},
					no : function() {
						layer.closeAll()
					}
				})
			}
		})
	};
	v.stoprecord = function() {
		if (recsecond <= 1) {
			setTimeout("vzan.wxstop()", 500)
		} else {
			setTimeout("vzan.wxstop()", 100)
		}
	};
	v.wxstop = function() {
		wx.stopRecord({
			success : function(res) {
				clearInterval(timer);
				if (recsecond < 2) {
					recsecond = 0;
					$("#hidrecordTime").val("0");
					v.showPlayUI(0);
					Popup(0, "太短了，多说几句吧");
					return
				}
				$("#hidrecordTime").val(recsecond);
				$("#voice-time-show").html(recsecond + '"');
				voice.localId = res.localId;
				recsecond = 0;
				v.showPlayUI(0);
				v.completevoic()
			}
		})
	};
	v.completevoic = function() {
		v.uploadrecord(voice.localId)
	};
	v.uploadrecord = function(locrecid) {
		var voicetype = $("#voicetype").val();
		var layer_wait_win = layer.open({
			type : 2,
			content : "上传中，请稍等..."
		});
		wx.uploadVoice({
			localId : locrecid,
			isShowProgressTips : 0,
			success : function(res) {
				voice.serverId = res.serverId;
				$("#hidrecordSerId").val(res.serverId);
				var recTime = $("#hidrecordTime").val();
				$.ajax({
					type : "post",
					url : "/t/uploadRecord-" + $("#hidfId").val(),
					data : {
						mediaId : res.serverId,
						recordTime : recTime,
						recordText : $("#hidrecordText").val(),
						upfrom : voicetype
					},
					dataType : "JSON",
					success : function(data) {
						layer.close(layer_wait_win);
						if (data.code == 1) {
							$("#hidrecordId").val(data.msg);
							var vhtml = $("#VoicePostOne_Tmp").html().replace(
									"{LOCALID}", locrecid).replace("{TIME}",
									recTime + '"').replace("{MP3PATH}", "")
									.replace("{TYPE}", "VOICE");
							$("#reclist").html(vhtml);
							layer.closeAll()
						} else {
							$("#hidrecordId").val("");
							Popup(0, "出错啦,重新录音试试")
						}
					},
					error : function() {
						alert("error")
					}
				})
			}
		})
	};
	v.resetrecord = function() {
		$("#voice-text-show").html("");
		$("#hidrecordId").val("");
		$("#hidrecordSerId").val("");
		$("#hidrecordTime").val("0");
		$("#hidrecordText").val("");
		v.showPlayUI(0)
	};
	v.playLocal = function() {
		wx.playVoice({
			localId : voice.localId,
			success : function(res) {
				v.showPlayUI(3);
				wx.onVoicePlayEnd({
					success : function(res) {
						v.playState = 0;
						vzan.showPlayUI(2)
					}
				})
			}
		})
	};
	v.stopLocal = function() {
		wx.pauseVoice({
			localId : voice.localId,
			success : function(res) {
				v.showPlayUI(2)
			}
		})
	}
})(vzan);
$(document)
		.ready(
				function() {
					$(document).on("touchstart", "#voice-start-button",
							function(e) {
								e.preventDefault();
								vzan.startrecord()
							}).on("touchend touchcancel",
							"#voice-start-button", function(e) {
								e.preventDefault();
								vzan.stoprecord()
							}).on("click", "#voice-start-button-click",
							function(e) {
								e.preventDefault();
								if (vzan.voice_record_state == 0) {
									vzan.startrecord()
								} else {
									vzan.stoprecord()
								}
							});
					$(document).on("click", "#voice-end-play", function(e) {
						e.stopPropagation();
						if (vzan.playState == 0) {
							vzan.playState = 1;
							vzan.playLocal()
						} else {
							vzan.playState = 0;
							vzan.stopLocal()
						}
					});
					$(document).on("click", "#voice-record-button",
							function(e) {
								e.stopPropagation();
								vzan.showPlayUI(0)
							});
					$(document).on("click", "#voice-complete-button",
							function(e) {
								e.stopPropagation();
								vzan.completevoic()
							});
					$(document).on("click", "#voice-record-button",
							function(e) {
								e.stopPropagation();
								vzan.resetrecord()
							});
					$(document).on("click", ".voicex", function(e) {
						e.stopPropagation();
						$("#hidrecordId").val("");
						$("#hidrecordSerId").val("");
						$("#hidrecordTime").val("0");
						$(this).parent().parent().remove()
					});
					$(document)
							.on(
									"click",
									".icon-post-voice",
									function(e) {
										var html = $("#VoiceTemplatePost").html();
										wx.startRecord({
													success : function() {
														wx.stopRecord();
														layer.open({
																	shadeClose : false,
																	type : 1,
																	content : html,
																	className : "voice-record-bg",
																	style : "position:fixed;left:0;bottom:0;padding-top:0;height:300px;",
																	end : function() {
																	},
																	success : function() {
																		$("#actionsheet_cancel").click(
																						function() {
																							wx.stopRecord({
																										success : function(res) {
																										}
																									});
																							$("#hidrecordId").val("");
																							$("#hidrecordSerId").val("");
																							$("#hidrecordTime").val("0");
																							$("#hidrecordText").val("");
																							vzan.showPlayUI(0);
																							layer.closeAll()
																						});
																		$(".voice-record-button-local")
																				.click(function(e) {
																							$("#VideoOrMusic")
																									.val("voice");
																							$("#fileUp").click();
																							e.stopPropagation
																						});
																		vzan.showPlayUI(0);
																		if ((vzanBrowser.versions.iPhone || vzanBrowser.versions.iPad)) {
																			$(".voice-record-button-local").hide()
																		} else {
																			$(".voice-record-button-local").show()
																		}
																		$("#slide-to-click").click(
																						function(e) {
																							$("#press-model-tips").hide();
																							$("#slide-to-press").show();
																							$("#voice-press-box").hide();
																							$("#voice-click-box").show();
																							$(this).hide();
																							e.stopPropagation
																						});
																		$("#slide-to-press").click(
																						function(e) {
																							$("#press-model-tips").show();
																							$("#slide-to-click").show();
																							$("#voice-press-box").show();
																							$("#voice-click-box").hide();
																							$(this).hide();
																							e.stopPropagation
																						})
																	}
																})
													}
												})
									})
				});