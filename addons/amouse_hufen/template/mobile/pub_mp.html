<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>{if $set['copyright']}{$set['copyright']}{else}{$_W['account']['name']}{/if}</title>
    <link rel="stylesheet" href="{AMOUSE_HUFEN_RES}css/foundation.css">
    <link rel="stylesheet" href="{AMOUSE_HUFEN_RES}css/main.a85c39c492c5.css">
    <link rel="stylesheet" href="{AMOUSE_HUFEN_RES}css/upload.ebe5da1f2569.css">
    <meta class="foundation-data-attribute-namespace">
    <meta class="foundation-mq-xxlarge">
    <meta class="foundation-mq-xlarge-only">
    <meta class="foundation-mq-xlarge">
    <meta class="foundation-mq-large-only">
    <meta class="foundation-mq-large">
    <meta class="foundation-mq-medium-only">
    <meta class="foundation-mq-medium">
    <meta class="foundation-mq-small-only">
    <meta class="foundation-mq-small">
    <meta class="foundation-mq-topbar">

    {php echo register_jssdk(false);}
</head>
<body>
<div class="wrapper">

    <div class="content">
        <div class="dialog" id="tip">
            <div class="dialog-cnt">
                <div class="dialog-bd">
                    <h3>提示</h3>
                    <p class="text"></p>
                    <a class="button correct-btn" id="alert_ok">确&nbsp;&nbsp;定</a>
                </div>
            </div>
        </div>


        <div class="upload">
            <form method="post" id="gform" enctype="multipart/form-data">
                <input type="hidden" value="{$fans['openid']}" id="userid">
                <input type="hidden" value="{$mp['id']}" id="mpid">
                <div class="cnt-box">
                    <div class="row">
                        <div class="small-12 columns">
                            <label>公众号名称
                                <input id="id_name" maxlength="30" name="name" type="text" value="{$mp['title']}" >
                            </label>
                        </div>
                    </div>

                    <div class="row">
                        <div class="small-12 columns">
                            <label>公众号头像
                            </label>
                            <div class="face2">
                                <div class="qrcode-img">
                                    <img id="imghead2" src="{if $mp['avater']}{$mp['avater']}{else}{AMOUSE_HUFEN_RES}images/initial.1d7139d9a611.jpg{/if}"
                                         style="height: auto;" >
                                </div>
                            </div>
                            <div style="display:none;">
                                <div style="word-break: break-all; font-size:12px;">
                                    <input type='hidden' id='qrcode2' name='qrcode2' value="{$mp['avater']}"/>
                                </div>
                            </div>
                            <div style="color:red;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="small-12 columns">
                            <label>公众号二维码
                            </label>
                            <div class="face">
                                <div class="qrcode-img">
                                    <img id="imghead" src="{if $mp['qrcode']}{$mp['qrcode']}{else}{AMOUSE_HUFEN_RES}images/initial.1d7139d9a611.jpg{/if}" style="height: auto;" >
                                </div>
                            </div>
                            <div style="display:none;">
                                <div style="word-break: break-all; font-size:12px;">
                                    <input type='hidden' id='qrcode' name='qrcode' value="{$mp['qrcode']}"/>
                                </div>
                            </div>
                            <div style="color:red;"></div>
                        </div>
                    </div>
                </div>


                <div class="cnt-box second-type">
                    <div class="row">
                        <div class="small-12 columns">
                            <label>选择所属类别
                                <select class="classify" id="id_category" name="category">
                                    <option value="" selected="selected">---------</option>
                                    {loop $cates $cate}
                                    <option value="{$cate['id']}" {if $cate['id']==$mp['pcateid']}selected{/if}>{$cate['name']}</option>
                                    {/loop}
                                </select>
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="small-12 columns">
                            <label>选择所在地区
                            </label>

                            <div id="div_region">
                                <select id="id_create_province" name="create_province">
                                    <option value="" data-code="">---- 选择省 ----</option>
                                    <option value="北京" data-code="110000">北京</option>
                                    <option value="天津" data-code="120000">天津</option>
                                    <option value="河北省" data-code="130000">河北省</option>
                                    <option value="山西省" data-code="140000">山西省</option>
                                    <option value="内蒙古自治区" data-code="150000">内蒙古自治区</option>
                                    <option value="辽宁省" data-code="210000">辽宁省</option>
                                    <option value="吉林省" data-code="220000">吉林省</option>
                                    <option value="黑龙江省" data-code="230000">黑龙江省</option>
                                    <option value="上海" data-code="310000">上海</option>
                                    <option value="江苏省" data-code="320000">江苏省</option>
                                    <option value="浙江省" data-code="330000">浙江省</option>
                                    <option value="安徽省" data-code="340000">安徽省</option>
                                    <option value="福建省" data-code="350000">福建省</option>
                                    <option value="江西省" data-code="360000">江西省</option>
                                    <option value="山东省" data-code="370000">山东省</option>
                                    <option value="河南省" data-code="410000">河南省</option>
                                    <option value="湖北省" data-code="420000">湖北省</option>
                                    <option value="湖南省" data-code="430000">湖南省</option>
                                    <option value="广东省" data-code="440000">广东省</option>
                                    <option value="广西壮族自治区" data-code="450000">广西壮族自治区</option>
                                    <option value="海南省" data-code="460000">海南省</option>
                                    <option value="重庆" data-code="500000">重庆</option>
                                    <option value="四川省" data-code="510000">四川省</option>
                                    <option value="贵州省" data-code="520000">贵州省</option>
                                    <option value="云南省" data-code="530000">云南省</option>
                                    <option value="西藏自治区" data-code="540000">西藏自治区</option>
                                    <option value="陕西省" data-code="610000">陕西省</option>
                                    <option value="甘肃省" data-code="620000">甘肃省</option>
                                    <option value="青海省" data-code="630000">青海省</option>
                                    <option value="宁夏回族自治区" data-code="640000">宁夏回族自治区</option>
                                    <option value="新疆维吾尔自治区" data-code="650000">新疆维吾尔自治区</option>
                                    <option value="台湾省" data-code="710000">台湾省</option>
                                    <option value="香港特别行政区" data-code="810000">香港特别行政区</option>
                                    <option value="澳门特别行政区" data-code="820000">澳门特别行政区</option>
                                    <option value="海外" data-code="990000">海外</option>
                                </select>
                                <select id="id_create_location" name="create_location">
                                    <option value="" data-code="">---- 选择市 ----</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="small-12 medium-8 columns">
                            <label>公众号描述
                                <textarea cols="40" id="id_description" name="description" rows="10">{$mp['desc']}</textarea>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="small-12 columns publish">
                        <a class="button btn btn-publish" href="javascript:void(0)" id="ajaxSave"> 保存并发布</a>
                    </div>
                </div>
            </form>
        </div>


    </div>

    {template 'footerbar'}

</div>

<script src="{AMOUSE_HUFEN_RES}js/jquery-2.1.3.min.js"></script>
<script src="{AMOUSE_HUFEN_RES}js/foundation.min.dea49fb77ce9.js"></script>

<script src="{AMOUSE_HUFEN_RES}js/main.04f12e56ea6a.js"></script>-->
<script>

    alert_ok = null;
    function new_alert(msg, cb) {
        alert_ok = cb;
        $('#tip .text').html(msg);
        $('#tip').show();
    }
    old_alert = window.alert;
    window.alert = new_alert;
    $('#alert_ok').click(function () {
        if (alert_ok) {
            alert_ok();
        }
        $('#tip').hide();
    });
</script>

<script src="{AMOUSE_HUFEN_RES}js/distpicker.data.min.a8276dac4366.js"></script>
<script src="{AMOUSE_HUFEN_RES}js/distpicker.min.ad9fc6eb4bb4.js"></script>
<script>

    $('#div_region').distpicker({
        province: "{if $mp['location_p']}{$mp['location_p']}{else}---- 选择省 ----{/if}",
        city: "{if $mp['location_c']}{$mp['location_c']}{else}---- 选择市 ----{/if}",
        autoSelect: false,
    });


    var localIds =  [];
    $('.face').click(function () {
        wx.chooseImage({
            count: 1,
            success: function (res) {
                localIds = res.localIds;
                onImageDone();
            }
        });
    });
    var localIds2 =  [];
    $('.face2').click(function () {
        wx.chooseImage({
            count: 1,
            success: function (res) {
                localIds2 = res.localIds;
                onImageDone2();
            }
        });
    });

    function onImageDone(){
        if (localIds.length == 0) {
            alert('请先使用 chooseImage 接口选择图片');
            return;
        }
        for(var k in localIds){
            var localId = localIds[k];
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1, // 默认为1，显示进度提示
                success: function (res) {
                    $('#imghead').attr('src',localId);
                    $('#qrcode').attr('value',res.serverId);
                }
            });
        }
    }
    function onImageDone2(){
        if (localIds2.length == 0) {
            alert('请先使用 chooseImage 接口选择图片');
            return;
        }
        for(var k in localIds2){
            var localId = localIds2[k];
            wx.uploadImage({
                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                isShowProgressTips: 1, // 默认为1，显示进度提示
                success: function (res) {
                    $('#imghead2').attr('src',localId);
                    $('#qrcode2').attr('value',res.serverId);
                }
            });
        }
    }

    $('#ajaxSave').click(function(){

        if($('#id_name').val() == ''){
            alert('请设置名称。');
            return false;
        }
        if($('#id_category').val() == ''){
            alert('请设置分类。');
            return false;
        }
        if($('#id_create_province').val() == ''){
            alert('请设置省份。');
            return false;
        }
        if($('#id_create_location').val() == ''){
            alert('请设置城市。');
            return false;
        }
        if($('#id_description').val().length > 500){
            alert('描述不能超过500字。');
            return false;
        }

        if($('#qrcode').val() == ''){
            alert('请必须上传公众号二维码。');
            return false;
        }
        var mpid=$('#mpid').val();
        /* var $btn = $("#ajaxSave");
         var $form = $("#gform");
         if($btn.hasClass("disabled")) return;*/

        var url = "{php echo $this->createMobileUrl('ajaxmp')}";
        var options = {
            title: $("#id_name").val(),
            qrcode: $("#qrcode").val(),
            avater: $("#qrcode2").val(),
            pcateid: $('#id_category').val() ,
            location_p: $('#id_create_province').val() ,
            location_c: $('#id_create_location').val(),
            type:'2',mpid:mpid,
            userid:$('#userid').val(),
            desc: $("#id_description").val()
        };
        $.ajax({
            type : "POST",
            url : url,
            data : options,
            dataType : "json",
            contentType: "application/x-www-form-urlencoded; charset=utf-8",
            success : function(data){
                console.log(data);
                if(data && data.code==200){
                    window.location.href="{php echo $this->createMobileUrl('board',array('openid'=>$openid),true)}";
                }else{
                    alert('网络出错');
                }
            },
            error : function(data){
                alert('网络出错');
            }
        });


    });

</script>



{template 'cnzz'}


</body>
</html>