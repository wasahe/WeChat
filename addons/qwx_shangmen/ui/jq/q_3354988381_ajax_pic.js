$.weui={};$.weui.alert=function(options){options=$.extend({title:'警告',text:'警告内容'},options);var $alert=$('.weui_dialog_alert');$alert.find('.weui_dialog_title').text(options.title);$alert.find('.weui_dialog_bd').text(options.text);$alert.on('touchend click','.weui_btn_dialog',function(){$alert.hide()});$alert.show()};$(function(){var allowTypes=['image/jpg','image/jpeg','image/png','image/gif'];var maxSize=1024*1024;var maxWidth=300;var maxCount=1;$('.js_file').on('change',function(event){var files=event.target.files;if(files.length===0){return}for(var i=0,len=files.length;i<len;i++){var file=files[i];var reader=new FileReader();if(allowTypes.indexOf(file.type)===-1){$.weui.alert({text:'该类型不允许上传'});continue}if(file.size>maxSize){$.weui.alert({text:'图片太大，不允许上传'});continue}if($('.weui_uploader_file').length>=maxCount){$.weui.alert({text:'最多只能上传'+maxCount+'张图片'});return}reader.onload=function(e){$.post(widgets_ajax_pic_host,{img:e.target.result},function(ret){if(ret.img!=''){$('.weui_uploader_input_wrp').hide()}else{alert('upload fail');return}},'json');var img=new Image();img.onload=function(){var w=Math.min(maxWidth,img.width);var h=img.height*(w/img.width);var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');canvas.width=w;canvas.height=h;ctx.drawImage(img,0,0,w,h);var base64=canvas.toDataURL('image/png');var $preview=$('<li class="weui_uploader_file weui_uploader_status" style="background-image:url('+base64+')"><div class="weui_uploader_status_content">0%</div><input type="hidden" value="1" name="ajax_pic_flag"></li>');$('.weui_uploader_files').append($preview);var num=$('.weui_uploader_file').length;$('.js_counter').text(num+'/'+maxCount);var progress=0;function uploading(){$preview.find('.weui_uploader_status_content').text(++progress+'%');if(progress<100){setTimeout(uploading,30)}else{$preview.removeClass('weui_uploader_status').find('.weui_uploader_status_content').remove()}}setTimeout(uploading,30)};img.src=e.target.result};reader.readAsDataURL(file)}})});