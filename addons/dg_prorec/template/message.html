{template 'common/header'}
<ul class="nav nav-tabs">
    <li {if $op == 'post' && empty($id)}class="active"{/if}><a href="{php echo $this->createWebUrl('message', array('op' => 'post'));}">添加文章</a>
    </li>
    <li {if $op == 'display'}class="active"{/if}><a href="{php echo $this->createWebUrl('message',array('op'=>'display'));}">管理文章</a>
    </li>
    {if !empty($id) && $op == 'post'}
    <li class="active">  <a href="{php echo $this->createWebUrl('message',array('op'=>'post','id'=>$id));}">编辑文章</a> </li> {/if}
</ul>
{if $op == 'display'}
<div class="panel panel-info">
    <div class="panel-heading">筛选</div>
    <div class="panel-body">
        <form action="./index.php" method="get" class="form-horizontal" role="form">
            <input type="hidden" name="c" value="site"/>
            <input type="hidden" name="a" value="entry"/>
            <input type="hidden" name="m" value="dg_prorec"/>
            <input type="hidden" name="do" value="message"/>
            <input type="hidden" name="op" value="display"/>
            <div class="form-group">
                <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">文章分类</label>
                <div class="col-sm-8">
                    <div class="col-md-9" style="padding-left:0;">
                        <select name="cate" class="form-control" <!--onchange="fuzhi(this.options[this.selectedIndex].text)-->">
                            <option value="" selected="selected" >选择分类</option>
                            {loop $category $row}
                            <option value="{$row['id']}" {if $row['id']== $item['cateid']}selected="selected"{/if}>{$row['name']}</option>
                            {/loop}
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 control-label">关键字</label>

                <div class="col-sm-8 ">
                    <div class="col-md-9" style="padding-left:0;">
                        <input class="form-control" name="keyword" id="" type="text" value="{$_GPC['keyword']}">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
                    </div>
                </div>
            </div>
<!--            <div class="form-group">
                <div class="pull-right col-xs-12 col-sm-2 col-md-2 col-lg-2">
                    <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
                </div>
            </div>-->
        </form>
    </div>
</div>
<form action="" method="post" onsubmit="return formcheck(this)">
    <div class="panel panel-default">
        <div class="table-responsive panel-body">
            <table class="table">
                <thead>
                <tr>
                    <th style="width:100%">标题</th>

                    <th style="text-align:right; width: 100%">操作</th>
                </tr>
                </thead>
                <tbody>
                {loop $list $item}
                <tr>
                    <td>
                        <span class="text-error">[{$item['catename']}]</span>
                        <a href="{php echo $this->createWebUrl('article', array('op' => 'post', 'id' => $item['id']))}"
                           style="color:#333;">{$item['title']}
                        </a>
                    </td>

                    <td style="text-align:right;">
                        <label style="cursor:pointer;" data="{$item[id]}" class="label label-default {if $item['status']==2}label-info{/if}" onclick="setUserStatus(this,'on');">{if $item['status']==2}已发送{else}发送{/if}</label>

                        <a href="{php echo $this->createWebUrl('message', array('op' => 'post', 'id' => $item['id']))}"
                           title="编辑" data-toggle="tooltip" data-placement="top" class="btn btn-default btn-sm"><i
                                class="fa fa-edit"></i>
                        </a>
                        <a onclick="return confirm('此操作不可恢复，确认吗？'); return false;"
                           href="{php echo $this->createWebUrl('message', array('op' => 'delete', 'id' => $item['id']))}"
                           title="删除" data-toggle="tooltip" data-placement="top" class="btn btn-default btn-sm"><i
                                class="fa fa-times"></i></a>
                    </td>
                </tr>
                {/loop}
<!--                <tr>
                    <td colspan="3">
                        <input name="submit" type="submit" class="btn btn-primary" value="批量更新排序">
                        <input type="hidden" name="token" value="{$_W['token']}" />
                    </td>
                </tr>-->
                </tbody>
            </table>
        </div>
    </div>
</form>
{$pager}
<script type="text/javascript">
    var category = {php echo json_encode($children)};
    require(['bootstrap'], function ($) {
        $('.btn').hover(function () {
            $(this).tooltip('show');
        }, function () {
            $(this).tooltip('hide');
        });
    });

    function setUserStatus(obj,op){
        var id=$(obj).attr('data');
        var url="{php echo $this->createWebUrl('message')}";
        if(!$(obj).hasClass('label-info')){
            if(confirm("确认发送,发送之后就不能再次发送了")){
                $.post(url,{id:id,op:op},function(result){
                    if(op=='on'){
                        if(result.res==1){
                            $(obj).addClass('label-info');
                            $(obj).empty();
                            $(obj).text("已发送");
                            location.reload();
                        }
                    }
                });
            }
        }
        if($(obj).hasClass('label-info')){
            alert('消息提醒已经发出了,不能重复发送');
        }
    }
</script>
{elseif $op == 'post'}
<div class="clearfix">
    <form class="form-horizontal form" action="" method="post" enctype="multipart/form-data">
        <div class="panel panel-default">
            <div class="panel-heading">产品介绍管理</div>
            <div class="panel-body">
                <input type="hidden" name="id" value="{$item[id]}">
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">访问地址</label>
                    <div class="col-sm-8">
                        <p class="form-control-static">
                            <a class="preview_url"
                               href="{php echo $_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$item[id]),true),2);}"
                               target="_blank">
                                {php echo $_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$item[id]),true),2);}
                            </a>
                        </p>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">文章分类</label>
                    <div class="col-sm-8">
                        <select name="cate" class="form-control" onchange="fuzhi(this.options[this.selectedIndex].text)">
                            <option value="" selected="selected" >选择分类</option>
                            {loop $category $row}
                            <option value="{$row['id']}" {if $row['id']== $item['cateid']}selected="selected"{/if}>{$row['name']}</option>
                            {/loop}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">文章标题</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" placeholder="" name="title" value="{$item['title']}">
                    </div>
                </div>
                <input type="hidden" name="catename" id="catename" value="{$item['catename']}"/>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">选择模板</label>
                    <div class="col-sm-8">
                        <div class="col-md-9" style="padding-left:0;">
                            <select name="template" class="form-control" id="template" onchange="getseltext(this);tempfuzhi(this.options[this.selectedIndex].text);"  {if $id>0} disabled="true" {/if}>
                                <option value="">选择要发送的模板</option>
                                {loop $templist $index $row}
                                <option value="{$index}" {if $row['tempid']==$protempid}selected="selected" {/if}>{$row['tempname']}</option>
                                {/loop}
                            </select>
                        </div>
                        {if $id>0&&$item['status']==1}
                        <div class="col-md-3">
                            <button type="button" class="btn btn-info" id="reset">重置模板</button>
                        </div>
                        {/if}
                    </div>
                </div>
                <input type="hidden" name="muban" id="muban" value="{$item['tempid']}"/>
                <div id="pro">
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">跳转链接</label>
                    <div class="col-sm-8">
                        <input type="text" class="form-control" placeholder="" name="url" value="{$item['url']}">
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-4 col-md-3 col-lg-2 control-label">简介</label>
                    <div class="col-sm-8">
                        {php echo tpl_ueditor('content', $item['content']);}
                    </div>
                </div>

                <div class="form-group">
                    <div class="col-sm-12">
                        <input name="submit" type="submit" value="提交" class="btn btn-primary col-lg-1">
                        <input type="hidden" name="token" value="{$_W['token']}"/>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript">
    function fuzhi(a){
        $("#catename").val(a);
    }
    function tempfuzhi(a){
        $("#muban").val(a);
    }
    function getseltext(obj){
        var  tet=$(obj).find("option:selected").val();
        var url="{php echo $this->createweburl('tplall')}";
        $.post(url,{'tet':tet},function(res){
            $("#pro").empty();
            $("#pro").append(res);
        })
    }
    $("#reset").click(function(){
        $("#template").removeAttr("disabled");
    })

</script>

{/if}