{template 'web/common/header-base'}
{template 'web/common/header-nav'}
{template 'web/common/header'}


  <div class="grzxOuterBox hidden ng-scope"  style="display: block;">
    <div class="zhifuOuterBox">
      <div class="mainIn02Box">
          <div class="zhifuInnerBox">
            <div class="zhifuCBox">
              <div class="ui-view-container">
                <div class="animate-slide " style="min-height: 400px; position: relative;">

                        <div class="slide-container" id="paybox1">

                           {if $type=='self'}
                            <div class="tjddCont ng-scope" ng-animate-children="" ng-if="!loading">

                                <div class="tjdd_list">
                                    <div class="tjdd_item animate-reward cur"  style="display: block;">
                                        <div ng-if="reward.itemType == 2" class="ng-scope">
                                            <div class="wyzz_h3">感谢您的支持</div>
                                            <p class="support_inforP">感谢您的支持，您将收到我们寄出的信件或贺卡，这份支持将助我们的梦想飞的更高更远。</p>
                                            <div class="wyzz_Cont" ng-show="reward.itemType == 2">
                                                <a href="javascript:;" class="wyzz_ItemA btn_ALink cur" data-money='1'>¥ 1</a>
                                                <a href="javascript:;" class="wyzz_ItemA btn_ALink " data-money='5'>¥ 5</a>
                                                <a href="javascript:;" class="wyzz_ItemA btn_ALink " data-money='10'>¥ 10</a>
                                                <div class="wyzz_inputBox sitePHBox" id="selfless-v-target">
                                                    <label>其他&nbsp;¥</label>
                                                    <input type="text" class="wyzz_input sitePHInput "  value="{$_GPC['money']}"  maxlength="8" >
                                                </div>
                                            </div>
                                        </div>
                                        <div ng-show="reward.itemType != 2" class="ng-hide">
                                            <div class="support_title " ng-bind="reward.title"></div>
                                            <p class="support_inforP " ng-bind="reward.repay">感谢您的无私奉献，这份支持将助我们的梦想飞的更高更远。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                                <div class="tjddCont " >
                                    <div class="tjdd_QHCont">
                                        <div class="wszc_QHBox ">
                                            <div class="tjdd_formItem clearfix">
                                                <div class="tjddQHFGBox sitePHBox">
                                                    <span>
                                                          <input type="text" class="tjdd_QHInput sitePHInput w440"  id="tel" placeholder="手机号（选填，发起人可通过此信息联系你）">
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div>
                                            <div class="shdzForm_xnBox">
                                                <p class="zj_valP ng-scope" >
                                                  支付<span><b>¥</b><span class="showmoney">{if $_GPC['money']}{$_GPC['money']}{else}1{/if}</span></span>
                                                </p>
                                                <input type="button"  value="提交订单" class="tjdd_submitBtn" id="tjdd_submitBtn">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <div style="clear:both"></div>

                            {else}
                              <div class="tjddCont">
                                  <div class="tjdd_list">
                                      <div class="tjdd_item animate-reward cur">
                                            <div>
                                                <h3 class="support_h3 ng-binding">
                                                   ￥{$reward['supportNumber']}
                                                </h3>
                                                <div class="support_title">
                                                   {$reward['title']}
                                                </div>
                                                <p class="support_inforP">
                                                  {$reward['supportContent']}
                                                </p>
                                            </div>
                                      </div>
                                  </div>

                                  <div class="tjdd_QHCont">
                                      <div class="NumBox">
                                         <span>份数</span>
                                          <div class="NumInner" id="num-input">
                                              <a  href="javascript:;" class="btn_ALink btn_jian"></a>
                                              <input type="text" max="100" value="1" id="shu">
                                              <a  href="javascript:;" class="next btn_ALink btn_add"></a>
                                          </div>
                                      </div>
                                      <div>
                                           <div class="shxx_h3">
                                               收货信息
                                           </div>
                                           <div class="shdzListBox">

                                             {if $address}
                                                   {loop $address $row}

                                                     <div class="shdzListItem checked clearfix" data-type='list'>
                                                        <i class="flag_i"></i>
                                                        <div class="shdzListItemLeft">
                                                          <p>
                                                              <span>{$row['province']}</span>
                                                              <span>{$row['city']}</span>
                                                              <span>{$row['address']}</span>
                                                          </p>
                                                          <p>
                                                             <span>手机</span>
                                                             <span>{$row['tel']}</span>
                                                          </p>
                                                        </div>
                                                     </div>

                                                   {/loop}

                                                   <div class="shdzListItem clearfix" data-type='new'>
                                                     <i class="flag_i"></i>
                                                     使用新地址
                                                   </div>

                                               {else}

                                               <div class="shdzListItem clearfix checked" data-type='new'>
                                                 <i class="flag_i"></i>
                                                 使用新地址
                                               </div>
                                               {/if}
                                           </div>
                                           <div class="shdzForm_swBox animate-reward">

                                             <div  {if $address}style="display:none"{/if}>
                                               <div class="tjdd_formItem clearfix ">
                                                  <div class="tjddQHFGBox pull-left sitePHBox" holder="">
                                                      <span>
                                                          <input type="text"  class="tjdd_QHInput sitePHInput w200 " placeholder="姓名" id="name">

                                                      </span>
                                                  </div>

                                                <div class="tjddQHFGBox pull-right sitePHBox" holder="">
                                                  <span>
                                                      <input type="text" ng-model="address.telephone" class="tjdd_QHInput sitePHInput w200 " placeholder="手机号" id="tel">

                                                  </span>
                                                </div>
                                                 </div>

                                                 <script src='{GARCIA_JS}PCASClass.js'></script>

                                                <div class="tjdd_formItem clearfix">
                                                    <div class="tjddSelectBox pull-left">
                                                        <select name="province" id="province">
                                                              <option value="0">请选择</option>
                                                        </select>
                                                    </div>
                                                    <div class="tjddSelectBox pull-right">
                                                        <select name="city" id="city">
                                                          <option value="0">请选择</option>
                                                        </select>
                                                    </div>
                                                    <select id="area" name="area" style="display:none;"></select>
                                                </div>

                                                <script>
                                                    var pcas = new PCAS("province,省 必选","city,市 必选");
                                                </script>
                                                <div class="tjdd_formItem">
                                                    <div class="tjddQHFGBox sitePHBox">
                                                      <span>
                                                          <input type="text" class="tjdd_QHInput sitePHInput w440" placeholder="详细地址" id="address">

                                                      </span>
                                                    </div>
                                                </div>
      </div>
                                                <div>
                                                <div class="shdzForm_xnBox">
                                                      <div class="tjdd_formItem"  style="margin-top:20px;">
                                                          <div class="tjddQHFGBox sitePHBox" holder="">
                                                              <span>
                                                                  <input  type="text" class="tjdd_QHInput sitePHInput w440 " placeholder="备注（选填，关于订单的特殊要求等）">

                                                            </span>
                                                          </div>
                                                      </div>
                                                      <p class="zj_valP ">支付<span><b>¥</b><span id="jiaqian" data-default="{$reward['supportNumber']}">{$reward['supportNumber']}</span></span></p>
                                                      <input type="button" value="提交订单" class="tjdd_submitBtn" id="tjdd_submitBtn2">
                                                      <input type="hidden" id="price">
                                                      <input type="hidden" id="reid" value="{$_GPC['id']}">
                                                      <input type="hidden" id="address_id" value="">
                                              </div>


                                           </div>

                                  </div>

                              </div>
                            {/if}
                        </div>


                        <div class="qrcode-view" id="paybox2">
                            <div class="clearfix">
                                <div class="con">
                                    <h2>请使用微信扫描二维码进行支付</h2>
                                    <div >
                                      <img src="" id="qrcodesrc" width="325" height="325">
                                    </div>
                                    <div class="solid"></div>
                                    <p class="wfirst">总计金额：<span id="totalm"></span></p>
                                    <p class="w325">订&nbsp;&nbsp;单&nbsp;&nbsp;号：<span id="orderid"></span></p>
                                    <p class="w325">下单日期：<span id="ordertime"></span></p>
                                </div>
                            </div>
                        </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(".wyzz_ItemA").bind('click',function(){
       var money = $(this).attr('data-money');
       $(".wyzz_ItemA").each(function(){
           $(this).removeClass('cur');
       });
       $(this).addClass('cur');
       $(".showmoney").html(money);
       console.log(money);
    });
    $(".wyzz_input").bind('input propertychange',function(){
        var money  = $(this).val();
        if(!$.isNumeric(money)){
          _tips('请输入数字');
          $(".wyzz_input").val('');
          return false;
        }
        $(".showmoney").html(money);
        console.log(money);
    });
    $("#tjdd_submitBtn").bind('click',function(){
        var money = $(".showmoney").html();
        var tel = $("#tel").val();
        var reg = /^1[3|4|5|8]\d{9}$/;
        if(!$.isNumeric(money)){
          _tips('请输入数字');
          $(".wyzz_input").val('');
          return false;
        }
        // money = parseInt(money);
        if(money<=0){
          _tips('请输入支持金额并且大于0');
          $(".wyzz_input").val('');
          return false;
        }
        if(tel.trim()==''){
          //  _tips('请输入联系人手机号码');
          //  return false;
        }
        if(!reg.test(tel)){
          // _tips('请输入正确的手机号码');
          // return false;
        }


        // console.log(money);
        _getOrder(money,{$_GPC['fid']});
    });

    $("#tjdd_submitBtn2").bind('click',function(){
         var jiaqian = $("#jiaqian").html();
         var type = $(".shdzListBox").find('.shdzListItem.checked').attr('data-type');
         if(type=='new'){
                  _addAddress();
         }
         console.log(type);
        //  _getOrder(jiaqian,{$_GPC['fid']});
    })
    $(".btn_jian").bind('click',function(){
        var shu = $("#shu").val();
            shu = parseInt(shu);
            shu = shu -1;
            if(shu<=0){
               shu = 1;
               _tips('不能少于1');
            }
          $("#shu").val(shu);
            _price(shu);
    });
    $(".btn_add").bind('click',function(){
        var shu = $("#shu").val();
            shu = parseInt(shu);
            shu = shu +1;
            if(shu<=0){
               shu = 1;
               _tips('不能少于1');
            }

          $("#shu").val(shu);
            _price(shu);
    });

    $("#shu").bind('input propertychange',function(){
        var shu = $("#shu").val();
        if(!$.isNumeric(shu)){
          shu = 1;
            $("#shu").val(shu);
          _tips('请输入数字');
           return false;
        }
            shu = parseInt(shu);
            if(shu<=0){
               shu = 1;
                 $("#shu").val(shu);
                         _price(shu);
               _tips('不能少于1');
               return false;
            }
        _price(shu);
    });


    function _addAddress(){
        var name = $("#name").val();
        var tel = $("#tel").val();
        var province = $("#province").val();
        var city = $("#city").val();
        var address = $("#address").val();
        var address_id = $("#address_id");
       var reg = /^1[3|4|5|8]\d{9}$/;
        if($.trim(name)==''){
            _tips('请输入名字');
            return false;
        }
        if($.trim(tel)==''){
            _tips('请输入电话');
            return false;
        }
        if(!reg.test(tel)){
          _tips('电话号码不正确');
          return false;
        }
        if($.trim(province)==''){
            _tips('请选择省份');
            return false;
        }
        if($.trim(city)==''){
            _tips('请选择城市');
            return false;
        }
        if($.trim(address)==''){
            _tips('请输入详细地址');
            return false;
        }
        $.ajax({
           url:base_url,
           type:"post",
           dataType:'json',
           data:{
             func:'address',
             action:'add_address',
             mid:{php echo $this->conf['user']['mid']},
             name:name,
             tel:tel,
             province:province,
             city:city,
             address:address,
             apikey:apikey
           },success:function(res){
              console.log(jts(res));
           }
         })
    }
    function _getOrder(m,fid){

      var qrcodesrc = $("#qrcodesrc");
      var totalm = $("#totalm");
      var orderid = $("#orderid");
      var ordertime = $("#ordertime");
      {if $type=='reward'}
        var reid = $("#reid");
      {/if}

      $.ajax({
         url:base_url,
         type:"post",
         dataType:'json',
         data:{
           func:'pay',
           action:'getorder',
           fid:fid,
           fee:m,
           mid:{php echo $this->conf['user']['mid']},
           apikey:apikey
         },success:function(msg){
            // console.log(jts(msg));
            data = msg.msg;
            // _tips(msg.msg);
            if(msg.status_code==1){
              $("#paybox1").fadeOut(500,function(){
                  qrcodesrc.attr('src',data.img);
                  totalm.html('￥'+data.fee);
                  orderid.html(data.tid);
                  ordertime.html(data.time);
                  $("#paybox2").fadeIn();
                  setInterval(function(){
                    $.ajax({
                      url:base_url,
                      type:"post",
                      dataType:'json',
                      data:{
                        func:'pay',
                        action:'getstatus',
                        tid:data.tid,

                        apikey:apikey
                      },success:function(res){
                          console.log(jts(res));
                          if(res.res==1){
                             $(".w325").html('');
                             $(".wfirst").html('<span style="color:green">支付成功,准备跳转</span>');
                              setTimeout(function(){
                                window.location.href="{php echo  $_W['siteroot'].'app/'.substr($this->createMobileUrl('detail',array('id'=>$_GPC['fid'])),2)}";
                              },1200);
                          }
                      }
                    })
                  },1000);
              });
            }
         },error:function(msg){
            console.log('bad');
         }
      });
      // console.log({php echo $this->conf['user']['mid']});

    }

    function _price(n){
       var jiaqian = $("#jiaqian").attr('data-default');
       price = n*jiaqian;
       $("#jiaqian").html(price);
       $("#price").val(price);
       console.log(jiaqian);
    }
</script>
{template 'web/common/footer'}
