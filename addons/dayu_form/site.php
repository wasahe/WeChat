<?php 

defined('IN_IA') or exit('Access Denied'); define('TEMPLATE_PATH', '../addons/dayu_form/template/style/'); define('TEMPLATE_WEUI', '../addons/dayu_form/template/weui/'); class dayu_formModuleSite extends WeModuleSite { private $form_table = 'dayu_form'; private $data_table = 'dayu_form_data'; private $field_table = 'dayu_form_fields'; private $reply_table = 'dayu_form_reply'; private $info_table = 'dayu_form_info'; private $staff_table = 'dayu_form_staff'; private $custom_table = 'dayu_form_custom'; private $loc_table = 'dayu_form_loc'; public function getHomeTiles() { global $_W; $urls = array(); $list = pdo_fetchall("SELECT title, reid FROM " . tablename('dayu_form') . " WHERE weid = '{$_W['uniacid']}'"); if (!empty($list)) { foreach ($list as $row) { $urls[] = array('title' => $row['title'], 'url' => $_W['siteroot']."app/".$this->createMobileUrl('dayu_form', array('id' => $row['reid']))); } } return $urls; } public function doWebQuery() { global $_W, $_GPC; $kwd = $_GPC['keyword']; $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `title` LIKE :title ORDER BY reid DESC LIMIT 0,8'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':title'] = "%{$kwd}%"; $ds = pdo_fetchall($sql, $params); foreach ($ds as &$row) { $r = array(); $r['title'] = $row['title']; $r['description'] = cutstr(strip_tags($row['description']), 50); $r['thumb'] = $row['thumb']; $r['reid'] = $row['reid']; $row['entry'] = $r; } include $this->template('query'); } public function doWebStaff(){ global $_W,$_GPC; $op = trim($_GPC['op']) ? trim($_GPC['op']) : 'list'; $weid=$_W['uniacid']; $reid = intval($_GPC['reid']); $activity = pdo_fetch('SELECT reid,title,kfid FROM ' . tablename('dayu_form') . ' WHERE weid = :weid AND reid = :reid', array(':weid' => $weid, ':reid' => $reid)); if(empty($activity)) { message('表单不存在或已删除', $this->createWebUrl('display'), 'error'); } if($op == 'list') { $where = ' reid = :reid'; $params[':reid'] = $reid; if(!empty($_GPC['keyword'])) { $where .= " AND nickname LIKE '%{$_GPC['keyword']}%'"; } $pindex = max(1, intval($_GPC['page'])); $psize = 20; $total = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('dayu_form_staff') . ' WHERE ' . $where, $params); $lists = pdo_fetchall('SELECT * FROM ' . tablename('dayu_form_staff') . ' WHERE ' . $where . ' ORDER BY createtime DESC,id ASC LIMIT '.($pindex - 1) * $psize.','.$psize, $params, 'id'); $pager = pagination($total, $pindex, $psize); if(checksubmit('submit')) { if(!empty($_GPC['ids'])) { foreach($_GPC['ids'] as $k => $v) { $data = array( 'nickname' => trim($_GPC['nickname'][$k]), 'openid' => trim($_GPC['openid'][$k]), 'weid' => trim($_GPC['weid'][$k]), ); pdo_update('dayu_form_staff', $data, array('reid' => $reid, 'id' => intval($v))); } message('编辑成功', $this->createWebUrl('staff', array('op' => 'list', 'reid' => $reid)), 'success'); } } include $this->template('staff'); } elseif($op == 'post') { if(checksubmit('submit')) { if(!empty($_GPC['nickname'])) { foreach($_GPC['nickname'] as $k => $v) { $v = trim($v); if(empty($v)) continue; $data['reid'] = $reid; $data['nickname'] = $v; $data['nickname'] = $_GPC['nickname'][$k]; $data['openid'] = $_GPC['openid'][$k]; $data['weid'] = $_GPC['weid'][$k]; $data['createtime'] = time(); pdo_insert('dayu_form_staff', $data); } } message('添加客服成功', $this->createWebUrl('staff', array('reid' => $reid, 'op' => 'list')), 'success'); } include $this->template('staff'); } elseif ($op == 'staffdel') { $id = intval($_GPC['id']); if (!empty($id)) { pdo_delete('dayu_form_staff', array('id' => $id)); } message('删除成功.', referer()); } } public function doWebchangecheckedAjax(){ global $_W, $_GPC; $id = $_GPC['id']; $kfid = $_GPC['kfid']; if(false !== pdo_update('dayu_form', array('kfid' => $kfid), array('reid' => intval($id), 'weid' => $_W['uniacid']))){ exit('1'); }else{ exit('0'); } } public function doWebEditkf(){ global $_W,$_GPC; if($_GPC['dopost']=="update"){ $reid = $_GPC['reid']; $nickname = $_GPC['nickname']; $openid = $_GPC['openid']; if(is_array($reid)){ foreach ($reid as $k => $v) { $actid = $v.","; } } $actid = substr($actid, 0,strlen($actid)-1); $a = pdo_update('dayu_form_staff',array('reid' =>$actid,'nickname'=>$nickname,'openid'=>$openid),array('id'=>$_GPC['id'])); message("更改成功!", referer()); exit; } $fff = pdo_fetchall("SELECT reid,title FROM ".tablename('dayu_form')); $config = pdo_fetch("SELECT * from ".tablename('dayu_form_staff')." where id=".$_GPC['id']); $fun = explode(',', $config['reid']); include $this->template('kf_edit'); } public function doWebDetail() { global $_W, $_GPC; $settings = $this->module['config']; $rerid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form_info') . " WHERE `rerid`=:rerid"; $params = array(); $params[':rerid'] = $rerid; $row = pdo_fetch($sql, $params); if (empty($row)) { message('访问非法.'); } $row['thumb'] = iunserializer($row['thumb']); $row['voices'] = $settings['qiniu']['host'].'/'.$row['voice']; $row['revoices'] = $settings['qiniu']['host'].'/'.$row['revoice']; $row['file'] = iunserializer($row['file']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $row['reid']; $activity = pdo_fetch($sql, $params); if (empty($activity)) { message('非法访问.'); } $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY `refid`'; $params = array(); $params[':reid'] = $row['reid']; $fields = pdo_fetchall($sql, $params); if (empty($fields)) { message('非法访问.'); } $custom = pdo_fetchall("SELECT * FROM ".tablename($this->custom_table)." WHERE weid = :weid ORDER BY displayorder DESC", array(':weid' => $_W['uniacid'])); $ds = $fids = array(); foreach ($fields as $f) { $ds[$f['refid']]['fid'] = $f['title']; $ds[$f['refid']]['type'] = $f['type']; $ds[$f['refid']]['refid'] = $f['refid']; $fids[] = $f['refid']; } $fids = implode(',', $fids); $row['fields'] = array(); $sql = 'SELECT * FROM ' . tablename('dayu_form_data') . " WHERE `reid`=:reid AND `rerid`='{$row['rerid']}' AND `refid` IN ({$fids})"; $fdatas = pdo_fetchall($sql, $params); foreach ($fdatas as $fd) { $row['fields'][$fd['refid']] = $fd['data']; } foreach ($ds as $value) { if ($value['type'] == 'reside') { $row['fields'][$value['refid']] = ''; foreach ($fdatas as $fdata) { if ($fdata['refid'] == $value['refid']) { $row['fields'][$value['refid']] .= $fdata['data']; } } break; } } $record = array(); $record['status'] = intval($_GPC['status']); $record['yuyuetime'] = strtotime($_GPC['yuyuetime']); if ($activity['isrethumb']) { $record['rethumb'] = $_GPC['rethumb']; } $record['kfinfo'] = $_GPC['kfinfo']; if (!empty($_GPC['file'])) { foreach ($_GPC['file'] as $file) { $th[] = $file; } $record['file'] = iserializer($th); } $kfinfo = !empty($_GPC['kfinfo']) ? '（答复：'.$_GPC['kfinfo'].'）' : ''; if ($_GPC['status'] == '0') { $huifu=$activity['state1'].$kfinfo; }elseif ($_GPC['status'] == '1') { $huifu=$activity['state2'].$kfinfo; }elseif ($_GPC['status'] == '2') { $huifu=$activity['state4'].$kfinfo; }elseif ($_GPC['status'] == '3') { $huifu=$activity['state3'].$kfinfo; } $ytime = date('Y-m-d H:i:s', TIMESTAMP); $template =array( "touser"=>$row['openid'], "template_id"=>$activity['m_templateid'], "url"=>$_W['siteroot'] .'app/'.$this->createMobileUrl('mydayu_form', array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])), "topcolor"=>"#FF0000", "data"=>array('first'=>array('value'=>urlencode($activity['mfirst']), 'color'=>"#743A3A", ), 'keyword1'=>array('value'=>urlencode($row['member']), 'color'=>'#000000', ), 'keyword2'=>array('value'=>urlencode($row['mobile']), 'color'=>'#000000', ), 'keyword3'=>array('value'=>urlencode($_GPC['yuyuetime']), 'color'=>'#000000', ), 'keyword4'=>array('value'=>urlencode($huifu), 'color'=>"#FF0000", ), 'remark'=>array('value'=>urlencode("\\n".$activity['mfoot']), 'color'=>"#008000", ), ) ); if (checksubmit('submit') && $activity['custom_status'] == 1) { load()->model('mc'); $acc = notice_init(); if(is_error($acc)) { return error(-1, $acc['message']); } $url = $_W['siteroot'].'app/'.$this->createMobileUrl('mydayu_form', array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])); $info = "【您好，受理结果通知】\n\n"; $info .= "姓名：{$row['member']}\n手机：{$row['mobile']}\n受理结果：{$huifu}\n\n"; $info .= "<a href='{$url}'>点击查看详情</a>"; $custom = array( 'msgtype' => 'text', 'text' => array('content' => urlencode($info)), 'touser' => $row['openid'], ); $acc->sendCustomNotice($custom); pdo_update('dayu_form_info', $record,array('rerid' => $rerid)); message('修改成功',referer(),'success'); } $testfile=$_FILES['upfile']; if (checksubmit('submit') && $activity['custom_status'] == 0){ load()->func('communication'); $this->send_template_message(urldecode(json_encode($template))); pdo_update('dayu_form_info', $record,array('rerid' => $rerid)); message('修改成功',referer(),'success'); } $row['yuyuetime'] && $row['yuyuetime'] = date('Y-m-d H:i:s', $row['yuyuetime']); load()->func('file'); load()->func('tpl'); $title = "表单详情"; include $this->template('detail'); } public function doWebupfile() { global $_W, $_GPC; $max_file_size=2000000; $destination_folder="../attachment/dayu_form/".$_W['uniacid']."/file/"; if (!is_uploaded_file($_FILES["upfile"][tmp_name])){ echo 'nothing'; exit; } $file = $_FILES["upfile"]; if($max_file_size < $file["size"]){ echo 'size'; exit; } if(!file_exists($destination_folder)){ mkdir($destination_folder); } $filename=$file["tmp_name"]; $image_size = getimagesize($filename); $pinfo=pathinfo($file["name"]); $ftype=$pinfo['extension']; $destination = $destination_folder.time().".".$ftype; if (file_exists($destination) && $overwrite != true){ echo 'name'; exit; } if(!move_uploaded_file ($filename, $destination)){ echo 'move'; exit; } $pinfo=pathinfo($destination); $fname=$pinfo[basename]; echo $destination_folder.$fname; } public function doWebManage() { global $_W, $_GPC; $settings = $this->module['config']; $_accounts = $accounts = uni_accounts(); load()->model('mc'); if(empty($accounts) || !is_array($accounts) || count($accounts) == 0){ message('请指定公众号'); } if(!isset($_GPC['acid'])){ $account = array_shift($_accounts); if($account !== false){ $acid = intval($account['acid']); } } else { $acid = intval($_GPC['acid']); if(!empty($acid) && !empty($accounts[$acid])) { $account = $accounts[$acid]; } } reset($accounts); $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); if (empty($activity)) { message('非法访问.'); } $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY `refid`'; $params = array(); $params[':reid'] = $reid; $fields = pdo_fetchall($sql, $params); if (empty($fields)) { message('非法访问.'); } $ds = array(); foreach ($fields as $f) { $ds[$f['refid']] = $f['title']; } $select = array(); if (!empty($_GPC['select'])) { foreach ($_GPC['select'] as $field) { if (isset($ds[$field])) { $select[] = $field; } } } $member=$activity['member']; $phone=$activity['phone']; $staff = pdo_fetchall("SELECT * FROM ".tablename('dayu_form_staff')." WHERE reid = :reid ORDER BY `id` DESC", array(':reid' => $reid)); $pindex = max(1, intval($_GPC['page'])); $psize = 20; $starttime = empty($_GPC['time']['start']) ? strtotime('-1 month') : strtotime($_GPC['time']['start']); $endtime = empty($_GPC['time']['end']) ? TIMESTAMP : strtotime($_GPC['time']['end']) + 86399; $where.='reid=:reid'; $params = array(); $params[':reid'] = $reid; $status = $_GPC['status']; if (!empty($_GPC['time'])) { $where .= " AND createtime >= :starttime AND createtime <= :endtime "; $params[':starttime'] = $starttime; $params[':endtime'] = $endtime; } if (!empty($_GPC['keywords'])) { $where.=' and (member like :member or mobile like :mobile)'; $params[':member'] = "%{$_GPC['keywords']}%"; $params[':mobile'] = "%{$_GPC['keywords']}%"; } if (!empty($_GPC['kf'])) { $where.=" and kf LIKE '%{$_GPC['kf']}%'"; } if ($status != '') { $allstatus.=" and status='{$status}'"; } $sql = 'SELECT * FROM ' . tablename('dayu_form_info') . " WHERE $where $allstatus ORDER BY `createtime` DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize; $list = pdo_fetchall($sql, $params); $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE $where $allstatus", $params); $pager = pagination($total, $pindex, $psize); foreach ($list as $index => $row) { $list[$index]['user'] = mc_fansinfo($row['openid'],$acid, $_W['uniacid']); $list[$index]['kf'] = mc_fansinfo($row['kf'],$acid, $_W['uniacid']); $list[$index]['voices'] = $settings['qiniu']['host'].'/'.$row['voice']; $list[$index]['revoices'] = $settings['qiniu']['host'].'/'.$row['revoice']; } if (!empty($_GPC['export'])) { $sql = 'SELECT title,f.displayorder FROM ' . tablename('dayu_form_fields') . " AS f JOIN " . tablename('dayu_form_info') . " AS r ON f.reid='{$reid}' GROUP BY title ORDER BY refid, f.displayorder desc"; $tableheader = pdo_fetchall($sql, $params); $tablelength = count($tableheader); $sql = 'SELECT * FROM ' . tablename('dayu_form_info') . " WHERE $where $allstatus ORDER BY createtime DESC"; $list = pdo_fetchall($sql, $params); if (empty($list)) { message('暂时没有数据'); } foreach ($list as &$r) { $sql = 'SELECT data, refid FROM ' . tablename('dayu_form_data') . " WHERE `reid`=:reid AND `rerid`='{$r['rerid']}' ORDER BY redid, displayorder desc"; $paramss = array(); $paramss[':reid'] = $r['reid']; $r['fields'] = array(); $fdatas = pdo_fetchall($sql, $paramss); foreach ($fdatas as $fd) { $r['fields'][$fd['refid']] = $fd['data']; } } $data = array(); foreach ($list as $key => $value) { $data[$key]['openid'] = $value['openid']; $data[$key]['member'] = $value['member']; $data[$key]['mobile'] = $value['mobile']; $data[$key]['var1'] = $value['var1']; $data[$key]['var2'] = $value['var2']; $data[$key]['var3'] = $value['var3']; $data[$key]['createtime'] = date('Y-m-d H:i:s', $value['createtime']); $data[$key]['status'] = $value['status']; if (!empty($value['fields'])) { foreach ($value['fields'] as $field) { if (substr($field, 0, 6) == 'images') { $data[$key][] = str_replace(array("\n", "\r", "\t"), '', $_W['attachurl'] . $field); } else { $data[$key][] = str_replace(array("\n", "\r", ",", "\t"), '，', $field); } } } } $html = "\xEF\xBB\xBF"; $html .= "粉丝编号\t,"; $html .= $activity['member']."\t,"; $html .= $activity['phone']."\t,"; if($activity['var1']){ $html .= $activity['var1t']."\t,"; } if($activity['var2']){ $html .= $activity['var2t']."\t,"; } if($activity['var3']){ $html .= $activity['var3t']."\t,"; } foreach ($tableheader as $value) { $html .= $value['title'] . "\t,"; } $html .= "提交时间\t,"; $html .= "状态\t,"; $html .= "\n"; foreach ($data as $value) { if ($value['status'] == '0') { $huifu=$activity['state1']; }elseif ($value['status'] == '1') { $huifu=$activity['state2']; }elseif ($value['status'] == '2') { $huifu=$activity['state4']; }elseif ($value['status'] == '3') { $huifu=$activity['state3']; }elseif ($value['status'] == '-1') { $huifu=$activity['state5']; } $html .= $value['openid']."\t,"; $html .= $value['member']."\t,"; $html .= $value['mobile']."\t,"; if($activity['var1']){ $html .= $value['var1']."\t,"; } if($activity['var2']){ $html .= $value['var2']."\t,"; } if($activity['var3']){ $html .= $value['var3']."\t,"; } for ($i = 0; $i < $tablelength; $i++) { $html .= $value[$i]."\t,"; } $html .= $value['createtime']."\t,"; $html .= $huifu."\t,"; $html .= "\n"; } $stime=date('Ymd', $starttime); $etime=date('Ymd', $endtime); header("Content-type:text/csv"); header("Content-Disposition:attachment; filename={$activity['title']}==$stime-$etime.csv"); echo $html; exit(); } $title = "表单记录管理"; include $this->template('manage'); } public function doWebbatchrecord() { global $_GPC, $_W; $reid = intval($_GPC['reid']); $reply = pdo_fetch("select reid from " . tablename('dayu_form') . " where reid = :reid", array(':reid' => $reid)); if (empty($reply)) { message('抱歉，表单主题不存在或是已经被删除！'); } foreach ($_GPC['idArr'] as $k => $rerid) { $rerid = intval($rerid); pdo_delete('dayu_form_info', array('rerid' => $rerid, 'reid' => $reid)); pdo_delete('dayu_form_data', array('rerid' => $rerid)); } message('记录删除成功！', '', 0); } public function doWebupdategroup() { global $_GPC, $_W; if($_W['isajax']) { $groupid = intval($_GPC['groupid']); $openid = trim($_GPC['openid']); if(!empty($openid)) { $acc = WeAccount::create($_W['acid']); $data = $acc->updateFansGroupid($openid, $groupid); if(is_error($data)) { exit(json_encode(array('status' => 'error', 'mess' => $data['message']))); } else { pdo_update('mc_mapping_fans', array('groupid' => $groupid), array('uniacid' => $_W['uniacid'], 'acid' => $_W['acid'], 'openid' => $openid)); exit(json_encode(array('status' => 'success'))); } } else { exit(json_encode(array('status' => 'error', 'mess' => '粉丝openid错误'))); } } } public function doWebDisplay() { global $_W, $_GPC; $op = trim($_GPC['op']) ? trim($_GPC['op']) : ''; if ($_W['ispost']) { $reid = intval($_GPC['reid']); $switch = intval($_GPC['switch']); $sql = 'UPDATE ' . tablename('dayu_form') . ' SET `status`=:status WHERE `reid`=:reid'; $params = array(); $params[':status'] = $switch; $params[':reid'] = $reid; pdo_query($sql, $params); exit(); } if($op == 'copy') { $id = intval($_GPC['id']); $form = pdo_fetch('SELECT * FROM ' . tablename('dayu_form') . ' WHERE weid = :weid AND reid = :reid', array(':weid' => $_W['uniacid'], ':reid' => $id)); if(empty($form)) { message('表单不存在或已删除', referer(), 'error'); } $form['title'] = $form['title'] . '_' . random(6); unset($form['reid']); pdo_insert('dayu_form', $form); $form_id = pdo_insertid(); if(!$form_id) { message('复制表单出错', '', 'error'); } else { $fields = pdo_fetchall('SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE reid = :reid', array(':reid' => $id)); if(!empty($fields)) { foreach($fields as &$val) { unset($val['refid']); $val['reid'] = $form_id; pdo_insert('dayu_form_fields', $val); } } message('复制表单成功', $this->createWebUrl('display'), 'success'); } } $status =$_GPC['status']; if($status!=''){ $where.=" and status=".intval($status); } if (!empty($_GPC['keyword'])) { $where .= " AND title LIKE '%{$_GPC['keyword']}%'"; } $sql = 'SELECT * FROM ' . tablename('dayu_form') . " WHERE `weid`=:weid $where ORDER BY createtime DESC,reid DESC"; $params = array(); $params[':reid'] = $reid; $ds = pdo_fetchall($sql, array(':weid' => $_W['uniacid'])); foreach ($ds as &$item) { if (!empty($item['var1'])){ $var1 = '&'.$item['var1'].'=变量1'; } if (!empty($item['var2'])){ $var2 = '&'.$item['var2'].'=变量2'; } if (!empty($item['var3'])){ $var3 = '&'.$item['var3'].'=变量3'; } $item['isstart'] = $item['starttime'] > 0; $item['switch'] = $item['status']; $item['follow'] = $item['follow']==1 ? '<span class="btn btn-success btn-sm">启用</span>' : '<span class="btn btn-default btn-sm">关闭</span>'; $item['isvar'] = $item['isget']==1 ? '<span class="btn btn-success btn-sm">启用</span>' : '<span class="btn btn-default btn-sm">关闭</span>'; $item['isvoice'] = $item['isvoice']==1 ? '<span class="btn btn-success btn-sm">启用</span>' : '<span class="btn btn-default btn-sm">关闭</span>'; $item['isrevoice'] = $item['isrevoice']==1 ? '<span class="btn btn-success btn-sm">启用</span>' : '<span class="btn btn-default btn-sm">关闭</span>'; $item['isthumb'] = $item['isthumb']==1 ? '<span class="btn btn-success btn-sm">启用</span>' : '<span class="btn btn-default btn-sm">关闭</span>'; $item['link'] = $item['isget']==1 ? murl('entry', array('do' => 'dayu_form', 'id' =>$item['reid'], 'm' => 'dayu_form'), true, true).$var1.$var2.$var3 : murl('entry', array('do' => 'dayu_form', 'id' =>$item['reid'], 'm' => 'dayu_form'), true, true); $item['record'] = $item['isget']==1 ? murl('entry', array('do' => 'record', 'id' =>$item['reid'], 'm' => 'dayu_form'), true, true).$var1.$var2.$var3 : murl('entry', array('do' => 'record', 'id' =>$item['reid'], 'm' => 'dayu_form'), true, true); $item['mylink'] = murl('entry', array('do' => 'Mydayu_form', 'id' =>$item['reid'], 'weid' => $item[weid], 'm' => 'dayu_form'), true, true); } $title = "表单列表"; include $this->template('display'); } public function doWebDelete() { global $_W, $_GPC; $reid = intval($_GPC['id']); if ($reid > 0) { $params = array(); $params[':reid'] = $reid; $sql = 'DELETE FROM ' . tablename('dayu_form') . ' WHERE `reid`=:reid'; pdo_query($sql, $params); $sql = 'DELETE FROM ' . tablename('dayu_form_info') . ' WHERE `reid`=:reid'; pdo_query($sql, $params); $sql = 'DELETE FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid'; pdo_query($sql, $params); $sql = 'DELETE FROM ' . tablename('dayu_form_data') . ' WHERE `reid`=:reid'; pdo_query($sql, $params); $sql = 'DELETE FROM ' . tablename('dayu_form_staff') . ' WHERE `reid`=:reid'; pdo_query($sql, $params); message('操作成功.', referer()); } message('非法访问.'); } public function doWebdayu_formDelete() { global $_W, $_GPC; $id = intval($_GPC['id']); if (!empty($id)) { pdo_delete('dayu_form_info', array('rerid' => $id)); pdo_delete('dayu_form_data', array('rerid' => $id)); } message('操作成功.', referer()); } public function doMobiledayu_formDelete() { global $_W, $_GPC; $id = intval($_GPC['id']); $openid = intval($_GPC['openid']); $reid = intval($_GPC['reid']); $form = pdo_fetch("SELECT rerid, openid FROM ".tablename('dayu_form_info')." WHERE rerid = '$id'"); if (!empty($id) && $openid==$form['openid']) { pdo_delete('dayu_form_info', array('rerid' => $id)); pdo_delete('dayu_form_data', array('rerid' => $id)); $this->showMessage('删除成功.', $this->createMobileUrl('mydayu_form', array('weid' => $_W['uniacid'], 'id' => $reid))); }else{ $this->showMessage('删除失败，原因：该记录不在您的名下.', $this->createMobileUrl('mydayu_form', array('weid' => $_W['uniacid'], 'id' => $reid))); } } public function doWebPost() { global $_W, $_GPC; $reid = intval($_GPC['id']); $hasData = false; if ($reid) { $sql = 'SELECT COUNT(*) FROM ' . tablename('dayu_form_info') . ' WHERE `reid`=' . $reid; if (pdo_fetchcolumn($sql) > 0) { $hasData = true; } } load()->model('mc'); $setting = $this->module['config']; $groups = mc_groups(); if (checksubmit()) { $record = array(); $record['title'] = trim($_GPC['activity']); $record['titles'] = trim($_GPC['titles']); $record['weid'] = $_W['uniacid']; $record['description'] = trim($_GPC['description']); $record['content'] = trim($_GPC['content']); $record['information'] = trim($_GPC['information']); if (!empty($_GPC['thumb'])) { $record['thumb'] = $_GPC['thumb']; load()->func('file'); file_delete($_GPC['thumb-old']); } $record['status'] = intval($_GPC['status']); $record['custom_status'] = intval($_GPC['custom_status']); $record['inhome'] = intval($_GPC['inhome']); $record['pretotal'] = intval($_GPC['pretotal']); $record['member'] = trim($_GPC['member']); $record['phone'] = trim($_GPC['phone']); $record['starttime'] = strtotime($_GPC['starttime']); $record['endtime'] = strtotime($_GPC['endtime']); $record['starttime'] = strtotime($_GPC['starttime']); $record['endtime'] = strtotime($_GPC['endtime']); $record['noticeemail'] = trim($_GPC['noticeemail']); $record['k_templateid'] = trim($_GPC['k_templateid']); $record['kfirst'] = trim($_GPC['kfirst']); $record['kfoot'] = trim($_GPC['kfoot']); $record['mfirst'] = trim($_GPC['mfirst']); $record['mfoot'] = trim($_GPC['mfoot']); $record['m_templateid'] = trim($_GPC['m_templateid']); $record['mobile'] = trim($_GPC['mobile']); $record['kaishi'] = intval($_GPC['kaishi']); $record['jieshu'] = intval($_GPC['jieshu']); $record['tianshu'] = intval($_GPC['tianshu']); $record['mname'] = trim($_GPC['mname']); $record['state1'] = trim($_GPC['state1']); $record['state2'] = trim($_GPC['state2']); $record['state3'] = trim($_GPC['state3']); $record['state4'] = trim($_GPC['state4']); $record['state5'] = trim($_GPC['state5']); $record['adds'] = trim($_GPC['adds']); $record['skins'] = trim($_GPC['skins']); $record['outlink'] = trim($_GPC['outlink']); $record['mbgroup'] = $_GPC['mbgroup']; $record['isinfo'] = intval($_GPC['isinfo']); $record['business'] = trim($_GPC['business']); $record['address'] = trim($_GPC['address']); $record['tel'] = trim($_GPC['tel']); $record['loc_x'] = $_GPC['baidumap']['lat']; $record['loc_y'] = $_GPC['baidumap']['lng']; $record['follow'] = intval($_GPC['follow']); $record['isrethumb'] = intval($_GPC['isrethumb']); $record['isvoice'] = intval($_GPC['isvoice']); $record['isrevoice'] = intval($_GPC['isrevoice']); $record['voice'] = trim($_GPC['voice']); $record['voicedec'] = trim($_GPC['voicedec']); $record['ivoice'] = intval($_GPC['ivoice']); $record['isloc'] = intval($_GPC['isloc']); $record['ismember'] = intval($_GPC['ismember']); $record['isdel'] = intval($_GPC['isdel']); $record['isthumb'] = intval($_GPC['isthumb']); $record['isget'] = intval($_GPC['isget']); $record['var1'] = trim($_GPC['var1']); $record['var1t'] = trim($_GPC['var1t']); $record['var2'] = trim($_GPC['var2']); $record['var2t'] = trim($_GPC['var2t']); $record['var3'] = trim($_GPC['var3']); $record['var3t'] = trim($_GPC['var3t']); $record['credit'] = $_GPC['credit']; $record['smsid'] = $_GPC['smsid']; $record['smsnotice'] = $_GPC['smsnotice']; $record['smstype'] = $_GPC['smstype']; $record['agreement'] = trim($_GPC['agreement']); $record['daynum'] = intval($_GPC['daynum']); $record['paixu'] = intval($_GPC['paixu']); $record['isreplace'] = intval($_GPC['isreplace']); $record['pluraltit'] = trim($_GPC['pluraltit']); $record['plural'] = intval($_GPC['plural']); if (empty($reid)) { $record['status'] = 1; $record['createtime'] = TIMESTAMP; pdo_insert('dayu_form', $record); $reid = pdo_insertid(); if (!$reid) { message('保存表单失败, 请稍后重试.'); } } else { if (pdo_update('dayu_form', $record, array('reid' => $reid)) === false) { message('保存表单失败, 请稍后重试.'); } } if (!$hasData) { $sql = 'DELETE FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid'; $params = array(); $params[':reid'] = $reid; pdo_query($sql, $params); foreach ($_GPC['title'] as $k => $v) { $field = array(); $field['reid'] = $reid; $field['title'] = trim($v); $field['displayorder'] = range_limit($_GPC['displayorder'][$k], 0, 254); $field['type'] = $_GPC['type'][$k]; $field['essential'] = $_GPC['essentialvalue'][$k] == 'true' ? 1 : 0; $field['bind'] = $_GPC['bind'][$k]; $field['value'] = $_GPC['value'][$k]; $field['value'] = urldecode($field['value']); $field['description'] = $_GPC['desc'][$k]; $field['image'] = $_GPC['image'][$k]; pdo_insert('dayu_form_fields', $field); } } message('保存成功.', 'refresh'); } $types = array(); $types['number'] = '数字(number)'; $types['text'] = '字符串(text)'; $types['textarea'] = '文本(textarea)'; $types['radio'] = '单选(radio)'; $types['checkbox'] = '多选(checkbox)'; $types['select'] = '下拉框(select)'; $types['calendar'] = '日历(calendar)'; $types['email'] = '电子邮件(email)'; $types['image'] = '上传图片(image)'; $types['range'] = '日期时间(range)'; $types['reside'] = '省市区(reside)'; $fields = mc_fields(); if ($reid) { $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); $activity['starttime'] && $activity['starttime'] = date('Y-m-d H:i:s', $activity['starttime']); $activity['endtime'] && $activity['endtime'] = date('Y-m-d H:i:s', $activity['endtime']); $activity['map'] = array('lat' => $activity['loc_x'], 'lng' => $activity['loc_y']); if ($activity) { $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY `displayorder` DESC,`refid`'; $params = array(); $params[':reid'] = $reid; $ds = pdo_fetchall($sql, $params); } if (!empty($activity['var1'])){ $var1 = '&'.$activity['var1'].'=自定义变量1'; } if (!empty($activity['var2'])){ $var2 = '&'.$activity['var2'].'=自定义变量2'; } if (!empty($activity['var3'])){ $var3 = '&'.$activity['var3'].'=自定义变量3'; } $links = murl('entry', array('do' => 'dayu_form', 'id' =>$reid, 'm' => 'dayu_form'), true, true).$var1.$var2.$var3; }else{ $links = "保存表单后生成链接"; } $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $reply = pdo_fetch($sql, $params); if (!$reply) { $activity = array( "mname" => "往期记录", "kfirst" => "有客户提交新的表单，请及时跟进", "kfoot" => "点击处理客户提交的表单。", "mfirst" => "受理结果通知", "mfoot" => "如有疑问，请致电联系我们。", "information" => "您提交申请我们已经收到, 请等待客服跟进.", "state1" => "待受理", "state2" => "受理中", "state3" => "已完成", "state4" => "拒绝受理", "state5" => "已取消", "adds" => "联系地址", "voice" => "录音", "voicedec" => "录音说明", "pluraltit" => "上传图片", "kaishi" => 1, "jieshu" => 22, "tianshu" => 15, "status" => 1, "follow" => 1, "credit" => 0, "daynum" => 0, "member" => "姓名", "phone" => "手机", "pretotal" => "0", "endtime" => date('Y-m-d H:i:s', strtotime('+365 day')), ); } if(pdo_tableexists('dayu_sms')) { $sms = pdo_fetchall("SELECT * FROM ".tablename('dayu_sms')." WHERE weid = :weid", array(':weid' => $_W['uniacid'])); } $title = !empty($_GPC['id']) ? "编辑表单" : "新建表单"; include $this->template('post'); } public function doWebRecordSet() { global $_W, $_GPC; $reid = intval($_GPC['reid']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); $record = iunserializer($activity['fields']); $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY `displayorder` DESC,`refid`'; $params = array(); $params[':reid'] = $reid; $ds = pdo_fetchall($sql, $params); if (checksubmit()) { $record = array(); $record['field'] = intval($_GPC['field']); $record['avatar'] = intval($_GPC['avatar']); $record['bcolor'] = $_GPC['bcolor']; if (!empty($_GPC['fields'])) { foreach ($_GPC['fields'] as $fields) { $th[] = $fields; } $record['fields'] = iserializer($th); } if (pdo_update('dayu_form', $record, array('reid' => $reid)) === false) { message('保存表单失败, 请稍后重试.'); } message('保存成功.', 'refresh'); } include $this->template('recordset'); } public function doWebCustom() { global $_W,$_GPC; checklogin(); require 'fans.web.php'; $id = $_GPC['id']; load()->func('tpl'); $op = $operation = $_GPC['op']?$_GPC['op']:'display'; if ($operation == 'display') { if (!empty($_GPC['displayorder'])) { foreach ($_GPC['displayorder'] as $id => $displayorder) { pdo_update($this->custom_table, array('displayorder' => $displayorder), array('id' => $id)); } message('快捷回复内容排序更新成功！', $this->createWebUrl('custom', array('op' => 'display')), 'success'); } $custom = pdo_fetchall("SELECT * FROM ".tablename($this->custom_table)." WHERE weid = :weid ORDER BY displayorder DESC", array(':weid' => $weid)); include $this->template('custom'); } elseif ($operation == 'post') { $id = intval($_GPC['id']); if(!empty($id)) { $custom = pdo_fetch("SELECT * FROM ".tablename($this->custom_table)." WHERE id = '$id'"); } else { $city = array( 'displayorder' => 0, ); } if (checksubmit('submit')) { if (empty($_GPC['raply'])) { message('抱歉，请输入快捷回复内容！'); } $data = array( 'weid' => $weid, 'displayorder' => intval($_GPC['displayorder']), 'raply' => $_GPC['raply'], ); if (!empty($id)) { pdo_update($this->custom_table, $data, array('id' => $id)); } else { pdo_insert($this->custom_table, $data); $id = pdo_insertid(); } message('更新快捷回复内容成功！', $this->createWebUrl('custom', array('op' => 'display')), 'success'); } include $this->template('custom'); } elseif ($operation == 'delete') { $id = intval($_GPC['id']); $custom = pdo_fetch("SELECT * FROM ".tablename($this->custom_table)." WHERE id = '$id'"); if (empty($custom)) { message('抱歉，快捷回复内容不存在或是已经被删除！', $this->createWebUrl('custom', array('op' => 'display')), 'error'); } pdo_delete($this->custom_table, array('id' => $id)); message('快捷回复内容删除成功！', $this->createWebUrl('custom', array('op' => 'display')), 'success'); } } public function doMobilerecord() { global $_W, $_GPC; require 'fans.mobile.php'; $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); if(!$activity){ $this->showMessage('非法访问，主题不存在','','error'); } $record = iunserializer($activity['fields']); $fids = implode(',', $record); $list = pdo_fetchall("SELECT * FROM " . tablename('dayu_form') . " WHERE weid = :weid and kfid = :openid and status = 1 ORDER BY reid DESC", array(':weid' => $weid, ':openid' => $openid), 'reid'); $pindex = max(1, intval($_GPC['page'])); $psize = 10; $where.=" and status=3"; $sql = 'SELECT * FROM ' . tablename('dayu_form_info') . " WHERE reid=:reid $where ORDER BY createtime DESC,rerid DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize; $params = array(); $params[':reid'] = $reid; $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE reid = :reid $where ", $params); $pager = $this->pagination($total, $pindex, $psize); $rows = pdo_fetchall($sql, $params, 'rerid'); foreach ($rows as &$row) { $row['user'] = mc_fansinfo($row['openid'],$acid, $weid); } $rerid = array_keys($rows); $children = array(); $childlist = pdo_fetchall("SELECT * FROM ".tablename('dayu_form_data')." WHERE rerid IN ('".implode("','", is_array($rerid) ? $rerid : array($rerid))."') AND `reid`=:reid AND `refid` IN ({$fids})", array(':reid' => $reid)); foreach ($childlist as $reply => $r) { if (!empty($r['rerid'])) { $children[$r['rerid']][] = $r; unset($children[$reply]); } } $title=$activity['title']; $state = !empty($activity['state3']) ? $activity['state3'] : '已完成'; include $this->template('record'); } public function doMobiledayu_form() { global $_W, $_GPC; require 'fans.mobile.php'; $this->checkAuth(); $returnUrl = urlencode($_W['siteurl']); $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $weid; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); if ($activity['follow'] == 1) { $this->getFollow(); }else{ $member = !empty($member)?$member:$_SESSION['userinfo']; if(empty($member['avatar'])){ if($_W['account']['level']>3){ $member = mc_oauth_userinfo($_W['acid']); }else{ $member = mc_oauth_fans($openid,$_W['acid']); } } } $repeat = $_COOKIE['r_submit']; if(!empty($_GPC['repeat'])){ if(!empty($repeat)){ if($repeat==$_GPC['repeat']){ $this->showMessage($activity['information'], $this->createMobileUrl('mydayu_form', array('id' => $reid))); }else{ setcookie("r_submit",$_GPC['repeat']); } }else{ setcookie("r_submit",$_GPC['repeat']); } } if ($activity['status'] == 0) { $this->showMessage('活动已经停止.'); } if (!$activity) { $this->showMessage('非法访问，主题不存在'); } if ($activity['starttime'] > TIMESTAMP) { $this->showMessage('活动还未开始！<br>开始时间：'.date('Y-m-d H:i:s', $activity['starttime'])); } if ($activity['endtime'] < TIMESTAMP) { $this->showMessage('活动已经结束！<br>截至时间：'.date('Y-m-d H:i:s', $activity['endtime'])); } $acc = notice_init(); if(is_error($acc)) { return error(-1, $acc['message']); } $setting = uni_setting($_W['uniacid'], array('creditnames', 'creditbehaviors', 'uc', 'payment', 'passport')); $behavior = $setting['creditbehaviors']; $creditnames = $setting['creditnames']; $credits = mc_credit_fetch($_W['member']['uid'], '*'); $mcredit=$credits[$behavior['activity']]*100; $acredit=$activity['credit']*100; $activity['thumb'] = tomedia($activity['thumb']); $time=date('Y-m-d', time()); $yuyuetime=date('Y-m-d H:i', time()+3600); $group = pdo_fetch("SELECT * FROM ".tablename('mc_members')." WHERE uniacid = '{$weid}' AND uid = '{$uid}'"); $groupid = $group['groupid']; if($activity['mbgroup']!=0){ if($groupid != $activity['mbgroup']){$this->showMessage('您所在会员组没有相关的操作权限！', '','info');} } $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid` = :reid ORDER BY `displayorder` DESC'; $params = array(); $params[':reid'] = $reid; $ds = pdo_fetchall($sql, $params); if (!$ds) { $this->showMessage('表单不完整，缺少自定义项目，无法正常访问.'); } if ($activity['ismember']==1) { $ishy=$this->isHy($openid); if($ishy==false){ $this->showMessage('您还不是会员,请先领取您的会员卡.',$this->createMobileUrl('mycard', array('a' => 'card','c' => 'mc','i' => $weid),false),'info'); } } $initRange = $initCalendar = false; $binds = array(); $profile = mc_fetch($uid, $binds); foreach ($binds as $key => $value) { if ($value == 'reside') { unset($binds[$key]); $binds[] = 'resideprovince'; $binds[] = 'residecity'; $binds[] = 'residedist'; break; } if ($value == 'birth') { unset($binds[$key]); $binds[] = 'birthyear'; $binds[] = 'birthmonth'; $binds[] = 'birthday'; break; } } foreach ($ds as &$r) { if ($r['type'] == 'range') { $initRange = true; } if ($r['type'] == 'calendar') { $initCalendar = true; } if ($r['value']) { $r['options'] = explode(',', $r['value']); } if ($r['bind']) { $binds[$r['type']] = $r['bind']; } if ($r['type'] == 'reside') { $reside = $r; } if ($r['type'] == 'image') { $r['image'] = !empty($r['image']) ? $r['image'] : TEMPLATE_WEUI."images/nopic.jpg"; } if (in_array($r['type'], array('text', 'number', 'email'))){ $r['tixing'] = !empty($r['description']) ? urldecode($r['description']) : "请输入".$r['title']; }elseif($r['type'] == 'textarea'){ $r['tixing'] = !empty($r['description']) ? urldecode($r['description']) : "请填写".$r['title']; }else{ $r['tixing'] = !empty($r['description']) ? urldecode($r['description']) : "请选择".$r['title']; } if ($profile['gender']) { if ($profile['gender'] == '0') $profile['gender'] = '保密'; if ($profile['gender'] == '1') $profile['gender'] = '男'; if ($profile['gender'] == '2') $profile['gender'] = '女'; } if ($profile[$r['bind']]) { $r['default'] = $profile[$r['bind']]; } } if ($activity['pretotal']!=0) { $pretotal = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE reid = :reid AND openid = :openid", array(':reid' => $reid, ':openid' => $openid)); if ($pretotal >= $activity['pretotal']) { $this->showMessage('抱歉,每人只能提交' . $activity['pretotal'] . "次！", '', 'info'); } } if ($activity['daynum']!=0) { $today = mktime(0, 0, 0, date('m'), date('d'), date('Y')); $tomorrow = mktime(0, 0, 0, date('m'), date('d') + 1, date('Y')); $lognum = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename('dayu_form_info') . " WHERE openid = '{$openid}' AND reid = '{$reid}' AND createtime > " . $today . ' AND createtime < ' . $tomorrow); if($lognum>=$activity['daynum']){ $this->showMessage('抱歉,每天只能提交' . $activity['daynum'] . "次！", $this->createMobileUrl('mydayu_form', array('name' => 'dayu_form', 'weid' => $weid, 'id' => $reid)), 'info'); } } if ($_W['ispost'] || checksubmit('submit')) { $row = array(); $row['reid'] = $reid; $row['member']= $_GPC['member']; $row['mobile']= $_GPC['mobile']; $row['address']= $_GPC['address']; $row['loc_y']= $_GPC['loc_y']; $row['loc_x']= $_GPC['loc_x']; $row['openid'] = $_W['openid']; if (is_array($_GPC['thumb'])) { foreach ($_GPC['thumb'] as $thumb) { $th[] = tomedia($thumb); } $row['thumb'] = iserializer($th); } $row['voice']= $_GPC['voice']; $row['var1'] = $_GPC[$activity['var1']]; $row['var2'] = $_GPC[$activity['var2']]; $row['var3'] = $_GPC[$activity['var3']]; $row['createtime'] = TIMESTAMP; $datas = $fields = $update = array(); foreach ($ds as $value) { $fields[$value['refid']] = $value; } foreach ($_GPC as $key => $value) { if (strexists($key, 'field_')) { $bindFiled = substr(strrchr($key, '_'), 1); if (!empty($bindFiled)) { $update[$bindFiled] = $value; } $refid = intval(str_replace('field_', '', $key)); $field = $fields[$refid]; if ($refid && $field) { $entry = array(); $entry['reid'] = $reid; $entry['rerid'] = 0; $entry['refid'] = $refid; $entry['displayorder'] = $field['displayorder']; if (in_array($activity['skins'], array('weui', 'weui_yuntai'))) { if (in_array($field['type'], array('number', 'text', 'calendar', 'email', 'textarea', 'radio', 'range', 'select', 'image', 'reside', 'checkbox'))) { $entry['data'] = strval($value); } }else{ if (in_array($field['type'], array('number', 'text', 'calendar', 'email', 'textarea', 'radio', 'range', 'select', 'image', 'reside'))) { $entry['data'] = strval($value); } if (in_array($field['type'], array('checkbox'))) { if (!is_array($value)) continue; $entry['data'] = implode(',', $value); } } $datas[] = $entry; } } } if ($_FILES){ foreach ($_FILES as $key => $file) { if (strexists($key, 'field_')) { $refid = intval(str_replace('field_', '', $key)); $field = $fields[$refid]; if ($refid && $field && $file['name'] && $field['type'] == 'image') { $upfile = $file; $name = $upfile['name']; $type = $upfile['type']; $size = $upfile['size']; $tmp_name = $upfile['tmp_name']; $error = $upfile['error']; $upload_path = "../attachment/dayu_form/".$weid."/"; load()->func('file');@mkdirs($upload_path); if(intval($error) > 0){ message('上传错误：错误代码：'.$error, referer(), 'error'); }else { $upfilesize = !empty($activity['filesize']) ? $activity['filesize'] : 12; $maxfilesize = $upfilesize; if($maxfilesize > 0){ if($size > $maxfilesize * 1024 * 1024){ message('上传文件过大'.$_FILES["file"]["error"], referer(), 'error'); } } $uptypes = array ('image/jpg','image/png','image/jpeg'); if (!in_array($type, $uptypes)) { message('上传文件类型不符：'.$type, referer(), 'error'); } if(!file_exists($upload_path)){ mkdir($upload_path); } $source_filename = 'form'.$reid.'_'.date("YmdHis").mt_rand(10,99).'.jpg'; $target_filename = 'form'.$reid.'_'.date("YmdHis").mt_rand(10,99).'.thumb.jpg'; if(!move_uploaded_file($tmp_name, $upload_path.$source_filename)){ message('移动文件失败，请检查服务器权限', referer(), 'error'); } $srcfile = $upload_path.$source_filename; $desfile = $upload_path.$target_filename; $imginfo = getimagesize($srcfile); $imgtype = image_type_to_extension($imginfo[2],false); $fun = "imagecreatefrom".$imgtype; $image = $fun($srcfile); $color = imagecolorallocatealpha($image,255,0,0,50); $content = date('Y-m-d H:i:s', TIMESTAMP); imagestring($image,5,10,10,$content,$color); imagejpeg($image,$srcfile); $avatarsize = !empty($activity['upsize']) ? $activity['upsize'] : 640; $ret = file_image_thumb($srcfile, $desfile, $avatarsize); $entry = array(); $entry['reid'] = $reid; $entry['rerid'] = 0; $entry['refid'] = $refid; if(!is_array($ret)){ $entry['data'] = $upload_path.$target_filename; } $datas[] = $entry; } } } unlink($srcfile); } } if (!empty($_GPC['reside'])) { if (in_array('reside', $binds)) { $update['resideprovince'] = $_GPC['reside']['province']; $update['residecity'] = $_GPC['reside']['city']; $update['residedist'] = $_GPC['reside']['district']; } foreach ($_GPC['reside'] as $key => $value) { $resideData = array('reid' => $reside['reid']); $resideData['rerid'] = 0; $resideData['refid'] = $reside['refid']; $resideData['data'] = $value; $datas[] = $resideData; } } if (!empty($update)) { load()->model('mc'); mc_update($_W['member']['uid'], $update); } if ($activity['isreplace']) { $upinfo['realname'] = $_GPC['member']; $upinfo['mobile'] = $_GPC['mobile']; load()->model('mc'); mc_update($uid, $upinfo); } if (empty($datas)) { $this->showMessage('非法访问，提交数据不能为空', '', 'error'); } if (pdo_insert('dayu_form_info', $row) != 1) { $this->showMessage('保存失败.'); } $rerid = pdo_insertid(); if (empty($rerid)) { $this->showMessage('保存失败.'); } foreach ($datas as &$r) { $r['rerid'] = $rerid; pdo_insert('dayu_form_data', $r); } if (empty($activity['starttime'])) { $record = array(); $record['starttime'] = TIMESTAMP; pdo_update('dayu_form', $record, array('reid' => $reid)); } if (!empty($datas)) { foreach ($datas as $row) { if (strstr($row['data'], 'dayu_form')) { $row['data'] = "有"; } $bodym .= '\\n　' . $fields[$row['refid']]['title'] . ':' . $row['data']; $body .= '<h4>' . $fields[$row['refid']]['title'] . '：' . $row['data'] . '</h4>'; $smsbody .= $fields[$row['refid']]['title'].':'.$row['data'].'，'; } if (!empty($activity['noticeemail'])) { load()->func('communication'); ihttp_email($activity['noticeemail'], $activity['title'] . '的表单提醒', '<h4>姓名：'.$_GPC['member'].'</h4><h4>手机：'.$_GPC['mobile'].'</h4>'.$body); } if (!empty($activity['mobile']) && $activity['smsnotice']!=0) { load()->func('communication'); $content = $activity['smstype']==1 ? $activity['title'] : $smsbody; ihttp_post(murl('entry', array('do' => 'Notice', 'id' => $activity['smsnotice'], 'm' => 'dayu_sms'), true, true), array('mobile' => $activity['mobile'], 'mname' => $_GPC['member'], 'mmobile' => $_GPC['mobile'], 'content' => $content)); } $ytime = date('Y-m-d H:i:s', TIMESTAMP); $voice = !empty($_GPC['voice']) ? "\\n　有".$activity['voice'] : ""; $staff = pdo_fetchall("SELECT `openid` FROM ".tablename('dayu_form_staff')." WHERE reid=:reid AND weid=:weid", array(':weid' => $_W['uniacid'],':reid'=>$row['reid'])); if ($activity['custom_status'] == 0 && $staff) { if(is_array($staff)) { foreach($staff as $s) { $template =array( "touser"=>$s['openid'], "template_id"=>$activity['k_templateid'], "url"=>$_W['siteroot'] .'app/'.$this->createMobileUrl('manageform', array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])), "topcolor"=>"#FF0000", "data"=>array('first'=>array('value'=>urlencode($activity['kfirst']."\\n"), 'color'=>"#743A3A", ), 'keyword1'=>array('value'=>urlencode($_GPC['member']), 'color'=>'#000000', ), 'keyword2'=>array('value'=>urlencode($_GPC['mobile']), 'color'=>'#000000', ), 'keyword3'=>array('value'=>urlencode($ytime), 'color'=>'#000000', ), 'keyword4'=>array('value'=>urlencode($bodym.$voice."\\n"), 'color'=>"#FF0000", ), 'remark'=>array('value'=>urlencode($activity['kfoot']), 'color'=>"#008000", ), ) ); load()->func('communication'); $this->send_template_message(urldecode(json_encode($template))); } } }else{ if(is_array($staff)) { foreach($staff as $s) { $url = $_W['siteroot'].'app/'.$this->createMobileUrl('manageform',array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])); $info = "【您好，有新的消息】\n\n"; $info .= "姓名：{$_GPC['member']}\n手机：{$_GPC['mobile']}\n内容：{$bodym}\n\n"; $info .= "<a href='{$url}'>点击查看详情</a>"; $custom = array( 'msgtype' => 'text', 'text' => array('content' => urlencode($info)), 'touser' => $s['openid'], ); $acc->sendCustomNotice($custom); } } } } if($activity['credit']>0){ mc_credit_update($uid, 'credit1', '-'.$activity['credit'], array(0, $activity['title'].'-扣除'.$activity['credit'].$creditnames[$behavior['activity']]['title'])); } $outlink = !empty($activity['outlink']) ? $activity['outlink'] : $this->createMobileUrl('mydayu_form', array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])); $this->showMessage($activity['information'], $outlink); } load()->func('tpl'); $title = $activity['isthumb']==1 ? $activity['title']: $activity['titles']; $_share['title'] = $activity['title']; $_share['content'] = $activity['description']; $_share['imgUrl']=tomedia($activity['thumb']); include $this->template($activity['skins']); } public function doMobileUploads(){ global $_W, $_GPC; load()->classs('account'); $result = array( 'error' => 'error', 'message' => '', 'data' => '' ); if(empty($_W['acid'])){ $sql = "SELECT acid FROM ".tablename('mc_mapping_fans')." WHERE openid = :openid AND uniacid = :uniacid limit 1"; $params = array(':openid'=>$_W['openid'],':uniacid'=>$_W['uniacid']); $_W['acid'] = pdo_fetchcolumn($sql,$params); } if(empty($_W['acid'])){ $result['message'] = '没有找到相关公众账号'; die(json_encode($result)); } $acid = $_W['acid']; $acc = WeAccount::create($acid); $operation = !empty($_GPC['op']) ? $_GPC['op'] : 'upload'; $type = !empty($_GPC['type'])?$_GPC['type']:'image'; if ($operation == 'upload') { if($type == 'image'){ $serverId = trim($_GPC['serverId']); $localId = trim($_GPC['localId']); $media = array(); $media['media_id'] = $serverId; $media['type'] = $type; $result['serverId'] = $serverId; $result['localId'] = $localId; $filename = $acc->downloadMedia($media); if(is_error($filename)){ $result['message'] = '上传失败'; die(json_encode($result)); } $result['error'] = 'success'; $result['filename'] = $filename; $result['message'] = '上传成功'; $result['imgurl'] = $_W['attachurl'].$filename; $result['path'] = $filename; die(json_encode($result)); } } elseif ($operation == 'remove') { $file = $_GPC['file']; file_delete($file); exit(json_encode(array('status'=>true))); } } public function doMobileUpload(){ global $_W,$_GPC; load()->classs('weixin.account'); $accObj= WeixinAccount::create($_W['uniacid']); $access_token = $accObj->fetch_token(); $media_id = $_GET['media_id']; $url = "http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=".$access_token."&media_id=".$media_id; load()->func('tpl'); $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $weid; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); $upload_path = "../attachment/"; $images_path = "dayu_form/".$_W['uniacid']."/"; load()->func('file');@mkdirs($upload_path.$images_path); if(!file_exists($upload_path.$images_path)){ mkdir($upload_path.$images_path); } if($_GPC['type']==2){ $pic = 'avatar_'.date("YmdHis").mt_rand(1000,9999).'.jpg'; $picurl = $upload_path.$images_path.$pic; $data = array( 'avatar' => $images_path.$pic, ); load()->model('mc'); mc_update($_W['member']['uid'], $data); }elseif($reid){ $pic = 'form'.$reid.'_'.date("YmdHis").mt_rand(1000,9999).'.jpg'; $picurl = $upload_path.$images_path.$pic; } $targetName = $picurl; $ch = curl_init($url); $fp = fopen($targetName, 'wb'); curl_setopt($ch, CURLOPT_FILE, $fp); curl_setopt($ch, CURLOPT_HEADER, 0); curl_exec($ch); curl_close($ch); fclose($fp); $pathname = $images_path.$pic; if (!empty($_W['setting']['remote']['type'])) { load()->func('file'); $remotestatus = file_remote_upload($pathname); if (is_error($remotestatus)) { message('远程附件上传失败，请检查配置并重新上传'); } else { $remoteurl = $pathname; unlink($upload_path.$pathname); } } echo $pathname; } public function doMobileUploadvoice() { global $_W, $_GPC; if (empty($_GPC['serverId'])) { $this->showMessage('serverId为空'); } $settings = $this->module['config']; $content = $this->download_voice($_GPC['serverId'], ''); if ($content) { $filename = 'dayu_form_' . $_W['uniacid'] . '_' . $_GPC['serverId'] . '.mp3'; $r = $this->upload_qiniu_voice($filename, $content); } } public function upload_qiniu_voice($filename, $content) { require MODULE_ROOT . '/Qiniu.class.php'; $settings = $this->module['config']; if (!empty($settings['qiniu'])) { $qiniu = new Qiniu($settings['qiniu']); $pipeline=$settings['qiniu']['pipeline']; $r = $qiniu->putContent($filename, $content,$pipeline); if ($r === false) { return ''; } else { if (isset($r['persistentId']) && !empty($r['persistentId'])) { return $r['persistentId']; } else { return ''; } } } } public function download_voice($media_id, $retry = 0) { global $_W, $_GPC; if ($media_id) { $access_token = WeAccount::token(); load()->func('communication'); $voice = ihttp_get('http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=' . $access_token . '&media_id=' . $media_id); if (isset($voice['headers']['Content-disposition'])) { return $voice['content']; } else { if ($retry === 0) { $this->download_voice($media_id, 1); } return false; } } } public function showMessage($msg, $redirect = '', $type = '') { global $_W; if($redirect == 'refresh') { $redirect = $_W['script_name'] . '?' . $_SERVER['QUERY_STRING']; } elseif (!empty($redirect) && !strexists($redirect, 'http://')) { $urls = parse_url($redirect); $redirect = $_W['siteroot'] . 'app/index.php?' . $urls['query']; } if($redirect == '') { $type = in_array($type, array('success', 'error', 'info', 'warning', 'ajax', 'sql')) ? $type : 'info'; } else { $type = in_array($type, array('success', 'error', 'info', 'warning', 'ajax', 'sql')) ? $type : 'success'; } if($_W['isajax'] || $type == 'ajax') { $vars = array(); $vars['message'] = $msg; $vars['redirect'] = $redirect; $vars['type'] = $type; exit(json_encode($vars)); } if (empty($msg) && !empty($redirect)) { header('location: '.$redirect); } $label = $type; if($type == 'error') { $label = 'danger'; $info = '出错了，原因：'; } if($type == 'ajax' || $type == 'sql') { $label = 'warning'; $info = '访问受限，原因：'; } if($type == 'info') { $label = 'info'; $info = '操作提示'; } if($type == 'success') { $info = '提交成功'; } if (defined('IN_API')) { exit($msg); } include $this->template('messages', TEMPLATE_INCLUDEPATH); exit(); } public function doMobileMydayu_form() { global $_W, $_GPC; require 'fans.mobile.php'; $this->checkAuth(); $operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display'; $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); if ($activity['follow'] == 1) { $this->getFollow(); }else{ $member = !empty($member)?$member:$_SESSION['userinfo']; if(empty($member['avatar'])){ if($_W['account']['level']>3){ $member = mc_oauth_userinfo($_W['acid']); }else{ $member = mc_oauth_fans($openid,$_W['acid']); } } } $state1 = !empty($activity['state1']) ? $activity['state1'] : '待受理'; $state2 = !empty($activity['state2']) ? $activity['state2'] : '受理中'; $state3 = !empty($activity['state3']) ? $activity['state3'] : '已完成'; $state4 = !empty($activity['state4']) ? $activity['state4'] : '拒绝受理'; $state5 = !empty($activity['state5']) ? $activity['state5'] : '已取消'; if ($operation == 'display') { if ($reid) { $list = pdo_fetchall("SELECT * FROM " . tablename('dayu_form') . " WHERE weid = :weid and status = 1 ORDER BY reid DESC", array(':weid' => $weid), 'reid'); $pindex = max(1, intval($_GPC['page'])); $psize = 10; $status = intval($_GPC['status']); if ($_GPC['status']!='') { if ($status == 2) { $where.=" and ( status=2 or status=-1 )"; } else { $where.=" and status=$status"; } } $rows = pdo_fetchall("SELECT * FROM " . tablename('dayu_form_info') . " WHERE openid = :openid and reid = :reid $where ORDER BY rerid DESC LIMIT " . ($pindex - 1) * $psize . ",{$psize}", array(':openid' => $_W['openid'], ':reid' => $reid)); $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE openid = :openid and reid = :reid $where ", array(':openid' => $_W['openid'], ':reid' => $reid)); foreach ($rows as &$val) { $fdatas = pdo_fetchall("SELECT data FROM ".tablename('dayu_form_data')." WHERE rerid=:rerid", array(':rerid' => $val['rerid'])); foreach ($fdatas as $fd) { $data .= $fd['data'].","; } $val['filed'] = $data; } }else{ $sql = 'SELECT `reid` FROM ' . tablename('dayu_form_info') . " WHERE openid = :openid ORDER BY rerid DESC"; $params = array(); $params[':openid'] = $openid; $rows = pdo_fetchall($sql, $params); $new_array = array(); foreach($rows as $v){ $new_array[$v['reid']]=1; } $last = array(); foreach($new_array as $u=>$v){ $last[] = $u; } $fids = implode(',', $last); if($fids){ $list = pdo_fetchall("SELECT * FROM " . tablename('dayu_form') . " WHERE weid = :weid and reid in({$fids}) and status = 1 ORDER BY reid DESC", array(':weid' => $weid), 'reid'); $pindex = max(1, intval($_GPC['page'])); $psize = 10; $status = intval($_GPC['status']); if ($_GPC['status']!='') { if ($status == 2) { $where.=" and ( status=2 or status=-1 )"; } else { $where.=" and status=$status"; } } $rows = pdo_fetchall("SELECT * FROM " . tablename('dayu_form_info') . " WHERE openid = :openid $where ORDER BY rerid DESC LIMIT " . ($pindex - 1) * $psize . ",{$psize}", array(':openid' => $_W['openid'])); $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE openid = :openid $where ", array(':openid' => $_W['openid'])); } } $pager = $this->pagination($total, $pindex, $psize); } elseif ($operation == 'detail') { $settings = $this->module['config']; $rerid = intval($_GPC['rerid']); $row = pdo_fetch("SELECT * FROM " . tablename('dayu_form_info') . " WHERE openid = :openid AND rerid = :rerid", array(':openid' => $_W['openid'], ':rerid' => $rerid)); if (empty($row)) { $this->showMessage('记录不存在或是已经被删除！'); } $row['createtime'] = !empty($row['createtime']) ? date('Y年m月d日 H:i', $row['createtime']) : '时间丢失'; $row['yuyuetime'] = !empty($row['yuyuetime']) ? date('Y年m月d日 H:i', $row['yuyuetime']) : '请等待客服受理'; $row['thumb'] = iunserializer($row['thumb']); $row['voices'] = $settings['qiniu']['host'].'/'.$row['voice']; $row['revoices'] = $settings['qiniu']['host'].'/'.$row['revoice']; $row['rethumbs'] = tomedia($row['rethumb']); $row['file'] = iunserializer($row['file']); $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY displayorder DESC, refid DESC'; $params = array(); $params[':reid'] = $row['reid']; $fields = pdo_fetchall($sql, $params); if (empty($fields)) { $this->showMessage('非法访问.'); } $ds = $fids = array(); foreach ($fields as $f) { $ds[$f['refid']]['fid'] = $f['title']; $ds[$f['refid']]['type'] = $f['type']; $ds[$f['refid']]['refid'] = $f['refid']; $fids[] = $f['refid']; } $fids = implode(',', $fids); $row['fields'] = array(); $sql = 'SELECT * FROM ' . tablename('dayu_form_data') . " WHERE `reid`=:reid AND `rerid`='{$row['rerid']}' AND `refid` IN ({$fids})"; $fdatas = pdo_fetchall($sql, $params); foreach ($fdatas as $fd) { $row['fields'][$fd['refid']] = $fd['data']; } foreach ($ds as $value) { if ($value['type'] == 'reside') { $row['fields'][$value['refid']] = ''; foreach ($fdatas as $fdata) { if ($fdata['refid'] == $value['refid']) { $row['fields'][$value['refid']] .= $fdata['data']; } } break; } } $dayu_form['content'] = htmlspecialchars_decode($dayu_form['content']); } $title = $activity['title']; include $this->template('dayu_form'); } public function doMobilelist() { global $_W, $_GPC; $list = pdo_fetchall("SELECT * FROM " . tablename('dayu_form') . " WHERE weid = :weid and status = 1 ORDER BY reid DESC", array(':weid' => $_W['uniacid']), 'reid'); include $this->template('list'); } public function doMobilemanageform() { global $_W, $_GPC; require 'fans.mobile.php'; load()->func('tpl'); $operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display'; $reid = intval($_GPC['id']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); if ($activity['follow'] == 1) { $this->getFollow(); }else{ $member = !empty($member)?$member:$_SESSION['userinfo']; if(empty($member['avatar'])){ if($_W['account']['level']>3){ $member = mc_oauth_userinfo($_W['acid']); }else{ $member = mc_oauth_fans($openid,$_W['acid']); } } } if (!empty($reid)){ if($openid != $activity['kfid']){ $this->showMessage('非法访问！你不是管理员。'); } } $list = pdo_fetchall("SELECT * FROM " . tablename('dayu_form') . " WHERE weid = :weid and kfid = :openid and status = 1 ORDER BY reid DESC", array(':weid' => $weid, ':openid' => $openid), 'reid'); if ($operation == 'display' && $_W['openid'] == $activity['kfid']) { $pindex = max(1, intval($_GPC['page'])); $psize = 10; $status = $_GPC['status']; if ($status!='') { if ($status == 2) { $where.=" and ( status=2 or status=-1 )"; } else { $where.=" and status=$status"; } } $sql = 'SELECT * FROM ' . tablename('dayu_form_info') . " WHERE reid=:reid $where ORDER BY createtime DESC,rerid DESC LIMIT " . ($pindex - 1) * $psize . ',' . $psize; $params = array(); $params[':reid'] = $reid; $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename('dayu_form_info') . " WHERE reid = :reid $where ", $params); $pager = $this->pagination($total, $pindex, $psize); $rows = pdo_fetchall($sql, $params); foreach ($rows as $index => $row) { $fdatas = pdo_fetchall("SELECT data FROM ".tablename('dayu_form_data')." WHERE rerid=:rerid", array(':rerid' => $row['rerid'])); foreach ($fdatas as $fd) { $data .= $fd['data'].","; } $rows[$index]['filed'] = $data; $rows[$index]['user'] = mc_fansinfo($row['openid'],$acid, $weid); } } elseif ($operation == 'detail') { $settings = $this->module['config']; $rerid = intval($_GPC['rerid']); $row = pdo_fetch("SELECT * FROM " . tablename('dayu_form_info') . " WHERE rerid = :rerid", array(':rerid' => $rerid)); $custom = pdo_fetchall("SELECT * FROM ".tablename($this->custom_table)." WHERE weid = :weid ORDER BY displayorder DESC", array(':weid' => $weid)); if (empty($row)) { $this->showMessage('记录不存在或是已经被删除！'); } $fansloc = pdo_fetch("SELECT * FROM ".tablename($this->loc_table)." WHERE weid = :weid AND openid = :openid", array(':weid' => $weid, ':openid' => $row['openid'])); $face = mc_fansinfo($row['openid'],$acid, $weid); $dayu_form = pdo_fetch("SELECT * FROM " . tablename('dayu_form') . " WHERE reid = :reid", array(':reid' => $row['reid'])); $dayu_form['content'] = htmlspecialchars_decode($dayu_form['content']); $sql = 'SELECT * FROM ' . tablename('dayu_form_fields') . ' WHERE `reid`=:reid ORDER BY displayorder DESC, refid DESC'; $params = array(); $params[':reid'] = $row['reid']; $fields = pdo_fetchall($sql, $params); if (empty($fields)) { $this->showMessage('非法访问.'); } $ds = $fids = array(); foreach ($fields as $f) { $ds[$f['refid']]['fid'] = $f['title']; $ds[$f['refid']]['type'] = $f['type']; $ds[$f['refid']]['refid'] = $f['refid']; $fids[] = $f['refid']; } $fids = implode(',', $fids); $row['fields'] = array(); $sql = 'SELECT * FROM ' . tablename('dayu_form_data') . " WHERE `reid`=:reid AND `rerid`='{$row['rerid']}' AND `refid` IN ({$fids})"; $fdatas = pdo_fetchall($sql, $params); foreach ($fdatas as $fd) { $row['fields'][$fd['refid']] = $fd['data']; } foreach ($ds as $value) { if ($value['type'] == 'reside') { $row['fields'][$value['refid']] = ''; foreach ($fdatas as $fdata) { if ($fdata['refid'] == $value['refid']) { $row['fields'][$value['refid']] .= $fdata['data']; } } break; } } } $yuyuetime = !empty($row['yuyuetime']) ? date('Y-m-d H:i', $row['yuyuetime']) : date('Y-m-d H:i', TIMESTAMP); $row['createtime'] = !empty($row['createtime']) ? date('Y年m月d日 H:i', $row['createtime']) : '时间丢失'; $row['yuyuetime'] = !empty($row['yuyuetime']) ? date('Y年m月d日 H:i', $row['yuyuetime']) : '客服尚未受理'; $row['thumb'] = iunserializer($row['thumb']); $row['voices'] = $settings['qiniu']['host'].'/'.$row['voice']; $row['revoices'] = $settings['qiniu']['host'].'/'.$row['revoice']; $row['rethumbs'] = !empty($row['rethumb']) ? tomedia($row['rethumb']) : TEMPLATE_WEUI."images/nopic.jpg"; $row['file'] = iunserializer($row['file']); $record = array(); $record['status'] = intval($_GPC['status']); $record['yuyuetime'] = strtotime($_GPC['yuyuetime']); $record['kf'] = $openid; $record['kfinfo'] = $_GPC['kfinfo']; $record['revoice']= $_GPC['revoice']; $record['rethumb']= $_GPC['rethumb']; $revoice = !empty($_GPC['revoice']) ? '\\n有语音答复' : ''; $kfinfo = !empty($record['kfinfo']) ? '\\n客服：'.$record['kfinfo'] : ''; if ($_GPC['status'] == '0') { $huifu=$activity['state1'].$kfinfo.$revoice; }elseif ($_GPC['status'] == '1') { $huifu=$activity['state2'].$kfinfo.$revoice; }elseif ($_GPC['status'] == '2') { $huifu=$activity['state4'].$kfinfo.$revoice; }elseif ($_GPC['status'] == '3') { $huifu=$activity['state3'].$kfinfo.$revoice; } $ytime = date('Y-m-d H:i:s', $yuyuetime); $template =array( "touser"=>$row['openid'], "template_id"=>$dayu_form['m_templateid'], "url"=>$_W['siteroot'] .'app/'.$this->createMobileUrl('mydayu_form', array('op' => 'detail', 'rerid' => $rerid, 'id' => $reid)), "topcolor"=>"#FF0000", "data"=>array('first'=>array('value'=>urlencode($dayu_form['mfirst']), 'color'=>"#743A3A", ), 'keyword1'=>array('value'=>urlencode($row['member']), 'color'=>'#000000', ), 'keyword2'=>array('value'=>urlencode($row['mobile']), 'color'=>'#000000', ), 'keyword3'=>array('value'=>urlencode($_GPC['yuyuetime']), 'color'=>'#000000', ), 'keyword4'=>array('value'=>urlencode($huifu), 'color'=>"#FF0000", ), 'remark'=>array('value'=>urlencode($dayu_form['mfoot']), 'color'=>"#008000", ), ) ); $repeat = $_COOKIE['r_submit']; if(!empty($_GPC['repeat'])){ if(!empty($repeat)){ if($repeat==$_GPC['repeat']){ $this->showMessage($activity['information'], $this->createMobileUrl('mydayu_form', array('id' => $reid))); }else{ setcookie("r_submit",$_GPC['repeat']); } }else{ setcookie("r_submit",$_GPC['repeat']); } } if ($_W['ispost'] && $dayu_form['custom_status'] == 1) { load()->model('mc'); $acc = notice_init(); if(is_error($acc)) { return error(-1, $acc['message']); } $url = $_W['siteroot'].'app/'.$this->createMobileUrl('mydayu_form', array('name' => 'dayu_form', 'weid' => $row['weid'], 'id' => $row['reid'])); $info = "【您好，受理结果通知】\n\n"; $info .= "姓名：{$row['member']}\n手机：{$row['mobile']}\n受理结果：{$huifu}\n\n"; $info .= "<a href='{$url}'>点击查看详情</a>"; $custom = array( 'msgtype' => 'text', 'text' => array('content' => urlencode($info)), 'touser' => $row['openid'], ); $acc->sendCustomNotice($custom); pdo_update('dayu_form_info', $record,array('rerid' => $rerid)); $this->showMessage('修改成功',referer(),'success'); } if ($_W['ispost'] && $dayu_form['custom_status'] == 0){ load()->func('communication'); $this->send_template_message(urldecode(json_encode($template))); pdo_update('dayu_form_info', $record,array('rerid' => $rerid)); $this->showMessage('修改成功',referer(),'success'); } $title = $activity['title']; include $this->template('manage_form'); } public function isHy($openid){ global $_W; load()->model('mc'); $card = pdo_fetch("SELECT * FROM " . tablename("mc_card_members") . " WHERE uniacid=:uniacid AND openid = :openid ", array(':uniacid' => $_W['uniacid'], ':openid' => $openid)); if(empty($card)){ return false; }else{ return true; } } public function send_template_message($data){ global $_W, $_GPC; $atype = 'weixin'; $account_code = "account_weixin_code"; load()->classs('weixin.account'); $access_token = WeAccount::token(); $url="https://api.weixin.qq.com/cgi-bin/message/template/send?access_token=".$access_token; $response=ihttp_request($url,$data); if(is_error($response)) { return error(-1, "访问公众平台接口失败, 错误: {$response['message']}"); } $result = @json_decode($response['content'], true); if(empty($result)) { return error(-1, "接口调用失败, 原数据: {$response['meta']}"); } elseif(!empty($result['errcode'])) { return error(-1, "访问微信接口错误, 错误代码: {$result['errcode']}, 错误信息: {$result['errmsg']},信息详情：{$this->error_code($result['errcode'])}"); } return true; } public function AjaxMessage($msg, $status = 0) { $result = array('message' => $msg, 'status' => $status); echo json_encode($result); exit; } public function doMobilechangeAjax() { global $_W, $_GPC; $id = intval($_GPC['id']); $reid = intval($_GPC['reid']); $sql = 'SELECT * FROM ' . tablename('dayu_form') . ' WHERE `weid`=:weid AND `reid`=:reid'; $params = array(); $params[':weid'] = $_W['uniacid']; $params[':reid'] = $reid; $activity = pdo_fetch($sql, $params); $row = pdo_fetch("SELECT * FROM ".tablename('dayu_form_info')." WHERE rerid = :rerid", array(':rerid' => $id)); $status = $_GPC['status']; $data = array( 'status' => $status ); if (!empty($id)) { $url=$_W['siteroot'] .'app/'.$this->createMobileUrl('mydayu_form', array('op' => 'detail', 'rerid' => $id, 'id' => $reid)); $data = array ( 'first' => array('value' => $activity['mfirst']."\n",'color'=>"#743A3A"), 'keyword1' => array('value' => $row['member']), 'keyword2' => array('value' => $row['mobile']), 'keyword3' => array('value' => date('Y-m-d H:i:s', TIMESTAMP)), 'keyword4' => array('value' => $activity['state3'],), 'remark' => array('value' => "\n".$activity['mfoot'],'color'=>"#008000") ); $acc = WeAccount::create($_W['acid']); $acc->sendTplNotice($row['openid'],$activity['m_templateid'],$data,$url,"#FF0000"); pdo_update('dayu_form_info', $data, array('rerid' => $id)); $this->AjaxMessage('更新成功!', 1); }else{$this->AjaxMessage('更新失败!', 0);} } function pagination($tcount, $pindex, $psize = 15, $url = '', $context = array('before' => 5, 'after' => 4, 'ajaxcallback' => '')) { global $_W; $pdata = array( 'tcount' => 0, 'tpage' => 0, 'cindex' => 0, 'findex' => 0, 'pindex' => 0, 'nindex' => 0, 'lindex' => 0, 'options' => '' ); if($context['ajaxcallback']) { $context['isajax'] = true; } $pdata['tcount'] = $tcount; $pdata['tpage'] = ceil($tcount / $psize); if($pdata['tpage'] <= 1) { return ''; } $cindex = $pindex; $cindex = min($cindex, $pdata['tpage']); $cindex = max($cindex, 1); $pdata['cindex'] = $cindex; $pdata['findex'] = 1; $pdata['pindex'] = $cindex > 1 ? $cindex - 1 : 1; $pdata['nindex'] = $cindex < $pdata['tpage'] ? $cindex + 1 : $pdata['tpage']; $pdata['lindex'] = $pdata['tpage']; if($context['isajax']) { if(!$url) { $url = $_W['script_name'] . '?' . http_build_query($_GET); } $pdata['faa'] = 'href="javascript:;" onclick="p(\'' . $_W['script_name'] . $url . '\', \'' . $pdata['findex'] . '\', ' . $context['ajaxcallback'] . ')"'; $pdata['paa'] = 'href="javascript:;" onclick="p(\'' . $_W['script_name'] . $url . '\', \'' . $pdata['pindex'] . '\', ' . $context['ajaxcallback'] . ')"'; $pdata['naa'] = 'href="javascript:;" onclick="p(\'' . $_W['script_name'] . $url . '\', \'' . $pdata['nindex'] . '\', ' . $context['ajaxcallback'] . ')"'; $pdata['laa'] = 'href="javascript:;" onclick="p(\'' . $_W['script_name'] . $url . '\', \'' . $pdata['lindex'] . '\', ' . $context['ajaxcallback'] . ')"'; } else { if($url) { $pdata['faa'] = 'href="?' . str_replace('*', $pdata['findex'], $url) . '"'; $pdata['paa'] = 'href="?' . str_replace('*', $pdata['pindex'], $url) . '"'; $pdata['naa'] = 'href="?' . str_replace('*', $pdata['nindex'], $url) . '"'; $pdata['laa'] = 'href="?' . str_replace('*', $pdata['lindex'], $url) . '"'; } else { $_GET['page'] = $pdata['findex']; $pdata['faa'] = 'href="' . $_W['script_name'] . '?' . http_build_query($_GET) . '"'; $_GET['page'] = $pdata['pindex']; $pdata['paa'] = 'href="' . $_W['script_name'] . '?' . http_build_query($_GET) . '"'; $_GET['page'] = $pdata['nindex']; $pdata['naa'] = 'href="' . $_W['script_name'] . '?' . http_build_query($_GET) . '"'; $_GET['page'] = $pdata['lindex']; $pdata['laa'] = 'href="' . $_W['script_name'] . '?' . http_build_query($_GET) . '"'; } } $html = '<div class="pager">'; if($pdata['cindex'] > 1) { $html .= "<div class=\"pager-left\">"; $html .= "<div class=\"pager-first\"><a {$pdata['faa']} class=\"pager-nav\">首页</a></div>"; $html .= "<div class=\"pager-pre\"><a {$pdata['paa']}>上一页</a></div>"; $html .= "</div>"; } else { $html .= "<div class=\"pager-left\">"; $html .= "<div class=\"pager-pre\" style=\"width:100%\"><a href=\"###\">这是第一页</a></div>"; $html .= "</div>"; } $html .= "<div class=\"pager-cen\">{$pindex} / " . $pdata['tpage'] . "</div>"; if($pdata['cindex'] < $pdata['tpage']) { $html .= "<div class=\"pager-right\">"; $html .= "<div class=\"pager-next\"><a {$pdata['naa']} class=\"pager-nav\">下一页</a></div>"; $html .= "<div class=\"pager-end\"><a {$pdata['laa']} class=\"pager-nav\">尾页</a></div>"; $html .= "</div>"; } else { $html .= "<div class=\"pager-right\">"; $html .= "<div class=\"pager-next\" style=\"width:100%\"><a href=\"###\">已是尾页</a></div>"; $html .= "</div>"; } $html .= '<div class="clr"></div></div>'; return $html; } public function get_form($reid,$type){ global $_GPC,$_W; if ($type==1){ return pdo_fetchcolumn("SELECT COUNT(*) FROM ".tablename('dayu_form_info')." WHERE reid = :reid and openid = :openid", array(":reid" => $reid, ":openid" => $_W['openid'])); }elseif ($type==2){ return pdo_fetchcolumn("SELECT COUNT(*) FROM ".tablename('dayu_form_info')." WHERE reid = :reid", array(":reid" => $reid)); } } public function doMobileFansUs(){ global $_W, $_GPC; $qrcodesrc = tomedia('qrcode_'.$_W['acid'].'.jpg'); include $this->template('fans_us'); } public function getFollow(){ global $_GPC,$_W; $p = pdo_fetch("SELECT follow FROM ".tablename('mc_mapping_fans')." WHERE uniacid = :weid AND openid = :openid LIMIT 1", array(":weid" => $_W['uniacid'], ":openid" => $_W['openid'])); if(intval($p['follow']) == 0){ header('Location: '.$this->createMobileUrl('FansUs'), true, 301); }else{ return true; } } private function checkAuth() { global $_W; $setting = cache_load('unisetting:'.$_W['uniacid']); if (empty($_W['member']['uid']) && empty($setting['passport']['focusreg'])) { $fan = pdo_get('mc_mapping_fans', array('uniacid' =>$_W['uniacid'], 'openid' => $_W['openid'])); if (!empty($fan)) { $fanid = $fan['fanid']; } else { $post = array( 'acid' => $_W['acid'], 'uniacid' => $_W['uniacid'], 'openid' => $_W['openid'], 'updatetime' => time(), 'follow' => 0, ); pdo_insert('mc_mapping_fans', $post); $fanid = pdo_insertid(); } if (empty($fan['uid'])) { pdo_insert('mc_members', array('uniacid' => $_W['uniacid'])); $uid = pdo_insertid(); $_W['member']['uid'] = $uid; $_W['fans']['uid'] = $uid; pdo_update('mc_mapping_fans', array('uid' => $uid), array('fanid' => $fanid)); } else { $_W['member']['uid'] = $fan['uid']; $_W['fans']['uid'] = $fan['uid']; } } else { checkauth(); } } } function dayu_fans_form($field, $value = '') { switch ($field) { case 'reside': case 'resideprovince': case 'residecity': case 'residedist': $html = dayu_form_field_district('reside', $value); break; } return $html; } function dayu_form_field_district($name, $values = array()) { $html = ''; if (!defined('TPL_INIT_DISTRICT')) { $html .= '
		<script type="text/javascript">
			require(["jquery", "district"], function($, dis){
				$(".tpl-district-container").each(function(){
					var elms = {};
					elms.province = $(this).find(".tpl-province")[0];
					elms.city = $(this).find(".tpl-city")[0];
					elms.district = $(this).find(".tpl-district")[0];
					var vals = {};
					vals.province = $(elms.province).attr("data-value");
					vals.city = $(elms.city).attr("data-value");
					vals.district = $(elms.district).attr("data-value");
					dis.render(elms, vals, {withTitle: true});
				});
			});
		</script>'; define('TPL_INIT_DISTRICT', true); } if (empty($values) || !is_array($values)) { $values = array('province'=>'','city'=>'','district'=>''); } if(empty($values['province'])) { $values['province'] = ''; } if(empty($values['city'])) { $values['city'] = ''; } if(empty($values['district'])) { $values['district'] = ''; } $html .= '
		<div class="tpl-district-container" style="display: block;">
			<div class="col-lg-4">
				<select name="' . $name . '[province]" data-value="' . $values['province'] . '" class="tpl-province">
				</select><i></i>
			</div>
			<div class="col-lg-4">
				<select name="' . $name . '[city]" data-value="' . $values['city'] . '" class="tpl-city">
				</select><i></i>
			</div>
			<div class="col-lg-4">
				<select name="' . $name . '[district]" data-value="' . $values['district'] . '" class="tpl-district">
				</select><i></i>
			</div>
		</div>'; return $html; } function notice_init() { global $_W; $acc = WeAccount::create(); if(is_null($acc)) { return error(-1, '创建公众号操作对象失败'); } return $acc; } function tpl_form_field_images($name, $value = '', $default = '', $options = array()) { global $_W; if (empty($default)) { $default = './resource/images/nopic.jpg'; } $val = $default; if (!empty($value)) { $val = tomedia($value); } if (!empty($options['global'])) { $options['global'] = true; } else { $options['global'] = false; } if (empty($options['class_extra'])) { $options['class_extra'] = ''; } if (isset($options['dest_dir']) && !empty($options['dest_dir'])) { if (!preg_match('/^\w+([\/]\w+)?$/i', $options['dest_dir'])) { exit('图片上传目录错误,只能指定最多两级目录,如: "we7_store","we7_store/d1"'); } } $options['direct'] = true; $options['multiple'] = false; if (isset($options['thumb'])) { $options['thumb'] = !empty($options['thumb']); } $s = ''; if (!defined('TPL_INIT_IMAGE')) { $s = '
		<script type="text/javascript">
			function showImageDialog(elm, opts, options) {
				require(["util"], function(util){
					var btn = $(elm);
					var ipt = btn.parent().prev();
					var val = ipt.val();
					var img = ipt.parent().next().children();
					options = '.str_replace('"', '\'', json_encode($options)).';
					util.image(val, function(url){
						if(url.url){
							if(img.length > 0){
								img.get(0).src = url.url;
							}
							ipt.val(url.attachment);
							ipt.attr("filename",url.filename);
							ipt.attr("url",url.url);
						}
						if(url.media_id){
							if(img.length > 0){
								img.get(0).src = "";
							}
							ipt.val(url.media_id);
						}
					}, null, options);
				});
			}
			function deleteImage(elm){
				require(["jquery"], function($){
					$(elm).prev().attr("src", "./resource/images/nopic.jpg");
					$(elm).parent().prev().find("input").val("");
				});
			}
		</script>'; define('TPL_INIT_IMAGE', true); } $s .= '
		<div class="input-group ' . $options['class_extra'] . '">
			<input type="text" name="' . $name . '" value="' . $value . '"' . ($options['extras']['text'] ? $options['extras']['text'] : '') . ' id="re-image" class="form-control" autocomplete="off">
			<span class="input-group-btn">
				<button class="btn btn-default" type="button" onclick="showImageDialog(this);">选择图片</button>
			</span>
		</div>
		<div class="col-xs-12 ' . $options['class_extra'] . '" style="margin-top:.5em;">
			<em class="close" style="position:absolute; top: 0px; right: -14px;font-size:18px;color:#333;" title="删除这张图片" onclick="deleteImage(this)">× 删除</em>
		</div>'; return $s; }

?>