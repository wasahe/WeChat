function jsonpCallback(A){webim.setJsonpLastRspData(A)}function onBigGroupMsgNotify(A){for(var C=A.length-1;C>=0;C--){var B=A[C];webim.Log.warn("receive a new avchatroom group msg: "+B.getFromAccountNick());showMsg(B)}}function onMsgNotify(A){var C;for(var B in A){C=A[B];handlderMsg(C)}}function handlderMsg(E){var F,C,G,B,A;F=E.getFromAccount();if(!F){F=""}C=E.getFromAccountNick();if(!C){C=F}G=E.getSession().type();B=E.getSubType();switch(G){case webim.SESSION_TYPE.C2C:switch(B){case webim.C2C_MSG_SUB_TYPE.COMMON:A=convertMsgtoHtml(E);webim.Log.warn("receive a new c2c msg: fromAccountNick="+C+", content="+A);var D={"To_Account":F,"LastedMsgTime":E.getTime()};webim.c2CMsgReaded(D);alert("收到一条c2c消息(好友消息或者全员推送消息): 发送人="+C+", 内容="+A);break}break;case webim.SESSION_TYPE.GROUP:break}}function sdkLogin(){webim.login(loginInfo,listeners,options,function(A){webim.Log.info("webim登录成功");applyJoinBigGroup(avChatRoomId)},function(A){$(document).minTipsBox({tipsContent:A.ErrorInfo,tipsTime:3})})}function applyJoinBigGroup(A){var B={"GroupId":A};webim.applyJoinBigGroup(B,function(C){if(C.JoinedStatus&&C.JoinedStatus=="JoinedSuccess"){webim.Log.info("进群成功");selToID=A}else{$(document).minTipsBox({tipsContent:"进群失败",tipsTime:3})}},function(C){$(document).minTipsBox({tipsContent:C.ErrorInfo,tipsTime:3})})}function unescapeHTML(A){var B=document.createElement("DIV");B.innerHTML=A;if(B.innerText){return B.innerText}return B.textContent}function showMsg(F){var E,C,A,K,H;var J,L,D,M,B,I;C=F.getFromAccount();if(!C){C=""}A=F.getFromAccountNick();if(!A){A="未知用户"}K=F.getSession().type();H=F.getSubType();E=F.getIsSend();webim.Log.info(A);switch(H){case webim.GROUP_MSG_SUB_TYPE.COMMON:F=unescapeHTML(convertMsgtoHtml(F));var G={data:F};onmessage(G);break;case webim.GROUP_MSG_SUB_TYPE.REDPACKET:break;case webim.GROUP_MSG_SUB_TYPE.LOVEMSG:break;case webim.GROUP_MSG_SUB_TYPE.TIP:convertMsgtoHtml(F);break}}function convertMsgtoHtml(E){var A="",G,C,D,F;G=E.getElems();for(var B in G){C=G[B];D=C.getType();F=C.getContent();switch(D){case webim.MSG_ELEMENT_TYPE.TEXT:A+=convertTextMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.FACE:A+=convertFaceMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.IMAGE:A+=convertImageMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.SOUND:A+=convertSoundMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.FILE:A+=convertFileMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.LOCATION:break;case webim.MSG_ELEMENT_TYPE.CUSTOM:A+=convertCustomMsgToHtml(F);break;case webim.MSG_ELEMENT_TYPE.GROUP_TIP:A+=convertGroupTipMsgToHtml(F);break;default:webim.Log.error("未知消息元素类型: elemType="+D);break}}return A}function convertTextMsgToHtml(A){return A.getText()}function convertFaceMsgToHtml(B){var D=B.getIndex();var E=B.getData();var A=null;var C=webim.Emotions[D];if(C&&C[1]){return C[0];A=C[1]}if(A){return"<img src='"+A+"'/>"}else{return E}}function convertImageMsgToHtml(B){var D=B.getImage(webim.IMAGE_TYPE.SMALL);var C=B.getImage(webim.IMAGE_TYPE.LARGE);var A=B.getImage(webim.IMAGE_TYPE.ORIGIN);if(!C){C=D}if(!A){A=D}return"<img src='"+D.getUrl()+"#"+C.getUrl()+"#"+A.getUrl()+"' style='CURSOR: hand' id='"+B.getImageId()+"' bigImgUrl='"+C.getUrl()+"' onclick='imageClick(this)' />"}function convertSoundMsgToHtml(B){var C=B.getSecond();var A=B.getDownUrl();if(webim.BROWSER_INFO.type=="ie"&&parseInt(webim.BROWSER_INFO.ver)<=8){return"[这是一条语音消息]demo暂不支持ie8(含)以下浏览器播放语音,语音URL:"+A}return'<audio src="'+A+'" controls="controls" onplay="onChangePlayAudio(this)" preload="none"></audio>'}function convertFileMsgToHtml(A){var B=Math.round(A.getSize()/1024);return'<a href="'+A.getDownUrl()+'" title="点击下载文件" ><i class="glyphicon glyphicon-file">&nbsp;'+A.getName()+"("+B+"KB)</i></a>"}function convertLocationMsgToHtml(A){return"经度="+A.getLongitude()+",纬度="+A.getLatitude()+",描述="+A.getDesc()}function convertCustomMsgToHtml(A){var D=A.getData();var B=A.getDesc();var C=A.getExt();return"data="+D+", desc="+B+", ext="+C}function convertGroupTipMsgToHtml(N){var L=10;var J="";var K=L-1;var D,I,A;var O;D=N.getOpType();I=N.getOpUserId();switch(D){case webim.GROUP_TIP_TYPE.JOIN:A=N.getUserIdList();for(var B in A){J+=A[B]+",";if(A.length>L&&B==K){J+="等"+A.length+"人";break}}J=J.substring(0,J.length-1);J+="进入房间";$(".qlOLPeople").text(parseInt($(".qlOLPeople").text())+1);break;case webim.GROUP_TIP_TYPE.QUIT:J+=I+"离开房间";O=parseInt($(".qlOLPeople").text());if(O>0){$(".qlOLPeople").text(parseInt($(".qlOLPeople").text())-1)}break;case webim.GROUP_TIP_TYPE.KICK:J+=I+"将";A=N.getUserIdList();for(var B in A){J+=A[B]+",";if(A.length>L&&B==K){J+="等"+A.length+"人";break}}J+="踢出该群";break;case webim.GROUP_TIP_TYPE.SET_ADMIN:J+=I+"将";A=N.getUserIdList();for(var B in A){J+=A[B]+",";if(A.length>L&&B==K){J+="等"+A.length+"人";break}}J+="设为管理员";break;case webim.GROUP_TIP_TYPE.CANCEL_ADMIN:J+=I+"取消";A=N.getUserIdList();for(var B in A){J+=A[B]+",";if(A.length>L&&B==K){J+="等"+A.length+"人";break}}J+="的管理员资格";break;case webim.GROUP_TIP_TYPE.MODIFY_GROUP_INFO:J+=I+"修改了群资料：";var G=N.getGroupInfoList();var E,H;for(var B in G){E=G[B].getType();H=G[B].getValue();switch(E){case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.FACE_URL:J+="群头像为"+H+"; ";break;case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.NAME:J+="群名称为"+H+"; ";break;case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.OWNER:J+="群主为"+H+"; ";break;case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.NOTIFICATION:J+="群公告为"+H+"; ";break;case webim.GROUP_TIP_MODIFY_GROUP_INFO_TYPE.INTRODUCTION:J+="群简介为"+H+"; ";break;default:J+="未知信息为:type="+E+",value="+H+"; ";break}}break;case webim.GROUP_TIP_TYPE.MODIFY_MEMBER_INFO:J+=I+"修改了群成员资料:";var M=N.getMemberInfoList();var C,F;for(var B in M){C=M[B].getUserId();F=M[B].getShutupTime();J+=C+": ";if(F!=null&&F!==undefined){if(F==0){J+="取消禁言; "}else{J+="禁言"+F+"秒; "}}else{J+=" shutupTime为空"}if(M.length>L&&B==K){J+="等"+M.length+"人";break}}break;default:J+="未知群提示消息类型：type="+D;break}return J}function tlsLogin(){TLSHelper.goLogin({sdkappid:loginInfo.sdkAppID,acctype:loginInfo.accountType,url:window.location.href})}function tlsGetUserSig(A){if(A.ErrorCode==webim.TLS_ERROR_CODE.OK){loginInfo.identifier=webim.Tool.getQueryString("identifier");loginInfo.userSig=A.UserSig;loginInfo.sdkAppID=loginInfo.appIDAt3rd=Number(webim.Tool.getQueryString("sdkappid"));var B=webim.Tool.getCookie("accountType");if(B){loginInfo.accountType=B;sdkLogin()}else{alert("accountType非法")}}else{if(A.ErrorCode==webim.TLS_ERROR_CODE.SIGNATURE_EXPIRATION){tlsLogin()}else{alert("["+A.ErrorCode+"]"+A.ErrorInfo)}}}function imageClick(D){var C=D.src;var B=C.split("#");var E=B[0];var A=B[1];var F=B[2];webim.Log.info("小图url:"+E);webim.Log.info("大图url:"+A);webim.Log.info("原图url:"+F)}function onChangePlayAudio(A){if(curPlayAudio){if(curPlayAudio!=A){curPlayAudio.currentTime=0;curPlayAudio.pause();curPlayAudio=A}}else{curPlayAudio=A}}function smsPicClick(){if(!loginInfo.identifier){if(accountMode==1){webim.Tool.setCookie("accountType",loginInfo.accountType,3600*24);tlsLogin()}else{alert("请填写帐号和票据")}return}else{hideDiscussTool();showDiscussForm()}}function onSendMsg(F){if(!loginInfo.identifier){if(accountMode==1){webim.Tool.setCookie("accountType",loginInfo.accountType,3600*24);tlsLogin()}else{alert("请填写帐号和票据")}return}if(!selToID){alert("您还没有进入房间，暂不能聊天");return}var Q=F;var J=webim.Tool.getStrBytes(Q);if(Q.length<1){alert("发送的消息不能为空!");return}var G,T;if(selType==webim.SESSION_TYPE.GROUP){G=webim.MSG_MAX_LENGTH.GROUP;T="消息长度超出限制(最多"+Math.round(G/3)+"汉字)"}else{G=webim.MSG_MAX_LENGTH.C2C;T="消息长度超出限制(最多"+Math.round(G/3)+"汉字)"}if(J>G){alert(T);return}if(!selSess){selSess=new webim.Session(selType,selToID,selToID,selSessHeadUrl,Math.round(new Date().getTime()/1000))}var S=true;var I=-1;var E=Math.round(Math.random()*4294967296);var A=Math.round(new Date().getTime()/1000);var O;if(selType==webim.SESSION_TYPE.GROUP){O=webim.GROUP_MSG_SUB_TYPE.COMMON}else{O=webim.C2C_MSG_SUB_TYPE.COMMON}var K=new webim.Msg(selSess,S,I,E,A,loginInfo.identifier,O,loginInfo.identifierNick);var B=/\[[^[\]]{1,3}\]/mg;var M=Q.match(B);var P,N,R,D,L,C;if(!M||M.length<1){P=new webim.Msg.Elem.Text(Q);K.addText(P)}else{for(var H=0;H<M.length;H++){R=Q.substring(0,Q.indexOf(M[H]));if(R){P=new webim.Msg.Elem.Text(R);K.addText(P)}D=webim.EmotionDataIndexs[M[H]];L=webim.Emotions[D];if(L){N=new webim.Msg.Elem.Face(D,M[H]);K.addFace(N)}else{P=new webim.Msg.Elem.Text(M[H]);K.addText(P)}C=Q.indexOf(M[H])+M[H].length;Q=Q.substring(C)}if(Q){P=new webim.Msg.Elem.Text(Q);K.addText(P)}}webim.sendMsg(K,function(U){if(selType==webim.SESSION_TYPE.C2C){showMsg(K)}webim.Log.info("发消息成功")},function(U){webim.Log.error("发消息失败:"+U.ErrorInfo);if(U.ErrorCode==10017){alert("您已经被管理员禁言!");return}})}function sendGroupLoveMsg(){if(!loginInfo.identifier){if(accountMode==1){webim.Tool.setCookie("accountType",loginInfo.accountType,3600*24);tlsLogin()}else{alert("请填写帐号和票据")}return}if(!selToID){alert("您还没有进入房间，暂不能点赞");return}if(!selSess){selSess=new webim.Session(selType,selToID,selToID,selSessHeadUrl,Math.round(new Date().getTime()/1000))}var B=true;var C=-1;var G=Math.round(Math.random()*4294967296);var E=Math.round(new Date().getTime()/1000);var F=webim.GROUP_MSG_SUB_TYPE.LOVEMSG;var D=new webim.Msg(selSess,B,C,G,E,loginInfo.identifier,F,loginInfo.identifierNick);var H="love_msg";var A=new webim.Msg.Elem.Text(H);D.addText(A);webim.sendMsg(D,function(I){if(selType==webim.SESSION_TYPE.C2C){showMsg(D)}webim.Log.info("点赞成功")},function(I){webim.Log.error("发送点赞消息失败:"+I.ErrorInfo);alert("发送点赞消息失败:"+I.ErrorInfo)})}function showLoveMsgAnimation(){var D=$("#user-icon-like").html();$("#user-icon-like").html(parseInt(D)+1);var F=document.getElementById("video-discuss-tool");var H=document.createElement("span");var A=["red","green","blue"];var G=A.length-1;var B=0;var E=parseInt(Math.random()*(G-B+1)+B,G+1);var C=A[E];H.setAttribute("class","like-icon zoomIn "+C);F.appendChild(H)}function selectEmotionImg(A){$("#send_msg_text").val($("#send_msg_text").val()+A.id)}function quitBigGroup(){var A={"GroupId":avChatRoomId};webim.quitBigGroup(A,function(B){webim.Log.info("退群成功");$("#video_sms_list").find("li").remove()},function(B){alert(B.ErrorInfo)})}function logout(){webim.logout(function(C){webim.Log.info("登出成功");loginInfo.identifier=null;loginInfo.userSig=null;var A=window.location.href;var B=A.indexOf("?");if(B>=0){A=A.substring(0,B)}window.location.href=A})};