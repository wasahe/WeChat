(function(A){A.fn.extend({minTipsBox:function(B){B=A.extend({tipsContent:"",tipsTime:1},B);var C=1000*parseFloat(B.tipsTime);0<A(".min_tips_box").length?A(".min_tips_box").show():A('<div class="min_tips_box"><b class="bg"></b><span class="tips_content"></span></div>').appendTo("body");(function(){A(".min_tips_box .tips_content").html(B.tipsContent);var D=A(".min_tips_box .tips_content").width()/2+10;A(".min_tips_box .tips_content").css("margin-left","-"+D+"px")})();setTimeout(function(){A(".min_tips_box").hide()},C)}})})(jQuery);String.prototype.HttpHtml=function(){var A=/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|&|-)+)/g;return this.replace(A,'<a href="$1$2">$1$2</a>')};Date.prototype.format=function(A){var C={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(A)){A=A.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var B in C){if(new RegExp("("+B+")").test(A)){A=A.replace(RegExp.$1,RegExp.$1.length==1?C[B]:("00"+C[B]).substr((""+C[B]).length))}}return A};console.log("夺冠互动版权所有 http://www.duoguan.com");console.log("请支持正版 联系电话 0371-53371086");var clock_index=0,currentPlaying=null,room_id=user_info.room_id,avatar=user_info.headimgurl,nickname=user_info.nickname;var clock_handler=null,current_voiclocalid=null,globalObj=new Object();WEB_SOCKET_DEBUG=true;globalObj.chat_images=[];var ws,name=user_info.nickname,client_list={};var is_firstload=1;var is_autoplay=false;var fnTimeCountDown=function(B,A){var C={haomiao:function(D){if(D<10){return"00"+D.toString()}if(D<100){return"0"+D.toString()}return D.toString()},zero:function(D){var D=parseInt(D,10);if(D>0){if(D<=9){D="0"+D}return String(D)}else{return"00"}},dv:function(){var F=new Date();var G=(B-F.getTime())/1000,E=B-F.getTime(),D={hm:"000",sec:"00",mini:"00",hour:"00",day:"00",month:"00",year:"0"};if(E>0){D.hm=C.haomiao(E%1000);D.sec=C.zero(G%60);D.mini=Math.floor((G/60))>0?C.zero(Math.floor((G/60))%60):"00";D.hour=Math.floor((G/3600))>0?C.zero(Math.floor((G/3600))%24):"00";D.day=Math.floor((G/86400))>0?C.zero(Math.floor((G/86400))):"00";D.month=Math.floor((G/2629744))>0?C.zero(Math.floor((G/2629744))%12):"00";D.year=Math.floor((G/31556926))>0?Math.floor((G/31556926)):"0"}else{D.year=D.month=D.day=D.hour=D.mini=D.sec="00";D.hm="000";return}return D},ui:function(){if(A.hm){A.hm.html(C.dv().hm)}if(A.sec){A.sec.html(C.dv().sec)}if(A.mini){A.mini.html(C.dv().mini)}if(A.hour){A.hour.html(C.dv().hour)}if(A.day){A.day.html(C.dv().day)}if(A.month){A.month.html(C.dv().month)}if(A.year){A.year.html(C.dv().year)}setTimeout(C.ui,1)}};C.ui()};var EmotionDic={};function initEmotionUL(){for(var E in webim.Emotions){var D=$("<img>").attr({"id":webim.Emotions[E][0],"src":webim.Emotions[E][1],"style":"cursor:pointer;"}).click(function(){selectEmotionImg(this)});$("<li>").append(D).appendTo($("#emoj_list"));var C=webim.Emotions[E][0];var A=webim.Emotions[E][1];var B={};EmotionDic[C]=A}$("#emoj_list li").click(function(){if(globalObj.emojbox){$("."+globalObj.emojbox).val($("."+globalObj.emojbox).val()+$(this).find("img").attr("id"))}})}function convertEmotion(C){if(C==""){return""}var B=new RegExp("\\[(.+?)\\]","g");var A=C.match(B);if(A){for(i=0;i<A.length;i++){C=C.replace(A[i],"<img style='float:left;' src='"+EmotionDic[A[i]]+"'/>")}}C=C.HttpHtml();return C}function showEmotionDialog(A){$(".control_emojbox").toggleClass("on");if(A=="main"){$(".control_emojbox").css({"bottom":"5.1rem"});globalObj.emojbox="speakInput"}else{$(".control_emojbox").css({"bottom":"16.6rem"});globalObj.emojbox="danmuInput"}}function startRec(){$(".second_dd var").eq(0).text(clock_index);clock_index++;if(clock_index==59){clock_index=60;$("#btnStopRec").click()}}function reward(){$(".btn_ilike").unbind();$(".btn_ilike").click(function(){var A=$(this).parent().children(".head_portrait").children("img").attr("src");$(".redbagBox").find(".live_headpic").children().attr("src",A);$(".redbagBox").attr("msg_id",$(this).parents(".left_bubble").attr("msg_id"));$(".redbagBox").show();var C=$(this).parent().children(".speaker_name").children("b").text();var B="***";if(user_info&&user_info.nickname){B=user_info.nickname}globalObj.reward={to_name:C,to_avatar:A,from_name:B,from_avatar:user_info.headimgurl}});$(".redbag_cancel").unbind();$(".redbag_cancel").click(function(){$(".redbagBox").hide()});$(".live_othermoney").unbind();$(".live_othermoney").click(function(){$(".otherRedmoneyBox").show()});$(".payli").unbind();$(".payli").click(function(){var B=$(this).text();var D=$(this).parents(".redbagBox").attr("msg_id");$(document).minTipsBox({tipsContent:"加载中..",tipsTime:123});$(".redbagBox").hide();globalObj.reward.money=B;var C=globalObj.reward.from_name+" 赞赏了 "+globalObj.reward.to_name+" 一个红包!";delete globalObj.reward.from_name;delete globalObj.reward.to_name;var A=JSON.stringify(globalObj.reward);globalObj.reward_last={type:"say",target:"main",msgtype:"reward",headimg:avatar,"from_client_name":user_info.nickname,content:A,content_ext:C};$.getJSON(reward_url,{pay:B,msg_id:D},function(E){callpay(E);$(".min_tips_box").remove()})});$(".otherRedmoneyBox .gene_confirm").unbind();$(".otherRedmoneyBox .gene_confirm").click(function(){var B=$("#money").val();if(B==""){return}$(document).minTipsBox({tipsContent:"加载中..",tipsTime:123});$(".redbagBox").hide();var D=$(".redbagBox").attr("msg_id");globalObj.reward.money=B;var C=globalObj.reward.from_name+" 赞赏了 "+globalObj.reward.to_name+" 一个红包!";delete globalObj.reward.from_name;delete globalObj.reward.to_name;var A=JSON.stringify(globalObj.reward);globalObj.reward_last={type:"say",target:"main",msgtype:"reward",headimg:avatar,"from_client_name":user_info.nickname,content:A,content_ext:C};$.getJSON(reward_url,{pay:B,msg_id:D},function(E){$(".geneBox").hide();callpay(E);$(".min_tips_box").remove()})});$(".lm_main").unbind();$(".lm_main").click(function(){$(".thank_money").children("var").text($(this).attr("attr-money"));var A=$(this).attr("attr-imgurl");$(".LmTipsBox").find(".live_headpic").children("img").attr("src",A);var B=$(this).attr("from-name")+"赞赏了"+$(this).attr("attr-toname");if(!$(this).attr("attr-toname")){B="赞赏"}$(".LmTipsBox").find(".live_towhy").text(B);$(".LmTipsBox").show()});$(".redbag_cancel").click(function(){$(".redbag_box").hide()})}function jsApiCall(A){WeixinJSBridge.invoke("getBrandWCPayRequest",A,function(B){WeixinJSBridge.log(B.err_msg);if(B.err_msg=="get_brand_wcpay_request:ok"){if(globalObj.reward_last){sentContent(globalObj.reward_last)}}else{if(B.err_msg=="get_brand_wcpay_request:cancel"){}else{alert(B.err_msg)}}})}function callpay(A){if(typeof WeixinJSBridge=="undefined"){if(document.addEventListener){document.addEventListener("WeixinJSBridgeReady",jsApiCall,false)}else{if(document.attachEvent){document.attachEvent("WeixinJSBridgeReady",jsApiCall);document.attachEvent("onWeixinJSBridgeReady",jsApiCall)}}}else{jsApiCall(A)}}function get_disdamu(D,C){var A=$(".danmulist").children("dd").size();if(A>2){$(".danmulist").children("dd").last().remove()}var B="";B+='<dd dmsg_id="'+D.msg_id+'"><i><img src="'+D.headimg+'"></i><p>';B+=convertEmotion(D.content);B+="</p></dd>";if(C=="desc"){$(".danmulist").prepend(B)}else{$(".danmulist").append(B)}}function get_contenthtml(E){var F='<dd class="left_bubble hasTime" msg_id="'+E.msg_id+'" id="msg_'+E.msg_id+'">';F+='<div class="speak_time">'+E.time+"</div>";F+='<div class="head_portrait"><img src="'+E.headimg+'"></div>';F+='<div class="speaker_name"><b>'+E.from_client_name+"</b>"+E.role_name+"</div>";F+='<div class="bubble_content "><p>'+convertEmotion(E.content)+"</p></div>";if(E.revoke&&(user_info.is_manager||user_info.is_guest)){F+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){F+='<a class="btn_ilike" href="javascript:;">赏</a>'}F+="</dd>";if(E.msgtype=="voice"){var A=getRecordClass(E.last);F='<dd class="left_bubble hasTime" msg_id="'+E.msg_id+'" id="msg_'+E.msg_id+'" ppt_id="'+E.ppt_id+'">';F+='<div class="speak_time">'+E.time+"</div>";F+='<div class="head_portrait"><img src="'+E.headimg+'"></div>';F+='<div class="speaker_name"><b>'+E.from_client_name+"</b>"+E.role_name+"</div>";F+='<div class="bubble_content recordingMsg isReaded '+A+'">';F+='<i class="audio_info" attr-src="'+E.content+'"></i><var>'+E.last+"</var></div>";if(E.revoke&&(user_info.is_manager||user_info.is_guest)){F+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){F+='<a class="btn_ilike" href="javascript:;">赏</a>'}F+="</dd>"}if(E.msgtype=="image"){F='<dd class="left_bubble hasTime" msg_id="'+E.msg_id+'" id="msg_'+E.msg_id+'">';F+='<div class="speak_time">'+E.time+"</div>";F+='<div class="head_portrait"><img src="'+E.headimg+'"></div>';F+='<div class="speaker_name"><b>'+E.from_client_name+"</b>"+E.role_name+"</div>";F+='<div class="bubble_content ">';F+='<img id="sub_'+E.msg_id+'" class="chat_img" mediaid="'+E.content+'" src="'+E.content+'"></div>';if(E.revoke&&(user_info.is_manager||user_info.is_guest)){F+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){F+='<a class="btn_ilike" href="javascript:;">赏</a>'}F+="</dd>"}if(E.msgtype=="ask"){try{var D=JSON.parse(E.content);F='<dd class="left_bubble hasTime" msg_id="'+E.msg_id+'" id="msg_'+E.msg_id+'">';F+='<div class="speak_time">'+E.time+"</div>";F+='<div class="head_portrait"><img src="'+E.headimg+'"></div>';F+='<div class="speaker_name"><b>'+E.from_client_name+"</b>"+E.role_name+"</div>";F+='<div class="bubble_content "><p><b>'+D.N+':</b><em class="ask_label">问</em>'+D.Q+"</p><p><b>回复:</b>"+D.replay+"</p></div>";if(E.revoke&&(user_info.is_manager||user_info.is_guest)){F+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){F+='<a class="btn_ilike" href="javascript:;">赏</a>'}F+="</dd>"}catch(B){F="";console.dir(B)}}if(E.msgtype=="reward"){try{var C=JSON.parse(E.content);var F='<dt class="luckyMoney" msg_id="'+E.msg_id+'">';if(C.to_name){F+='<div class="lm_main" attr-imgurl="'+C.to_avatar+'" attr-money="'+C.money+'" attr-toname="'+C.to_name+'" from-name="'+E.from_client_name+'" from-avatar="'+E.headimg+'">';F+="<var>"+E.from_client_name+"</var> 赞赏了 <var>"+C.to_name+"</var> 一个<b>红包</b>"}else{F+='<div class="lm_main" attr-imgurl="'+C.to_avatar+'" attr-money="'+C.money+'" from-avatar="'+E.headimg+'">';F+=E.last}F+="</div>";F+="</dt>"}catch(B){F="";console.dir(B)}}return F}function get_discontenthtml(A){var B='<dd class="comment_dd"  msg_id="'+A.msg_id+'">';B+='<span class="right_info">';if(user_info.is_manager||user_info.is_guest){B+='<i class="btn_wall">上墙</i>'}B+='<i class="btn_like">0</i> <i class="btn_hate">0</i></span>';B+='<a class="avatar"><img src="'+A.headimg+'"></a><a class="author_name">'+A.from_client_name+"</a>";B+='<b class="time">'+A.time+"</b>";if(user_info.is_manager){B+='<i class="commentManage">管理<span class="commentManageTab" style="display:none;">';B+='<a class="delCommentMsg">删除</a><a class="shutUpSet">禁言</a></span></i>'}if(A.is_ask){A.content='<em class="ask_label">问</em>'+A.content}B+='<p class="content">'+convertEmotion(A.content)+"</p></dd>";return B}function getRecordClass(A){if(A<12){return"recordwid1"}else{if(A>=12&&A<24){return"recordwid2"}else{if(A>=24&&A<36){return"recordwid3"}else{if(A>=36&&A<48){return"recordwid4"}else{if(A>48){return"recordwid5"}else{return"recordwid1"}}}}}}function sentContent(A){var B=location.href;A.role_name=user_info.role_name;if(A.msgtype=="del"||A.msgtype=="ppt"){onSendMsg(JSON.stringify(A));return}A.ppt_id=current_ppt_id;$.post(B,A,function(C){if(C.success==-1){alert(C.data);return}A.msg_id=C.msg_id;A.time=new Date().format("hh:mm:ss");A.uid=user_info.uid;onSendMsg(JSON.stringify(A));globalObj.reward=null;globalObj.reward_last=null;if(A.target=="discuss"){$(".btnCommentCancel").click()}})}function voicePlayOver(){if(globalObj.voicePlaying){globalObj.voicePlaying.removeClass("isPlaying");globalObj.voicePlaying.addClass("isReaded ");globalObj.isPlaying=false;var A=globalObj.voicePlaying.parents("dd").attr("msg_id");$(".recordingMsg").each(function(){if(parseInt($(this).parents("dd").attr("msg_id"))>parseInt(A)){$(this).click();return false}})}}function stopEventBubble(A){var B=A||window.event;if(B&&B.stopPropagation){B.stopPropagation()}else{B.cancelBubble=true}}function voiceDown(){$(".recordingMsg").unbind();$(".recordingMsg").click(function(D){stopEventBubble(D);var I=$(this).children("i");var H=$(this);$(".isPlaying").removeClass("isPlaying");var C=I.attr("attr-src");var F=H.parents("dd").attr("ppt_id");if(istopic_end&&F!=0&&swiper_objs.length>0){var G=-1;for(var A=0;A<swiper_objs.length;A++){if(swiper_objs[A].id==F){G=A}}if(G>=0){swiper.slideTo(G,100,false)}}if(C&&C.indexOf("http")==0){if($("#audioPlayer").attr("src")!=C){$("#audioPlayer").attr("src",C)}var E=$("#audioPlayer")[0];if(E.paused){E.play();H.addClass("isPlaying");globalObj.isPlaying=true}else{E.pause();H.removeClass("isPlaying")}globalObj.voicePlaying=H;E.removeEventListener("ended",voicePlayOver,false);E.addEventListener("ended",voicePlayOver,false);return}if(I.attr("localid")){var B=I.attr("localid");if(H.hasClass("isPlaying")){wx.pauseVoice({localId:B});H.removeClass("isPlaying")}else{wx.playVoice({localId:B});globalObj.isPlaying=true;H.addClass("isPlaying");wx.onVoicePlayEnd({success:function(J){H.removeClass("isPlaying");H.addClass("isReaded ");globalObj.isPlaying=false}})}return}wx.downloadVoice({serverId:I.attr("attr-src"),success:function(J){var K=J.localId;H.addClass("isPlaying");I.attr("localid",K);wx.playVoice({localId:K});globalObj.isPlaying=true;wx.onVoicePlayEnd({success:function(L){H.removeClass("isPlaying");H.addClass("isReaded ");globalObj.isPlaying=false}})}})})}var page_object={sub_pindex:1,sub_pages:sub_pages,com_pindex:1,com_pages:discuss_pages,loaded:[],loadeddis:[]};function ajax_content(B,A,D){if($.inArray(B,page_object.loaded)==-1){page_object.loaded.push(B)}else{$(".btnLoadSpeakEnd").removeClass("on");$(".btnLoadSpeak").removeClass("on");return}var C=location.href;$.getJSON(C,{pindex:B,target:"main"},function(F){page_object.sub_pages=F.total;page_object.sub_pindex=F.pindex;var E="";$.each(F.rows,function(G,H){if(H.msgtype=="image"){if($.inArray(H.content,globalObj.chat_images)==-1){globalObj.chat_images.push(H.content)}}E+=get_contenthtml(H)});$(".speakContentBox").unbind();if(A=="down"){$("#speakBubbles").append(E)}else{$("#speakBubbles").prepend(E)}voiceDown();$(".chat_img").unbind();$(".chat_img").click(function(){wx.previewImage({current:$(this).attr("src"),urls:globalObj.chat_images})});if(A=="down"){if(D==1){$(".speakContentBox").scrollTop(18)}}else{$(".speakContentBox").scrollTop(18)}$(".btnLoadSpeakEnd").removeClass("on");$(".btnLoadSpeak").removeClass("on");reward();is_firstload=0;$(".speakContentBox").scroll(scroll_func);$(".btn_revoke").unbind();$(".btn_revoke").click(function(){var G=$(this).parents("dd").attr("msg_id");var H=confirm("确认撤销此消息吗？");if(!H){return}$.post(location.href,{msg_id:G,revoke:1},function(I){if(I.success==1){var J={type:"say",target:"main",msgtype:"del","from_client_name":user_info.nickname,content:G};sentContent(J)}})});$(".speakContentBox").click(function(){if(istopic_end==0&&(user_info.is_guest||user_info.is_manager)){$(".speakBox").removeClass("hasTabBottom");$(".speakBox").removeClass("othersBottom");$(".speakBox").removeClass("voiceBottom");$(".speakBox").removeClass("textBottom");$(".speakBox").addClass("hasTabBottom")}$(".control_emojbox").removeClass("on")})})}function ajax_discuss_content(A){if($.inArray(A,page_object.loadeddis)==-1){page_object.loadeddis.push(A)}else{$(".btnLoadComment ").removeClass("on");return}var B=location.href;$.getJSON(B,{pindex:A,target:"discuss"},function(D){page_object.com_pages=D.total;$("#common_num").text(D.items);page_object.com_pindex=D.pindex;if(A==1&&D.rows.length>0){$("#loadNone").hide()}var C="";$.each(D.rows,function(E,F){C+=get_discontenthtml(F);get_disdamu(F,"asc")});$("#commentDl").append(C);$(".btn_wall").click(function(){var F=$(this).parents("dd").children(".author_name").text();var E=$(this).parents("dd").children(".content").text();if(E.indexOf("问")==0){E=E.replace("问","")}globalObj.Question={N:F,Q:E};$(".commentReplyBox").show()});$(".commentManage").unbind();$(".commentManage").click(function(){var E=$(this).children().css("display");if(E=="none"){$(this).children().show()}else{$(this).children().hide()}});$(".delCommentMsg").unbind();$(".delCommentMsg").click(function(){var G=confirm("确认要删除吗?");if(G){var F=$(this).parents("dd").attr("msg_id");var E=$(this).parents("dd");$.post(location.href,{msg_id:F,op:"del"},function(H){if(H.success==1){E.remove()}})}});$(".shutUpSet").unbind();$(".shutUpSet").click(function(){var G=confirm("确认要对此用户禁言吗?");if(G){var F=$(this).parents("dd").attr("msg_id");var E=$(this).parents("dd");$.post(location.href,{msg_id:F,op:"shutup"},function(H){if(H.success==1){alert(H.data)}})}});$(".commentContentBox").scrollTop($(".commentContentBox")[0].scrollHeight-530);$(".btnLoadComment ").removeClass("on")})}function uploadVoic(A){wx.uploadVoice({localId:A,isShowProgressTips:1,success:function(C){var D=C.serverId;var B={type:"say",target:"main",msgtype:"voice",headimg:avatar,"last":clock_index,"from_client_name":user_info.nickname,content:D};sentContent(B);clock_index=0;current_voiclocalid=null}})}function onmessage(B){var C=JSON.parse(B.data);switch(C["type"]){case"ping":onSendMsg('{"type":"pong"}');break;case"login":if(tcpdata.revoke&&(user_info.is_manager||user_info.is_guest)){$(".qlOLPeople").text(C["users"])}else{$(".qlOLPeople").text(parseInt($(".qlOLPeople").text())+1)}break;case"say":if(C.target=="main"){var A=$("#speakBubbles").find("dd").last();if(A.size()>0&&C.msg_id){if(A.attr("msg_id")<C.msg_id){say(C)}}else{say(C)}}else{say_discuss(C)}break;case"logout":break;case"tipmsg":if(tcpdata.revoke&&(user_info.is_manager||user_info.is_guest)){$(".qlOLPeople").text(C["users"])}}}function say_discuss(A){$("#loadNone").hide();var B='<dd class="comment_dd " msg_id="'+A.msg_id+'">';B+='<span class="right_info">';if(user_info.is_manager||user_info.is_guest){B+='<i class="btn_wall">上墙</i>'}B+='<i class="btn_like">0</i> <i class="btn_hate">0</i></span>';B+='<a class="avatar"><img src="'+A.headimg+'"></a><a class="author_name">'+A.from_client_name+"</a>";B+='<b class="time">'+A.time+"</b>";if(user_info.is_manager){B+='<i class="commentManage">管理<span class="commentManageTab" style="display:none;">';B+='<a class="delCommentMsg">删除</a><a class="shutUpSet">禁言</a></span></i>'}if(A.is_ask){A.content='<em class="ask_label">问</em>'+A.content}B+='<p class="content">'+convertEmotion(A.content)+"</p></dd>";$("#commentDl").prepend(B);if($("#common_num").size()>0){$("#common_num").text(parseInt($("#common_num").text())+1)}$(".commentContentBox").scrollTop(15);$(".btn_wall").unbind();$(".btn_wall").click(function(){var D=$(this).parents("dd").children(".author_name").text();var C=$(this).parents("dd").children(".content").text();if(C.indexOf("问")==0){C=C.replace("问","")}globalObj.Question={N:D,Q:C};$(".commentReplyBox").show()});$(".commentManage").unbind();$(".commentManage").click(function(){var C=$(this).children().css("display");if(C=="none"){$(this).children().show()}else{$(this).children().hide()}});$(".delCommentMsg").unbind();$(".delCommentMsg").click(function(){var E=confirm("确认要删除吗?");if(E){var D=$(this).parents("dd").attr("msg_id");var C=$(this).parents("dd");$.post(location.href,{msg_id:D,op:"del"},function(F){if(F.success==1){C.remove()}})}});$(".shutUpSet").unbind();$(".shutUpSet").click(function(){var E=confirm("确认要对此用户禁言吗?");if(E){var D=$(this).parents("dd").attr("msg_id");var C=$(this).parents("dd");$.post(location.href,{msg_id:D,op:"shutup"},function(F){if(F.success==1){alert(F.data)}})}});get_disdamu(A,"desc")}function say(F){F.revoke=F.uid==user_info.uid||user_info.is_manager?1:0;var G="";if(F.msgtype=="text"){G='<dd class="left_bubble hasTime" msg_id="'+F.msg_id+'" id="msg_'+F.msg_id+'">';G+='<div class="speak_time">'+F.time+"</div>";G+='<div class="head_portrait"><img src="'+F.headimg+'"></div>';G+='<div class="speaker_name"><b>'+F.from_client_name+"</b>"+F.role_name+"</div>";G+='<div class="bubble_content "><p>'+convertEmotion(F.content)+"</p></div>";if(F.revoke&&(user_info.is_manager||user_info.is_guest)){G+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){G+='<a class="btn_ilike" href="javascript:;">赏</a>'}G+="</dd>"}if(F.msgtype=="voice"){var A=getRecordClass(F.last);G='<dd class="left_bubble hasTime" msg_id="'+F.msg_id+'" id="msg_'+F.msg_id+'">';G+='<div class="speak_time">'+F.time+"</div>";G+='<div class="head_portrait"><img src="'+F.headimg+'"></div>';G+='<div class="speaker_name"><b>'+F.from_client_name+"</b>"+F.role_name+"</div>";G+='<div class="bubble_content recordingMsg '+A+'">';G+='<i class="audio_info" attr-src="'+F.content+'"></i><var>'+F.last+"</var></div>";if(F.revoke&&(user_info.is_manager||user_info.is_guest)){G+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){G+='<a class="btn_ilike" href="javascript:;">赏</a>'}G+="</dd>"}if(F.msgtype=="image"){G='<dd class="left_bubble hasTime" msg_id="'+F.msg_id+'" id="msg_'+F.msg_id+'">';G+='<div class="speak_time">'+F.time+"</div>";G+='<div class="head_portrait"><img src="'+F.headimg+'"></div>';G+='<div class="speaker_name"><b>'+F.from_client_name+"</b>"+F.role_name+"</div>";G+='<div class="bubble_content ">';G+='<img class="chat_img" mediaid="'+F.content+'" src="'+F.content+'"></div>';if(F.revoke&&(user_info.is_manager||user_info.is_guest)){G+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){G+='<a class="btn_ilike" href="javascript:;">赏</a>'}G+="</dd>"}if(F.msgtype=="ask"){try{var D=JSON.parse(unescape(F.content));G='<dd class="left_bubble hasTime" msg_id="'+F.msg_id+'" id="msg_'+F.msg_id+'">';G+='<div class="speak_time">'+F.time+"</div>";G+='<div class="head_portrait"><img src="'+F.headimg+'"></div>';G+='<div class="speaker_name"><b>'+F.from_client_name+"</b>"+F.role_name+"</div>";G+='<div class="bubble_content "><p><b>'+D.N+':</b><em class="ask_label">问</em>'+D.Q+"</p><p><b>回复:</b>"+D.replay+"</p></div>";if(F.revoke&&(user_info.is_manager||user_info.is_guest)){G+='<a class="btn_revoke" href="javascript:;"></a>'}if(topic_setting.reward_status==1){G+='<a class="btn_ilike" href="javascript:;">赏</a>'}G+="</dd>"}catch(B){G="";console.dir(B)}}if(F.msgtype=="reward"){try{var C=JSON.parse(unescape(F.content));G='<dt class="luckyMoney" msg_id="'+F.msg_id+'">';if(C.to_name){G+='<div class="lm_main" attr-imgurl="'+C.to_avatar+'" attr-money="'+C.money+'" attr-toname="'+C.to_name+'" from-name="'+F.from_client_name+'" from-avatar="'+F.headimg+'">';G+="<var>"+F.from_client_name+"</var> 赞赏了 <var>"+C.to_name+"</var> 一个<b>红包</b>"}else{G+='<div class="lm_main" attr-imgurl="'+C.to_avatar+'" attr-money="'+C.money+'" from-avatar="'+F.headimg+'">';G+=F.content_ext}G+="</div>";G+="</dt>"}catch(B){G="";console.dir(B)}}if(F.msgtype=="shutup"){if(F.content=="on"){G='<dt class="bubble_dt"><b>讨论区现在禁止发言</b></dt>';$(".commentBox").find(".comment_input_box").html('<b class="shutupbox">本直播当前为禁言状态</b>')}else{G='<dt class="bubble_dt"><b>讨论区现在允许发言</b></dt>';$(".commentBox").find(".comment_input_box").html('<b class="commentInput">来说点什么吧...</b>');$(".commentInput").unbind();$(".commentInput").click(function(){$(".commentBox").addClass("typing");$(".danmuBottom").show();$(".danmuBottom").css("max-height","25rem");$(".qlDanmuBg").show()})}}if(F.msgtype=="del"){var E=F.content;$("#msg_"+E).remove();G='<dt class="bubble_dt"><b>'+F.from_client_name+" 撤回了一条消息</b></dt>"}if(F.msgtype=="ppt"){set_swiper_obj(F);return}$("#speakBubbles").append(G);$(".speakContentBox").scrollTop($(".speakContentBox")[0].scrollHeight);if(F.msgtype=="voice"){voiceDown();if(!globalObj.isPlaying||globalObj.isPlaying==false){if(user_info.is_manager||user_info.is_guest){if(is_autoplay){$(".recordingMsg").last().click()}}else{$(".recordingMsg").last().click()}}}$(".chat_img").unbind();$(".chat_img").click(function(){if($.inArray($(this).attr("src"),globalObj.chat_images)==-1){globalObj.chat_images.push($(this).attr("src"))}wx.previewImage({current:$(this).attr("src"),urls:globalObj.chat_images})});reward();$(".btn_revoke").unbind();$(".btn_revoke").click(function(){var H=$(this).parents("dd").attr("msg_id");var I=confirm("确认撤销此消息吗？");if(!I){return}$.post(location.href,{msg_id:H,revoke:1},function(J){if(J.success==1){var K={type:"say",target:"main",msgtype:"del","from_client_name":user_info.nickname,content:H};sentContent(K)}})})}function scroll_func(){var C=$(this).scrollTop();var B=$(this)[0].scrollHeight;var A=$(this)[0].clientHeight;if(C+A+2>=B){if(page_object.sub_pindex<sub_pages){$(".btnLoadSpeakEnd").addClass("on");page_object.sub_pindex=page_object.sub_pindex+1;ajax_content(page_object.sub_pindex,"down",0)}}if(C<2){if(page_object.sub_pindex>1){$(".btnLoadSpeak").addClass("on");page_object.sub_pindex=page_object.sub_pindex-1;ajax_content(page_object.sub_pindex,"up",0)}}}$(function(){if(istopic_end==0){page_object.sub_pindex=page_object.sub_pages}ajax_content(page_object.sub_pindex,"down",1);ajax_discuss_content(page_object.com_pindex);$(".btn_ask").click(function(){$(this).toggleClass("on")});$("#btn_send").click(function(){var B=$(".speakInput").val();if(B==""){return}var A={type:"say",target:"main",msgtype:"text","from_client_name":user_info.nickname,headimg:avatar,content:B};sentContent(A);$(".speakInput").val("");$(".control_emojbox").removeClass("on")});$("#btnStartRec").click(function(){$(".rec_Title_box").hide();$(".tab_recordingType").hide();$(".btn_dd").addClass("startRec");$(".second_dd").show();wx.startRecord();startRec();$("#btnStopRec").show();clock_handler=setInterval(startRec,1000)});$("#btnStopRec").click(function(){clearInterval(clock_handler);$(".btn_dd").removeClass("startRec");$(".btn_dd").addClass("stopRec");$("#btnStopRec").hide();$("#btnSentRec").show();wx.stopRecord({success:function(A){current_voiclocalid=A.localId}})});$("#btnSentRec").click(function(){if(current_voiclocalid!=null){uploadVoic(current_voiclocalid)}$("#btnSentRec").hide();$(".btn_dd").removeClass("stopRec");$(".second_dd var").eq(0).text(0);$(".rec_Title_box").show();$(".tab_recordingType").show();$(".second_dd").hide()});$("#btnCancelRec").click(function(){$("#btnStopRec").click();current_voiclocalid==null;$("#btnSentRec").hide();$(".btn_dd").removeClass("stopRec");$(".second_dd var").eq(0).text(0);$(".rec_Title_box").show();$(".tab_recordingType").show();$(".second_dd").hide();clock_index=0});$(".btn_img").click(function(){wx.chooseImage({count:1,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(B){var A=B.localIds;var C=0,E=1;globalObj.localIds=A;function D(){var F=globalObj.localIds[C].toString();wx.uploadImage({localId:F,isShowProgressTips:1,success:function(G){var H=G.serverId;$.post(down_url,{"mid":H,"mtype":"image"},function(J){var I=J.data;var K={type:"say",target:"main",msgtype:"image","from_client_name":user_info.nickname,headimg:avatar,content:I};sentContent(K)});C++;if(C<1){D()}}})}D()}});return false});$(".commentContentBox").scroll(function(){var C=$(this).scrollTop();var B=$(this)[0].scrollHeight;var A=$(this)[0].clientHeight;if(C+A+1>=B){if(page_object.com_pindex<page_object.com_pages){page_object.com_pindex=page_object.com_pindex+1;$(".btnLoadComment ").addClass("on");ajax_discuss_content(page_object.com_pindex)}}});$(".speakContentBox").scroll(scroll_func);$(".btn_wall").click(function(){var B=$(this).parents("dd").children(".author_name").text();var A=$(this).parents("dd").children(".content").html();globalObj.Question={N:B,Q:A};$(".commentReplyBox").show()});$(".gene_cancel").click(function(){$(".geneBox").hide()});$(".commentManage").first().click(function(){var A=$(this).children().css("display");if(A=="none"){$(this).children().show()}else{$(this).children().hide()}});$(".commentReplyBox .gene_confirm").click(function(){var A=$(".commentReplyBox .reply_textarea").val();if(A==""){return}if(!globalObj.Question){return}globalObj.Question.replay=A;var B={type:"say",target:"main",msgtype:"ask",headimg:avatar,"from_client_name":user_info.nickname,content:JSON.stringify(globalObj.Question)};sentContent(B);$(".reply_textarea").val("");$(".commentReplyBox").hide()});$(".redbag_cancel").click(function(){$(".redbag_box").hide()});$("#allShutup").click(function(){$(this).toggleClass("swon");if($(this).hasClass("swon")){var A={type:"say",target:"main",msgtype:"shutup",headimg:avatar,content:"on"};sentContent(A)}else{var A={type:"say",target:"main",msgtype:"shutup",headimg:avatar,content:"off"};sentContent(A)}});$("#btnAutoPlay").click(function(){$(this).toggleClass("swon");if($(this).hasClass("swon")){is_autoplay=true}else{is_autoplay=false}})});$(function(){$(".btnBackVoice").click(function(){$(".speakBox").removeClass("textBottom");$(".speakBox").addClass("hasTabBottom")});$(".tabToComment,.write_dan_a,.commBtn").click(function(){$(".commentBox").show()});$(".backToLive").click(function(){$(".commentBox").hide()});$(".commentInput").click(function(){$(".commentBox").addClass("typing");$(".danmuBottom").show();$(".danmuBottom").css("max-height","25rem");$(".qlDanmuBg").show()});$(".btnCommentCancel").click(function(){$(".commentBox").removeClass("typing");$(".danmuBottom").hide();$(".danmuBottom").css("max-height","0rem");$(".qlDanmuBg").hide();$(".control_emojbox").removeClass("on")});$("#btn_discuss_send").click(function(){var C=$(".danmuInput").val();if(C==""){return}var B={type:"say",target:"discuss",msgtype:"text",headimg:avatar,"from_client_name":user_info.nickname,content:C};if($(".btn_ask").hasClass("on")){B.is_ask=true}sentContent(B);$(".danmuInput").val("");$(".btn_ask").removeClass("on");$(".control_emojbox").removeClass("on")});$(".isdan_btn_a").click(function(){$(".danmu_bar").toggleClass("on");if($(this).text()=="关"){$(this).text("弹")}else{$(this).text("关")}$(".danmuBox").toggle(500)});$(".btn_gtb_close").click(function(){$(".setGuestTips").hide()});$(".tab_others").click(function(){if(!$(".speakBox").hasClass("othersBottom")){$(".speakBox").removeClass("hasTabBottom")}else{$(".speakBox").addClass("hasTabBottom")}$(".speakBox").removeClass("textBottom");$(".speakBox").removeClass("voiceBottom");$(".speakBox").toggleClass("othersBottom")});$(".tab_text").click(function(){if(!$(".speakBox").hasClass("textBottom")){$(".speakBox").removeClass("hasTabBottom")}else{$(".speakBox").addClass("hasTabBottom")}$(".speakBox").removeClass("othersBottom");$(".speakBox").removeClass("voiceBottom");$(".speakBox").toggleClass("textBottom")});$(".tab_voice").click(function(){$(".speakBox").removeClass("othersBottom");$(".speakBox").removeClass("textBottom");if(!$(".speakBox").hasClass("voiceBottom")){$(".speakBox").removeClass("hasTabBottom")}else{$(".speakBox").addClass("hasTabBottom")}$(".speakBox").toggleClass("voiceBottom")});$(".btnControlBox").click(function(){$(".cbox_main").css("margin-bottom","0px");$(".control_box").addClass("on")});$(".btn_closeCBox").click(function(){$(".cbox_main").css("margin-bottom","-250px");$(".control_box").removeClass("on")});$(".close_elt").click(function(){$(".qlMsgTips").hide()});$(".btn_finish_live").click(function(){var B=$(this).attr("attr-topicid");var C=confirm("确定要结束吗?");if(C){$.post(topic_overurl,{topic_id:B},function(D){if(D.success==1){location.href=location.href+"&r=1"}else{alert(D.data)}})}});var A={obj:function(){return{sec:$("#sec"),mini:$("#mini"),hour:$("#hour"),day:$("#day")}}};if(!istopic_end&&istopic_begin==0){fnTimeCountDown(begin_time+"000",A.obj())}$(".start_remind").click(function(){$.post(location.href,{tips:true},function(B){if(B.success==1){$(document).minTipsBox({tipsContent:"设置成功",tipsTime:2});$(".start_remind").text("开播前将会提醒您")}else{$(document).minTipsBox({tipsContent:"已取消",tipsTime:2});$(".start_remind").text("点击设置开播提醒")}})});$(".gzBtn").click(function(B){$(".geneBox.focusQr2Box").show()});$(".geneBox.focusQr2Box").click(function(){$(".geneBox.focusQr2Box").hide()});$(".focusQr2Box .gene_content").click(function(B){stopEventBubble(B)});$(".tab_ppt").click(function(){$(".pptBox").show();$(".backSpeak").unbind();$(".backSpeak").click(function(){$(".pptBox").hide()})});$(".backSpeak").click(function(){$(".pptBox").hide()});$(".ppt_add").click(function(){wx.chooseImage({count:9,sizeType:["original","compressed"],sourceType:["album","camera"],success:function(C){var B=C.localIds;var D=0,F=1;function E(){var G=B[D].toString();wx.uploadImage({localId:G,isShowProgressTips:1,success:function(H){var I=H.serverId;$.post(down_url,{"mid":I,"mtype":"image","topic_id":user_info.topic_id,"up_type":"ppt"},function(K){var J=getPPtImgHtml(K);$(".pptList").append(J);D++;if(D<B.length){E()}if(D==B.length){init_fun_ppt()}})}})}E()}});return false});if($(".swiper-slide").size()>0){$(".slideT").show(0);$("body").removeClass("BdSwitch")}resetBtnPosition();if($(".swiper-container").size()>0){swiper=new Swiper(".swiper-container",{pagination:".swiper-pagination",paginationType:"fraction",speed:400,autoplayDisableOnInteraction:false,});$(".swiper-slide").each(function(){var B=$(this).children("img").attr("src");swiper_objs.push({id:$(this).attr("attr-id"),index:$(this).attr("attr-index"),img_url:B})});preview_pptimgs()}initEmotionUL();init_fun_ppt()});function preview_pptimgs(){var A=new Array();for(i=0;i<swiper_objs.length;i++){A.push(swiper_objs[i].img_url)}if(A.length<=0){return}$(".swiper-slide").unbind();$(".swiper-slide").click(function(){wx.previewImage({current:$(this).children("img").attr("src"),urls:A})})}function getPPtImgHtml(B){var A="";A+='<div class="pptItem" ppt-id="'+B.ppt_id+'" ppt-order="'+B.ppt_order+'">';A+='<div class="leftBox">';A+='<div class="imgBox"><img src="'+B.data+'"></div>';A+='<div class="state">';A+="</div>";A+='<div class="cancel"></div>';A+="</div>";A+='<div class="up"></div>';A+='<div class="down"></div>';A+='<div class="delBtn"></div>';A+="</div>";return A}var swiper=null;var swiper_objs=new Array();function init_fun_ppt(){$(".pptItem .delBtn").unbind();$(".pptItem .delBtn").click(function(){var D=confirm("确认删除此图片吗？");if(!D){return}var E=$(this).parents(".pptItem").attr("ppt-id");var C=location.href.replace("do=chat","do=ppt_ajax");var F=$(this).parents(".pptItem").attr("ppt-order");var A=$(this).parents(".pptItem");var B=A.find(".cancel").text()=="撤回";$.post(C,{op:"del",topic_id:user_info.topic_id,id:E},function(G){if(G.success==1){if(B){var H={type:"say",op:"cancel",target:"main",msgtype:"ppt",id:E,ppt_order:F};sentContent(H)}A.remove()}})});$(".pptItem .up,.pptItem .down").unbind();$(".pptItem .up,.pptItem .down").click(function(){var E=$(this).parents(".pptItem").attr("ppt-id");var B=$(this).parents(".pptItem").attr("ppt-order");var D=location.href.replace("do=chat","do=ppt_ajax");var F=$(this).attr("class");var J=$(this).parents(".pptItem").prevAll().size();var C=$(this).parents(".pptItem");var I=$(this).parents(".pptItem").prev();if(F=="down"){I=$(this).parents(".pptItem").next();J=$(this).parents(".pptItem").nextAll().size()+1}if(J==1){return}var A=I.attr("ppt-id");var H=I.attr("ppt-order");var G={op:F,topic_id:user_info.topic_id};G.id=E;G.order=H;G.id2=A;G.order2=B;$.post(D,G,function(K){if(K.success==1){if(F=="up"){C.insertBefore(I)}else{C.insertAfter(I)}}})});$(".pptItem .imgBox").unbind();$(".pptItem .imgBox").click(function(){var D=$(this).parents(".pptItem").attr("ppt-id");var E=$(this).parents(".pptItem").attr("ppt-order");var B=location.href.replace("do=chat","do=ppt_ajax");var A=$(this).children("img").attr("src");var C=$(this);$.post(B,{"op":"send",topic_id:user_info.topic_id,id:D},function(F){if(F.success==1){$(".pptItem").find(".state").text("");C.parents(".pptItem").find(".state").text("当前");C.parents(".pptItem").find(".cancel").text("撤回");$(".pptBox").hide();var G={type:"say",op:"set",target:"main",msgtype:"ppt",id:D,ppt_order:E,img_url:A};sentContent(G)}})});$(".pptItem .cancel").unbind();$(".pptItem .cancel").click(function(E){var B=confirm("确认撤销此图片吗?");if(!B){return}var F=$(this).parents(".pptItem").attr("ppt-id");var G=$(this).parents(".pptItem").attr("ppt-order");var C=location.href.replace("do=chat","do=ppt_ajax");var A=$(this).children("img").attr("src");var D=$(this);$.post(C,{"op":"c_send",topic_id:user_info.topic_id,id:F},function(H){if(H.success==1){D.parents(".pptItem").find(".state").text("");D.parents(".pptItem").find(".cancel").text("");var I={type:"say",op:"cancel",target:"main",msgtype:"ppt",id:F,ppt_order:G,img_url:A};sentContent(I)}});stopEventBubble(E)});$(".pptSwitch").click(function(){$(".slideT").toggle(0);$("body").toggleClass("BdSwitch");resetBtnPosition()})}function set_swiper_obj(C){if(swiper_objs.length==0){$(".slideT").show(0);$("body").removeClass("BdSwitch");if(swiper==null){swiper=new Swiper(".swiper-container",{pagination:".swiper-pagination",paginationType:"fraction",speed:400,autoplayDisableOnInteraction:false,})}}var B=false;for(i=0;i<swiper_objs.length;i++){if(swiper_objs[i].id==C.id){B=true;C.index=i;break}}if(!B){C.index=swiper_objs.length;swiper_objs.push(C);var A='<div class="swiper-slide" attr-id="';A+=C.id;A+='" attr-index="'+C.index+'" style="width:375px;">';A+='<img src="'+C.img_url+'" width="100%" />';A+="</div>";swiper.appendSlide(A);preview_pptimgs()}if(C.op=="cancel"){swiper.removeSlide(C.index);swiper_objs.splice(C.index,1);if(swiper_objs.length==0){$(".slideT").hide(0);$("body").addClass("BdSwitch");resetBtnPosition()}return}current_ppt_id=C.id;swiper.slideTo(C.index,100,false)}function resetBtnPosition(){if($("body").hasClass("BdSwitch")){$(".danmuBox").css({"top":"5rem","right":"4.4rem"});$(".pptBtn").css("top","5rem");$(".danmu_bar").css("top","0px")}else{$(".danmuBox").css({"top":"250px","right":"1rem"});$(".danmu_bar").css("top","200px");$(".pptBtn").css("top","0rem")}};