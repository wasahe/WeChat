<?php 

defined('IN_IA') or exit('Access Denied'); class Nihaoqkl_historyModuleSite extends WeModuleSite { public function doMobileIndex(){ global $_GPC,$_W; $pageindex = max(intval($_GPC['page']), 1); $pagesize = 8; $where = ' WHERE uniacid=:uniacid AND status = 1'; $params = array( ':uniacid'=>$_W['uniacid'] ); if(!$_GPC['cid']) { $sql = "select count(*) from ".tablename('addons_history_cate') . ' where uniacid='.$_W['uniacid']; $catecount = pdo_fetchcolumn($sql); if(!$catecount) { pdo_insert( 'addons_history_cate', array( 'uniacid'=>$_W['uniacid'], 'title'=>'默认分类', 'sort' =>0 ) ); } $cid = pdo_insertid(); } else { $cid = $_GPC['cid']; $where .= ' AND cid = :cid'; $params[':cid'] = $cid; } $sql = 'SELECT COUNT(*) FROM '.tablename('addons_history').$where; $total = pdo_fetchcolumn($sql, $params); $pager = pagination($total, $pageindex, $pagesize); $sql = 'SELECT * FROM '.tablename('addons_history')." {$where} ORDER BY create_time desc LIMIT ".(($pageindex -1) * $pagesize).','. $pagesize; $lists=pdo_fetchall($sql, $params); $mode = pdo_fetchcolumn("select mode from ". tablename('addons_history_mode') . ' where uniacid='.$_W['uniacid']); include $this->template('index'); } public function doMobileGetmore(){ global $_GPC,$_W; $pageindex = max(intval($_GPC['page']), 2); $pagesize = 8; $where = ' WHERE uniacid=:uniacid AND status = 1'; $params = array( ':uniacid'=>$_W['uniacid'] ); if( $_GPC['cid'] ) { $where .= ' AND cid = :cid'; $params[':cid'] = $_GPC['cid']; } $sql = 'SELECT COUNT(*) FROM '.tablename('addons_history').$where; $total = pdo_fetchcolumn($sql, $params); $totalpage=ceil($total / $pagesize); if($pageindex > $totalpage) { message(array('status'=>0,'data'=>'没有数据了'),'','ajax'); } $sql = 'SELECT * FROM '.tablename('addons_history')." {$where} ORDER BY create_time desc LIMIT ".(($pageindex -1) * $pagesize).','. $pagesize; $lists=pdo_fetchall($sql, $params); if($lists){ $html=''; $mode = pdo_fetchcolumn("select mode from ". tablename('addons_history_mode') . ' where uniacid='.$_W['uniacid']); foreach($lists as $key => $val) { if($mode){ $cover = '<p class="cover" style="background:url(/attachment/'.$val['cover'].')"></p>'; } else { $cover=''; } $html.= '<a href="'. $val['url'] .'">
                            <li class="history weui_cells_access">
                                <p class="time">'. date('Y年m月d日 H:i',$val['time']) .'</p>
                                <p class="title">'. $val['title'] .'</p>
                                '. $cover .'
                                <p class="summary">'. mb_substr(strip_tags(htmlspecialchars_decode($val['summary'])),0,50,'utf-8') .'</p>
                                <div class="weui_cell readme" style="border:0;padding:0;">
                                    <div class="weui_cell_bd weui_cell_primary">
                                        <p>阅读原文</p>
                                    </div>
                                    <div class="weui_cell_ft">
                                    </div>
                                </div>
                            </li>
                        </a>'; } message(array('status'=>1,'data'=>$html),'','ajax'); } else { message(array('status'=>0,'data'=>'没有数据了'),'','ajax'); } } public function doWebAdd(){ global $_W,$_GPC; $do = 'add'; if(checksubmit()){ $r=pdo_insert( 'addons_history', array( 'uniacid'=>$_W['uniacid'], 'title'=>$_GPC['title'], 'cid'=>$_GPC['cid'], 'summary'=>$_GPC['summary'], 'url'=>$_GPC['url'], 'cover'=>$_GPC['cover'], 'create_time'=>TIMESTAMP, 'update_time'=>TIMESTAMP, ) ); $r ? message('添加成功') : message('添加失败啦','','error'); } $sql = "select * from ".tablename('addons_history_cate') . ' where uniacid='.$_W['uniacid']; $cates = pdo_fetchall($sql); if(!$cates) { pdo_insert( 'addons_history_cate', array( 'uniacid'=>$_W['uniacid'], 'title'=>'默认分类', 'sort' =>0 ) ); } $cates = pdo_fetchall($sql); include $this->template('lists'); } public function doWebModify(){ global $_W,$_GPC; $do = 'modify'; if(checksubmit()){ $r=pdo_update( 'addons_history', array( 'title'=>$_GPC['title'], 'cid'=>$_GPC['cid'], 'summary'=>$_GPC['summary'], 'url'=>$_GPC['url'], 'cover'=>$_GPC['cover'], 'update_time'=>TIMESTAMP, ), array( 'id'=>$_GPC['id'] ) ); $r ? message('修改成功') : message('修改失败啦','','error'); } $info = pdo_fetch("select * from " . tablename('addons_history') . ' where id = :id',array(':id'=>$_GPC['id'])); $sql = "select * from ".tablename('addons_history_cate') . ' where uniacid='.$_W['uniacid']; $cates = pdo_fetchall($sql); include $this->template('lists'); } public function doWebDel(){ global $_GPC; $r=pdo_update( 'addons_history', array('status'=>0), array('id'=>$_GPC['id']) ); $r ? message('成功删除') : message('删除失败啦','','error'); } public function doWebLists(){ global $_GPC,$_W; $do = 'lists'; $pageindex = max(intval($_GPC['page']), 1); $pagesize = 15; $where = ' WHERE uniacid=:uniacid AND status = 1'; $params = array( ':uniacid'=>$_W['uniacid'] ); if (!empty($_GPC['title'])) { $where .= ' AND (`title` like :name )'; $params[':title'] = "%{$_GPC['title']}%"; } if (!empty($_GPC['id'])) { $where .= ' AND (id = :id)'; $params[':id'] = intval($_GPC['id']); } $sql = 'SELECT COUNT(*) FROM '.tablename('addons_history').$where; $total = pdo_fetchcolumn($sql, $params); $pager = pagination($total, $pageindex, $pagesize); $sql = 'SELECT * FROM '.tablename('addons_history')." {$where} ORDER BY create_time desc LIMIT ".(($pageindex -1) * $pagesize).','. $pagesize; $lists=pdo_fetchall($sql, $params); include $this->template('lists'); } public function doWebCate(){ global $_W,$_GPC; $do = 'cate'; $op = $_GPC['op']; if(!$op || $op == 'lists') { $pageindex = max(intval($_GPC['page']), 1); $pagesize = 15; $where = ' WHERE uniacid=:uniacid'; $params = array( ':uniacid'=>$_W['uniacid'] ); $sql = 'SELECT COUNT(*) FROM '.tablename('addons_history_cate').$where; $total = pdo_fetchcolumn($sql, $params); $pager = pagination($total, $pageindex, $pagesize); $sql = 'SELECT * FROM '.tablename('addons_history_cate')." {$where} ORDER BY id desc LIMIT ".(($pageindex -1) * $pagesize).','. $pagesize; $lists=pdo_fetchall($sql, $params); } if($op == 'add') { if(checksubmit()){ $r=pdo_insert( 'addons_history_cate', array( 'uniacid'=>$_W['uniacid'], 'keyword'=>$_GPC['keyword'], 'title'=>$_GPC['title'], 'sort'=>$_GPC['sort'] ) ); $r ? message('添加成功') : message('添加失败啦','','error'); } } if($op == 'modify') { $info = pdo_fetch("select * from " . tablename('addons_history_cate') . ' where id = :id',array(':id'=>$_GPC['id'])); if(checksubmit()){ if(!$info) message('不存在的分类','','error'); $r=pdo_update( 'addons_history_cate', array( 'uniacid'=>$_W['uniacid'], 'title'=>$_GPC['title'], 'sort'=>$_GPC['sort'] ), array('id'=>$_GPC['id']) ); $r ? message('修改成功') : message('修改失败 或 没有修改数据','','error'); } } if($op == 'del' ){ $sql = "select count(*) from ". tablename('addons_history') . ' where cid = :cid'; $count = pdo_fetchcolumn($sql , array(':cid' => $_GPC['id'] )); if( $count > 0) message('当前分类下有历史消息，无法删除','','error'); $r=pdo_delete( 'addons_history_cate', array('id'=>$_GPC['id']) ); $r ? message('成功删除') : message('删除失败啦','','error'); } include $this->template('lists'); } public function doWebSet(){ global $_W,$_GPC; $do = 'set'; if(checksubmit()){ $sql="select * from " . tablename('addons_history_mode') . ' where uniacid = ' .$_W['uniacid']; $result=pdo_fetch($sql); if(!$result){ $r=pdo_insert( 'addons_history_mode', array( 'mode'=>$_GPC['mode'], 'uniacid'=>$_W['uniacid'] ) ); } else { $r=pdo_update( 'addons_history_mode', array( 'mode'=>$_GPC['mode'] ), array( 'uniacid'=>$_W['uniacid'] ) ); } $r ? message('设置成功') : message('设置失败啦','','error'); } $mode = pdo_fetchcolumn("select mode from ". tablename('addons_history_mode') . ' where uniacid='.$_W['uniacid']); include $this->template('lists'); } }

?>