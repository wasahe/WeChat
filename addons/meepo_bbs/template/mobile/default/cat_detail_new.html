{template 'default/header'}
<link rel="stylesheet" href="{MODULE_URL}public/css/style.css" type="text/css" media="all">
<link rel="stylesheet" href="{MODULE_URL}public/css/index_vux.css" type="text/css" media="all">

<div class="bodyarea">
    <div class="wrap">
        <div class="headerarea">
            <header class="imui_header b_f bo_b po_fi">
                <div class="imui_hl tl imui_shl"><a href="javascript:history.back(-1)" class="imui_icon_back"></a></div>
                <div class="imui_hm tc imui_shm">
                    <a href="javascript:;" class="">{php echo $class['name']}</a>
                </div>
                <div class="imui_hr tr imui_shr">
                    <a href="javascript:openside()" class="imui_icon_side"></a>
                </div>
            </header>
        </div>
        <div class="mainarea">
            <div class="body_main" id="forum_61" onscroll="autopage(this)">
                <div class="imui_toparea" id="forumtop" style="display:none" >
                    <div class="b_f bo_bl foruminfo p10 cl">
                        <a href="javascript:" id="favbtn" onclick="favorite(61,'forum','c76475d3','favbtn')" class="b_c cf ding">订阅</a>
                        <img src="{php echo tomedia($class['icon'])}" class="l" />
                        <h3 class="size_18">{$class['name']}</h3>
                        <p class="cg">
                            {$class['theme_num']}主题
                            <em class="cg"></em>
                            {$class['topic_num']}帖子
                        </p>
                    </div>
                    <div class="b_f p15">
                        <div class="imui_topbox size_16">
                            <ul class="flex_box">
                                <li class="flex {if $_GPC['isnew'] == 1} b_c cf{/if}">
                                    <a href="{php echo $this->createMobileUrl('cat_detail_new',array('isnew'=>1,'typeid'=>$typeid))}" class="gettab" tab='forum_61'>
                                        最新
                                    </a>
                                </li>
                                <li class="flex {if $_GPC['ishot'] == 1} b_c cf{/if}" >
                                    <a href="{php echo $this->createMobileUrl('cat_detail_new',array('ishot'=>1,'typeid'=>$typeid))}" class="gettab" tab='forum_61'>
                                        热门
                                    </a>
                                </li>
                                <li class="flex {if $_GPC['isjing'] == 1} b_c cf{/if}" >
                                    <a href="{php echo $this->createMobileUrl('cat_detail_new',array('isjing'=>1,'typeid'=>$typeid))}" class="gettab" tab='forum_61'>
                                        精华
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
				{if !empty($navs)}
                <div class="imui_scrollx size_16 bo_b topnv">
                    <div class="imui_scrollx_area b_f">
                        <ul>
                            {loop $navs $nav}
                            <li class="size_18 {if $_GPC['typeid'] == $nav['typeid']}a{/if}">
                                <a href="{php echo $this->createMobileUrl('cat_detail_new',array('typeid'=>$nav['typeid']))}" class="gettab" tab='forum_61'>{$nav['name']}</a>
                            </li>
                            {/loop}
                        </ul>
                    </div>
                </div>
				{/if}
				{if !empty($hots['list'])}
                <div class="forumtopthread b_f mt10">
                    <ul>
                        {loop $hots['list'] $hot}
                        <li>
                            <span class="b_c cf"></span>
                            <a href="{php echo $this->createMobileUrl('detail_new',array('tid'=>$hot['id']))}" class="gettab" tab='viewthread'>{$hot['title']}</a>
                        </li>
                        {/loop}
                    </ul>
                </div>
				{/if}
                <table cellspacing="0" cellpadding="0" id="listtableid" class="threadlist mt10">
                    {if !empty($topics)}
                    {loop $topics['list'] $topic}
                    <tbody id="autolist_5687">
                    <tr>
                        <td>
                            <div class="listitem b_f">
                                <div class="onebigpic" onclick="goto('{php echo $this->createMobileUrl('detail_new',array('tid'=>$topic['id']))}','viewthread')">
                                    <div class="listuser cl">
                                        <img src="{php echo tomedia($topic['avatar'])}" class="author">
                                        <h3>
                                            <span class="cc r">
                                                #<a href="{php echo $this->createMobileUrl('cat_detail_new',array('typeid'=>$topic['fid']))}" class="gettab cc" tab="forum_52">{$topic['class']['name']}</a>
                                            </span>
                                            <a href="javascript:;" class="gettab user" tab="space">{$topic['nickname']}</a>
                                            <img src="{MODULE_URL}public/images/male.png" class="gender">
                                            <span class="cf b_c">{$topic['group']['title']}</span>
                                        </h3>
                                        <p class="cg">
                                            发表于
                                            <em>{php echo M('common')->format_create_time($topic['createtime'])}</em>
                                        </p>
                                    </div>
                                    <h3 class="smallsub">
                                        <span class="thread_ioc b_w cf size_14">悬赏</span>
                                        {$topic['title']}
                                    </h3>
                                    <div class="listpics">
                                        <ul class="cl ban">
                                            {loop $topic['thumb'] $thumb}
                                            <li><img src="{php echo tomedia($thumb)}"></li>
                                            {/loop}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                    {/loop}
                    {/if}
                    <tbody id="autolist_ad">
                    {php $adv = M('adv')->getOne();}
                    <tr>
                        <td>
                            <div class="adpage_guide">
                                <div class="adposition_bot">
                                    <p class="adimg">
                                        <a href="{php echo $adv['link']}">
                                            <img src="{php echo tomedia($adv['thumb'])}">
                                        </a>
                                        <span>{$adv['advname']}</span>
                                    </p>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <a href="javascript:;" class="autopbn cm b_d" rel="{php echo $this->createMobileUrl('cat_detail_new',array('typeid'=>$typeid,'page'=>2))}" curpage="1" id="autopbn" totalpage="2" tab="forum_61" history='' >点击加载更多</a>
            </div>
        </div>
        <div class="footerarea">
            <a href="{php echo $this->createMobileUrl('forum_post')}" class="gettab footerfastbtn size_16 cf" tab='post' >
                <span class="cc"></span>
                在{$class['name']}发帖
            </a>
        </div>
    </div>
</div>
<div id="modscript">
    <script language="javascript">
        var loadstatus = true;
        function autopage(obj,type){
            var autopbn = $('.body_main #autopbn');
            var nextpageurl = autopbn.attr('rel');
            var tab = autopbn.attr('tab');
            var history = autopbn.attr('history');
            var curpage = parseInt(autopbn.attr('curpage'));
            var totalpage = parseInt(autopbn.attr('totalpage'));
            var autopagenum = 100;
            var maxpage = (curpage + autopagenum) > totalpage ? totalpage : (curpage + autopagenum);

            if(type=='click'){
                getnextpagecontent();
            }else{
                if(autopagenum > 0) {
                    var curtop = $('#'+obj.id).scrollTop();

                    if(curtop + $('#'+obj.id).height() + 300 >= $('#'+obj.id)[0].scrollHeight && loadstatus) {
                        loadstatus = false;
                        autopbn.text('点击加载更多');

                        getnextpagecontent();
                    }
                }
            }
            function getnextpagecontent(){
                if(curpage + 1 > totalpage) {
                    $('#'+obj.id).unbind('scroll');
                    autopbn.css('display', 'none');
                    return;
                }
                curpage++;
                var url = nextpageurl + '&t=' + parseInt((+new Date()/1000)/(Math.random()*1000));
                $.ajax({
                    type : 'GET',
                    url : url,
                    dataType : 'html'
                }).success(function(s) {
                    s = s.replace(/\n|\r/g, '');
                    var tableobj = $('.body_main #listtableid');
                    tableobj.append(s);
                    autopbn.attr('rel',nextpageurl.replace(/&page=\d+/, '&page=' + (curpage + 1)))
                    autopbn.attr('curpage',curpage)
                    nextpageurl = nextpageurl.replace(/&page=\d+/, '&page=' + (curpage + 1));
                    if(!s) {
                        autopbn.css('display', 'none');
                    } else {
                        autopbn.text('点击加载更多');
                        if($('#'+obj.id+' #autolist_ad').length){
                            getad();
                        }
                    }
                    loadstatus = true;
                    if(history=='1'){
                        var state = {
                            url: url,
                            tabid: tab,
                            html: s
                        };
                        history.replaceState(state,null,url);
                    }
                });
            }
        }

        function getad(){
            $.ajax({
                type : 'GET',
                url : "{php echo $this->createMobileUrl('getadvs')}",
                dataType : 'html'
            }).success(function(s) {
                $('.body_main #listtableid').append(s);
            }).error(function() {
                return false;
            });
        }
    </script>
    <script language="javascript" id="script_threadaction" reload="1">

        function favorite(id,type,formhash,ins){
            var obj = $(this);
            $.ajax({
                type:'GET',
                url:'home.php?mod=spacecp&ac=favorite&type='+type+'&id='+id+'&formhash='+formhash+'&inajax=1&check=1',
                dataType:'xml',
            }).success(function(s) {

                if(s.lastChild.firstChild.nodeValue!='ok'){
                    popup.open(s.lastChild.firstChild.nodeValue,'html');
                }else{
                    if(type=='thread'){
                        var n=$('#'+ins).text();
                        if(n){
                            var favs=parseInt(n)+1;
                        }else{
                            var favs=1;
                        }
                        $('#'+ins).text(favs);
                    }else{
                        $('#'+ins).removeClass('b_c cf');
                        $('#'+ins).addClass('b_l cg');
                        $('#'+ins).text('已订阅');
                    }
                }
            }).error(function() {
                window.location.href = obj.attr('href');
                popup.close();
            });
            return false;
        }

        function recommend(tid,formhash,ins){
            var obj = $(this);
            $.ajax({
                type:'GET',
                url:'forum.php?mod=misc&action=recommend&do=add&tid='+tid+'&hash='+formhash+'&inajax=1&check=1',
                dataType:'xml',
            }).success(function(s) {
                if(s.lastChild.firstChild.nodeValue!='ok'){
                    popup.open(s.lastChild.firstChild.nodeValue,'html');
                }else{
                    var n=$('#'+ins).text();
                    if(n){
                        var recs=parseInt(n)+1;
                    }else{
                        var recs=1;
                    }
                    $('#'+ins).text(recs);
                    popup.close();
                }
            }).error(function() {
                window.location.href = obj.attr('href');
                popup.close();
            });
            return false;
        }
        evalscripts.push('script_threadaction');
    </script>
    <script language="javascript" id="script_topnv" reload="1">
        var topnavnavleft = $('.body_main .topnv li.a').position().left + 150 - document.body.clientWidth;
        if(topnavnavleft){
            $('.body_main .imui_scrollx_area').scrollLeft(topnavnavleft);
        }
        evalscripts.push('script_topnv');
    </script>
</div>
{template 'default/slider'}

<div class="imui_sidebg" onclick="openside();"></div><script language="javascript">
    var bodyheight=document.documentElement.clientHeight;
    $('body,.mainarea').css('height',bodyheight + 'px');
</script>
<a href="javascript:;" title="返回顶部" class="scrolltop"></a>
<div id="dark" style="display:none;"></div>
<div id="light" style="display:none;"></div>
<div id="windowarea"></div>
<a name="bot" id="bot"></a>
</body>
</html>