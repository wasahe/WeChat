<div id="site_title"><div class="title_name">发表帖子</div></div>
<div class="bodyarea">
    <div class="wrap">
        <div class="headerarea">
            <header class="imui_header b_c cf po_fi flex_box">
                <div class="imui_hl tl flex"><a href="javascript:closetab('post')" class="imui_icon_back"></a></div>
                <div class="imui_hm tc flex">
                    发帖
                </div>
                <div class="imui_hr flex">&nbsp;</div>
            </header>
        </div>

        <div class="mainarea">
            <div class="body_main body_0" id="post" hist="no">
                <div class="imui_scrollx size_16 bo_b topnv">
                    <div class="imui_scrollx_area b_f">
                        {template 'default/templates/forum/post_nav'}
                    </div>
                </div>
                <form method="post" id="threadpostform"action="">
                    <div class="imui_blocks b_f size_16">
                        <div class="imui_block">
                            <div class="imui_block_hd cg">标题</div>
                            <div class="imui_block_bd flex"><input type="text" class="imui_input" id="needsubject" value="" name="subject" placeholder="(必填)"></div>
                            <div class="imui_block_ft"></div>
                        </div>
                    </div>
                    <div class="imui_blocks b_f size_16">
                        <input type="hidden" name="selectsortid" value="1" />
                    </div>      <div class="imui_blocks_title cg">地区<em class="cc">*</em></div>
                    <div class="imui_blocks b_f imui_blocks_access size_16" onclick="calllinkpage('area')">
                        <div class="imui_block" id="alert_area">
                            <div class="imui_block_bd flex">
                                <p id="area_var"><em id="area_var_1"></em><em id="area_var_2"></em><em id="area_var_3"></em><em id="area_var_title">请选择</em></p>
                            </div>
                            <div class="imui_block_ft"></div>
                        </div>
                    </div>
                    <input type="hidden" name="typeoption[area]" value="" id="typeoption_area" />
                    <div class="showpagearea" id="select_area" style="display:none">
                        <div class="boxarea">
                            <header class="box_header b_c cf po_ab flex_box">
                                <div class="imui_bhl tl flex"><a href="javascript:calllinkpage('area')" class="imui_icon_back"></a></div>
                                <div class="imui_bhm tc flex">
                                    请选择地区        </div>
                                <div class="imui_bhr flex"></div>
                            </header>
                            <div class="box">
                                <div style="display: none">
                                    <ul id="dom_area_second_1"><li optionid="1.1">通州</li><li optionid="1.2">朝阳</li><li optionid="1.3">海淀</li></ul>
                                    <ul id="dom_area_second_2"><li optionid="2.1">汉口</li><li optionid="2.2">武昌</li><li optionid="2.3">汉阳</li></ul>
                                </div>
                                <div class="imui_blocks b_f imui_blocks_access size_16" id="area_back" onclick="backlinkpage('area')" style="display:none">
                                    <div class="imui_block">
                                        <div class="imui_block_bd flex">
                                            <p>返回上一级</p>
                                        </div>
                                        <div class="imui_block_ft"></div>
                                    </div>
                                </div>
                                <div id="select_area_first_area">
                                    <div class="imui_blocks b_f imui_blocks_radio size_16">
                                        <label class="imui_block imui_check_label" for="laber_area_1_first">
                                            <div class="imui_block_bd flex"><p>北京</p></div>
                                            <div class="imui_block_ft">
                                                <input type="radio" class="imui_check" name="false_area_first" id="laber_area_1_first" value="1" onclick="linkage(this.value,'area','second','北京')" />
                                                <span class="imui_icon_checked"></span>
                                            </div>
                                        </label>
                                        <label class="imui_block imui_check_label" for="laber_area_2_first">
                                            <div class="imui_block_bd flex"><p>武汉</p></div>
                                            <div class="imui_block_ft">
                                                <input type="radio" class="imui_check" name="false_area_first" id="laber_area_2_first" value="2" onclick="linkage(this.value,'area','second','武汉')" />
                                                <span class="imui_icon_checked"></span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                <div id="select_area_second_area"></div>
                                <div id="select_area_third_area"></div>
                            </div>
                        </div>
                    </div>
                    <div class="imui_blocks b_f size_16">  <div class="imui_block" id="alert_ads">
                        <div class="imui_block_hd">地址</div>
                        <div class="imui_block_bd flex"><input type="text" class="imui_input" id="typeoption_ads" onBlur="checkoption('ads', '0', 'text', '', '', '0')"  autocomplete="off" value=""  name="typeoption[ads]" ></div>
                        <div class="imui_block_ft"><span></span></div>
                    </div>
                        <div class="imui_block" id="alert_price">
                            <div class="imui_block_hd">租金</div>
                            <div class="imui_block_bd flex"><input type="number" class="imui_input" id="typeoption_price" onBlur="checkoption('price', '0', 'range', '0', '0', '')"  autocomplete="off" value=""  name="typeoption[price]" ></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block imui_block_select imui_select_after" id="alert_type">
                            <div class="imui_block_hd">户型</div>
                            <div class="imui_block_bd flex">
                                <select name="typeoption[type]" class="imui_select" onchange="checkoption('type', '0', 'select', '', '', '')" id="typeoption_type" >
                                    <option value="">请选择</option>
                                    <option value="1" >二室一厅</option>
                                    <option value="2" >三室一厅</option>
                                    <option value="3" >一室一厅</option>
                                </select>
                            </div>
                            <div class="imui_block_ft"></div>
                        </div>
                        <div class="imui_block" id="alert_size">
                            <div class="imui_block_hd">面积</div>
                            <div class="imui_block_bd flex"><input type="number" class="imui_input" id="typeoption_size" onBlur="checkoption('size', '0', 'number', '0', '0', '')"  autocomplete="off" value=""  name="typeoption[size]" ></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block" id="alert_flo">
                            <div class="imui_block_hd">层高<em class="cc">*</em></div>
                            <div class="imui_block_bd flex"><input type="number" class="imui_input" id="typeoption_flo" onBlur="checkoption('flo', '1', 'number', '0', '0', '')"  autocomplete="off" value=""  name="typeoption[flo]" ></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block imui_block_select imui_select_after" id="alert_zhuangxiu">
                            <div class="imui_block_hd">装修情况<em class="cc">*</em></div>
                            <div class="imui_block_bd flex">
                                <select name="typeoption[zhuangxiu]" class="imui_select" onchange="checkoption('zhuangxiu', '1', 'select', '', '', '')" id="typeoption_zhuangxiu" >
                                    <option value="">请选择</option>
                                    <option value="1" >豪装</option>
                                    <option value="2" >精装</option>
                                </select>
                            </div>
                            <div class="imui_block_ft"></div>
                        </div>
                    </div>  <div class="imui_blocks_title cg" id="alert_jiaju">室内家具<em class="cc">*</em></div>
                    <div class="imui_blocks b_f imui_blocks_checkbox size_16">
                        <label class="imui_block imui_check_label" for="label_jiaju_1">
                            <div class="imui_block_hd">
                                <input type="checkbox" class="imui_check" name="typeoption[jiaju][]" onclick="checkoption('jiaju', '1', 'checkbox', '', '', '')" id="label_jiaju_1" value="1"  >
                                <i class="imui_icon_checked"></i>
                            </div>
                            <div class="imui_block_bd flex">
                                <p>齐全</p>
                            </div>
                        </label>
                        <label class="imui_block imui_check_label" for="label_jiaju_2">
                            <div class="imui_block_hd">
                                <input type="checkbox" class="imui_check" name="typeoption[jiaju][]" onclick="checkoption('jiaju', '1', 'checkbox', '', '', '')" id="label_jiaju_2" value="2"  >
                                <i class="imui_icon_checked"></i>
                            </div>
                            <div class="imui_block_bd flex">
                                <p>无</p>
                            </div>
                        </label>
                    </div>
                    <div class="imui_blocks b_f size_16">    <div class="imui_block imui_block_upfile" id="alert_pic">
                        <div class="imui_block_hd"><img src="template/cis_app/touch/style/v.png" id="sortattach_image_pic"></div>
                        <div class="imui_block_bd flex">照片<em class="cc">*</em></div>
                        <div class="imui_block_ft"><input type="file" value="" id="pic" onchange="uploadfile(this)" alt="sort"  /></div>
                    </div>
                        <input type="hidden" name="typeoption[pic][aid]" value="" id="sortaid_pic" />
                        <input type="hidden" name="sortaid_pic_url" id="sortaid_pic_url" />
                        <input type="hidden" name="oldsortaid[pic]" value="" />  <input type="hidden" name="typeoption[pic][url]" id="sortattachurl_pic" value="template/cis_app/touch/style/v.png"  />
                        <div class="imui_block" id="alert_tel">
                            <div class="imui_block_hd">联系电话<em class="cc">*</em></div>
                            <div class="imui_block_bd flex"><input type="number" class="imui_input" id="typeoption_tel" onBlur="checkoption('tel', '1', 'number', '0', '0', '')"  autocomplete="off" value=""  name="typeoption[tel]" ></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block" id="alert_name">
                            <div class="imui_block_hd">联系人</div>
                            <div class="imui_block_bd flex"><input type="text" class="imui_input" id="typeoption_name" onBlur="checkoption('name', '0', 'text', '', '', '0')"  autocomplete="off" value=""  name="typeoption[name]" ></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                    </div>
                    <div class="imui_blocks_title cg">内容</div>
                    <div class="imui_blocks b_f size_16">
                        <div class="imui_block">
                            <div class="imui_block_bd flex">
                                <textarea class="imui_textarea autoheight" id="postmessage" name="message" placeholder="内容(必填)" rows="3" ></textarea>
                            </div>
                        </div>
                    </div>
                    {template 'default/templates/forum/post_common'}
                </form>
            </div>
        </div>
        <div class="footerarea"></div>
    </div>
</div>
<div id="modscript">
    <script src="{MODULE_URL}public/js/ajaxfileupload.js" type="text/javascript" id="script_ajaxfileupload"></script>
    <script src="{MODULE_URL}public/js/buildfileupload.js" type="text/javascript" id="script_buildfileupload"></script>
    <script type="text/javascript" id="script_upload" reload="1">
        var imgexts = typeof imgexts == 'undefined' ? 'jpg, jpeg, gif, png' : imgexts;
        var STATUSMSG = {
            '-1' : '内部服务器错误',
            '0' : '上传成功',
            '1' : '不支持此类扩展名',
            '2' : '服务器限制无法上传那么大的附件',
            '3' : '用户组限制无法上传那么大的附件',
            '4' : '不支持此类扩展名',
            '5' : '文件类型限制无法上传那么大的附件',
            '6' : '今日您已无法上传更多的附件',
            '7' : '请选择图片文件(' + imgexts + ')',
            '8' : '附件文件无法保存',
            '9' : '没有合法的文件被上传',
            '10' : '非法操作',
            '11' : '今日您已无法上传那么大的附件'
        };
        function uploadfile(the){
            var obj=$('#'+the.id);
            popup.open('<img src="' + IMGDIR + '/imageloading.gif">');
            if(obj.attr('alt')=='poll'){
            }else{
                uploadsuccess = function(data) {
                    if(data == '') {
                        popup.open('上传失败，请稍后再试', 'alert');
                    }
                    if(obj.attr('alt')=='album' || obj.attr('alt')=='blog'){
                        var dataarr = eval('('+data+')');
                        popup.close();
                        if(obj.attr('alt')=='album'){
                            $('#imglist').append('<li><span picid="'+dataarr['picid']+'" class="del" onclick="deletepic(this)" id="'+dataarr['picid']+'" alt="album"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr['picid']+'" title="'+dataarr['picid']+'" src="'+dataarr['bigimg']+'" /></a></span><input type="hidden" name="title['+dataarr['picid']+']" /></li>');
                        }else{
                            $('#imglist').append('<li><span picid="'+dataarr['picid']+'" class="del" onclick="deletepic(this)" id="'+dataarr['picid']+'" alt="album"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr['picid']+'" title="'+dataarr['picid']+'" src="'+dataarr['bigimg']+'" /></a></span><input type="hidden" name="picids['+dataarr['picid']+']" value="'+dataarr['picid']+'" /></li>');
                        }
                    }else{

                        var dataarr = data.split('|');
                        if(dataarr[0] == 'DISCUZUPLOAD' && dataarr[2] == 0) {
                            popup.close();

                            if(obj.attr('alt')=='sort'){
                                var id=$('.upfile').attr('alt');
                                $('#sortattach_image_'+obj.attr('id')).attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#sortaid_'+obj.attr('id')).val(dataarr[3]);
                                $('#sortaid_'+obj.attr('id')+'_url').val('data/attachment/forum/'+dataarr[5]);
                                $('#sortattachurl_'+obj.attr('id')).val('data/attachment/forum/'+dataarr[5]);
                                $('#alert_'+obj.attr('id')).removeClass('cc');
                            }else if(obj.attr('alt')=='trade'){
                                $('#trade_image').attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#tradeaid').val(dataarr[3]);
                                $('#tradeaid_url').val(dataarr[5]);

                            }else if(obj.attr('alt')=='act'){
                                $('#act_image').attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#activityaid').val(dataarr[3]);
                                $('#activityaid_url').val(dataarr[5]);
                            }else{
                                $('#imglist').append('<li><span aid="'+dataarr[3]+'" class="del" onclick="deletepic(this)" id="'+dataarr[3]+'"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr[3]+'" title="'+dataarr[6]+'" src="data/attachment/forum/'+dataarr[5]+'" /></a></span><input type="hidden" name="attachnew['+dataarr[3]+'][description]" /></li>');
                            }

                        } else {
                            var sizelimit = '';
                            if(dataarr[7] == 'ban') {
                                sizelimit = '(附件类型被禁止)';
                            } else if(dataarr[7] == 'perday') {
                                sizelimit = '(不能超过'+Math.ceil(dataarr[8]/1024)+'K)';
                            } else if(dataarr[7] > 0) {
                                sizelimit = '(不能超过'+Math.ceil(dataarr[7]/1024)+'K)';
                            }
                            popup.open(STATUSMSG[dataarr[2]] + sizelimit, 'alert');
                        }
                    }
                }

                if(obj.attr('alt')=='album' || obj.attr('alt')=='blog'){
                    var upurl='misc.php?mod=swfupload&action=swfupload&operation=album&type=image&inajax=yes&infloat=yes';
                }else{
                    var upurl='misc.php?mod=swfupload&operation=upload&type=image&inajax=yes&infloat=yes&simple=2';
                }

                if(typeof FileReader != 'undefined' && the.files[0]) {
                    for (var i=0;i<the.files.length;i++){
                        $.buildfileupload({
                            uploadurl:upurl,
                            file:the.files[i],
                            uploadformdata:{uid:"4799", hash:"970b6084f5b81906a315d5a1325afa07"},
                            uploadinputname:'Filedata',
                            maxfilesize:"51200",
                            success:uploadsuccess,
                            error:function() {
                                popup.open('上传失败，请稍后再试', 'alert');
                            }
                        });
                    }
                } else {
                    $.ajaxfileupload({
                        url:upurl,
                        data:{uid:"4799", hash:"970b6084f5b81906a315d5a1325afa07"},
                        dataType:'text',
                        fileElementId:the.id,
                        success:uploadsuccess,
                        error: function() {
                            popup.open('上传失败，请稍后再试', 'alert');
                        }
                    });
                }
            }

        }
        function deletepic(the){

            obj=$('#'+the.id);
            if(obj.alt=='album'){
                var deleteurl='home.php?mod=spacecp&ac=album&op=editpic&albumid=-1&subop=delete&editpicsubmit=true&inajax=yes&formhash=c76475d3&ids[]=' + obj.attr('picid');
                var ajaxtype='POST';
            }else{
                var deleteurl='forum.php?mod=ajax&action=deleteattach&pid=&inajax=yes&aids[]=' + obj.attr('aid');
                var ajaxtype='GET';
            }
            alert(the.id);
            $.ajax({
                type:ajaxtype,
                url:deleteurl,
            })
                    .success(function(s) {
                        obj.parent().remove();
                    })
                    .error(function() {
                        popup.open('网络出现问题，请稍后再试', 'alert');
                    });
            return false;
        }

    </script>  <script type="text/javascript" id="script_addthread" reload="1">

    (function() {
        var needsubject = needmessage = false;


        $('#needsubject').on('keyup input', function() {
            var obj = $(this);
            if(obj.val()) {
                needsubject = true;
                if(needmessage == true) {
                    $('.imui_btn').removeClass('cg').addClass('cf');
                    $('#postsubmit').removeAttr("disabled");
                }
            } else {
                needsubject = false;
                $('.imui_btn').removeClass('cf').addClass('cg');
                $('#postsubmit').attrattr('disabled',"true");
            }
        });
        $('#postmessage').on('keyup input', function() {
            var obj = $(this);
            if(obj.val()) {
                needmessage = true;
                if(needsubject == true) {
                    $('.imui_btn').removeClass('cg').addClass('cf');
                    $('#postsubmit').removeAttr("disabled");
                }
            } else {
                needmessage = false;
                $('.imui_btn').removeClass('cf').addClass('cg');
                $('#postsubmit').attr('disabled',"true");
            }
        });

    })();

    /*tag*/
    function cnCode(str) {
        str = str.replace(/<\/?[^>]+>|\[\/?.+?\]|"/ig, "");
        str = str.replace(/\s{2,}/ig, ' ');
        return str;
    }
    function relatekw(subject,message) {

        if(isUndefined(subject) || subject == -1) {
            subject = cnCode(document.getElementById('needsubject').value);
        }
        if(isUndefined(message) || message == -1) {
            message = cnCode(document.getElementById('postmessage').value);
        }
        message = message.replace(/&/ig, '', message).substr(0, 500);

        $.ajax({
            type:'GET',
            url:'forum.php?mod=relatekw&form=mobile&subjectenc=' + subject + '&messageenc=' + message,
            dataType:'xml',
        })
                .success(function(s) {
                    $("#tags").val(s.lastChild.firstChild.nodeValue);
                })
                .error(function() {
                    return false;
                });
    }


    $('#postsubmit').on('click', function() {
        var obj = $(this);
        var form=$('#threadpostform');
        //obj.attr('disabled',"true").removeClass('cf').addClass('cg');
        popup.open('<img src="' + IMGDIR + '/imageloading.gif">');

        var postlocation = '';
        if(geo.errmsg === '' && geo.loc) {
            postlocation = geo.longitude + '|' + geo.latitude + '|' + geo.loc;
        }

        if(!checkoption('area', '1', 'select', '', '', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('ads', '0', 'text', '', '', '0')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('price', '0', 'range', '0', '0', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('type', '0', 'select', '', '', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('size', '0', 'number', '0', '0', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('flo', '1', 'number', '0', '0', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('zhuangxiu', '1', 'select', '', '', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('jiaju', '1', 'checkbox', '', '', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('pic', '1', 'image', '', '', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('tel', '1', 'number', '0', '0', '')){
            var stopaction=1;
            popup.close();
        }
        if(!checkoption('name', '0', 'text', '', '', '0')){
            var stopaction=1;
            popup.close();
        }
        if(stopaction=='1'){return false;}

        $.ajax({
            type:'POST',
            url:form.attr('action') + '&geoloc=' + postlocation + '&handlekey='+form.attr('id')+'&inajax=1',
            data:form.serialize(),
            dataType:'xml'
        })
                .success(function(s) {
                    evalscript(s.lastChild.firstChild.nodeValue);
                })
                .error(function() {
                    popup.open('网络出现问题，请稍后再试', 'alert');
                });
        return false;
    });

    function succeedhandle_threadpostform(locationhref, message, param) {
        var tid = param['tid'];
        goto('forum.php?mod=viewthread&tid='+tid,'viewthread');
    }
    function errorhandle_threadpostform(message, param) {
        popup.open(message, 'alert');
    }
</script>
    <script language="javascript" id="script_checkoption">
        function mb_strlen(str) {
            var len = 0;
            for(var i = 0; i < str.length; i++) {
                len += str.charCodeAt(i) < 0 || str.charCodeAt(i) > 255 ? (charset == 'utf-8' ? 3 : 2) : 1;
            }
            return len;
        }
        function checkoption(identifier, required, checktype, checkmaxnum, checkminnum, checkmaxlength) {

            if(checktype == 'image') {
                var checkvalue = $('#sortaid_' + identifier).val();
            }
            if(checktype == 'radio'){
                var checkvalue = $('input[name="typeoption['+identifier+']"]:checked').val();
            }
            if(checktype == 'select' | checktype == 'calendar' || checktype == 'number' || checktype == 'text' || checktype == 'email' || checktype == 'url' || checktype == 'range' || checktype == 'textarea'){
                var checkvalue = $('#typeoption_' + identifier).val();
            }
            if(checktype == 'checkbox'){
                var checkvalue='';
                $('input[name="typeoption[c_checkbox][]"]:checked').each(function(){
                    checkvalue+=this.value + ',';
                });
            }
            /*----------*/
            if(required && !checkvalue){
                $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('必填项目没有填写','alert');
                return false;
            }else{
                if(checktype == 'email' && !(/^[\-\.\w]+@[\.\-\w]+(\.\w+)+$/.test(checkvalue))){
                    $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('邮件地址不正确','alert');
                    return false;
                } else if((checktype == 'text' || checktype == 'textarea') && checkmaxlength != '0' && mb_strlen(checkvalue) > checkmaxlength) {
                    $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('填写项目长度过长','alert');
                    return false;
                } else if((checktype == 'number' || checktype == 'range')) {
                    if(isNaN(checkvalue)) {
                        $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('数字填写不正确','alert');
                        return false;
                    } else if(checkmaxnum != '0' && parseInt(checkvalue) > parseInt(checkmaxnum)) {
                        $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('大于设置最大值','alert');
                        return false;
                    } else if(checkminnum != '0' && parseInt(checkvalue) < parseInt(checkminnum)) {
                        $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('小于设置最小值','alert');
                        return false;
                    }else{
                        $('#alert_'+identifier).removeClass('cc');
                        return true;
                    }
                } else if(checktype == 'url' && !(/(http[s]?|ftp):\/\/[^\/\.]+?\..+\w[\/]?$/i.test(checkvalue))) {
                    $('#alert_'+identifier).removeClass('cg').addClass('cc');
//popup.open('请正确填写以http://开头的URL地址','alert');
                    return false;
                }else{
                    $('#alert_'+identifier).removeClass('cc');
                    return true;
                }
            }
        }
    </script>  </div>