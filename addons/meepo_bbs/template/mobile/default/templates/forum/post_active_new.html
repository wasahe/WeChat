<div id="site_title"><div class="title_name">发表帖子 - 发帖体验 - IMMWA-APP演示站</div></div>
<div class="bodyarea">
    <div class="wrap">
        <div class="headerarea">
            <header class="imui_header b_c cf po_fi flex_box">
                <div class="imui_hl tl flex"><a href="javascript:closetab('post')" class="imui_icon_back"></a></div>
                <div class="imui_hm tc flex">
                    发帖        </div>
                <div class="imui_hr flex">&nbsp;</div>
            </header>
        </div>

        <div class="mainarea">
            <div class="body_main body_0" id="post" hist="no">
                <div class="imui_scrollx size_16 bo_b topnv">
                    <div class="imui_scrollx_area b_f">
                        {template 'default/templates/forum/post_nav'}
                    </div>
                </div>
                <form method="post" id="threadpostform"
                      action="forum.php?mod=post&amp;action=newthread&amp;fid=154&amp;extra=&amp;topicsubmit=yes&amp;mobile=2"
                >
                    <input type="hidden" name="formhash" id="formhash" value="c76475d3" />
                    <input type="hidden" name="posttime" id="posttime" value="1465855868" />
                    <input type="hidden" name="special" value="4" />

                    <input type="hidden" name="adddynamic" value="true">
                    <input type="hidden" name="tab" value="viewthread" />
                    <div class="imui_blocks b_f size_16">
                        <div class="imui_block">
                            <div class="imui_block_hd cg">标题</div>
                            <div class="imui_block_bd flex"><input type="text" class="imui_input" id="needsubject" value="" name="subject" placeholder="(必填)"></div>
                            <div class="imui_block_ft"></div>
                        </div>
                    </div>
                    <div class="imui_blocks_title cg">设置活动信息</div>
                    <div class="imui_blocks b_f size_16">

                        <div class="imui_block imui_block_select imui_select_after">
                            <div class="imui_block_hd cg">活动类别<em class="cc">*</em></div>
                            <div class="imui_block_bd flex">
                                <select name="activityclass" id="activityclass" class="imui_select">
                                    <option value="">请选择</option>
                                    <option value="朋友聚会" >朋友聚会</option>
                                    <option value="出外郊游" >出外郊游</option>
                                    <option value="自驾出行" >自驾出行</option>
                                    <option value="公益活动" >公益活动</option>
                                    <option value="线上活动" >线上活动</option>
                                </select>
                            </div>
                        </div>
                        <div class="imui_block imui_block_select">
                            <div class="imui_block_bd flex">
                                <select name="activitytime" id="activitytime" class="imui_select" onChange="if(this.value=='1') {document.getElementById('certainstarttime').style.display='none';document.getElementById('uncertainstarttime').style.display='';} else {document.getElementById('certainstarttime').style.display='';document.getElementById('uncertainstarttime').style.display='none';}">
                                    <option value="0" selected>时间范围</option>
                                    <option value="1" >确切时间</option>
                                </select>
                            </div>
                        </div>
                        <div class="imui_block" id="certainstarttime" >
                            <div class="imui_block_hd cg">活动时间<em class="cc">*</em></div>
                            <div class="imui_block_bd flex"><input class="imui_input"  type="datetime-local" value="" onchange="settime(this.value,'starttimefrom_0')"><input type="hidden"name="starttimefrom[0]" value="" id="starttimefrom_0"/></div>
                            <div class="imui_block_ft"></div>
                        </div>
                        <div id="uncertainstarttime" class="bo_tl" style="display:none">
                            <div class="imui_block">
                                <div class="imui_block_hd cg">起始时间<em class="cc">*</em></div>
                                <div class="imui_block_bd flex"><input class="imui_input" name="starttimefrom[1]" type="datetime-local" value="" onchange="settime(this.value,'starttimefrom_1')"><input type="hidden"name="starttimefrom[1]" value="" id="starttimefrom_1"/></div>
                                <div class="imui_block_ft"></div>
                            </div>
                            <div class="imui_block">
                                <div class="imui_block_hd cg">截止时间<em class="cc">*</em></div>
                                <div class="imui_block_bd flex"><input class="imui_input" name="starttimeto" type="datetime-local" value="" onchange="settime(this.value,'starttimeto')"><input type="hidden" name="starttimeto" value="" id="starttimeto"/></div>
                                <div class="imui_block_ft"></div>
                            </div>
                        </div>
                        <div class="imui_block">
                            <div class="imui_block_hd cg">所在城市</div>
                            <div class="imui_block_bd flex"><input name="activitycity" id="activitycity" type="text" class="imui_input" /></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block">
                            <div class="imui_block_hd cg">活动地点<em class="cc">*</em></div>
                            <div class="imui_block_bd flex"><input type="text" name="activityplace" id="activityplace" value="" class="imui_input" /></div>
                            <div class="imui_block_ft"><span></span></div>
                        </div>
                        <div class="imui_block imui_block_select imui_select_before">
                            <div class="imui_block_hd">
                                <select name="gender" id="gender" class="imui_select">
                                    <option value="0" selected="selected">不限</option>
                                    <option value="1" >男</option>
                                    <option value="2" >女</option>
                                </select>
                            </div>
                            <div class="imui_block_bd flex">
                                <input type="text" name="activitynumber" id="activitynumber"value="" class="imui_input" placeholder="需要人数" />
                            </div>
                            <div class="imui_block_ft"><span>人</span></div>
                        </div>
                        <div class="imui_block">
                            <div class="imui_block_hd cg">报名消耗</div>
                            <div class="imui_block_bd flex"><input type="text" name="activitycredit" id="activitycredit" value=""  class="imui_input"/></div>
                            <div class="imui_block_ft"><span>威望</span></div>
                        </div>
                        <div class="imui_block">
                            <div class="imui_block_hd cg">每人花销</div>
                            <div class="imui_block_bd flex"><input type="text" name="cost" id="cost" value="" class="imui_input"/></div>
                            <div class="imui_block_ft"><span>元</span></div>
                        </div>
                        <div class="imui_block imui_block_upfile">
                            <div class="imui_block_hd"><img src="template/cis_app/touch/style/v.png" id="act_image"></div>
                            <div class="imui_block_bd flex cg">活动图片</div>
                            <div class="imui_block_ft"><input type="file" value="" class="upfile" alt="act" onchange="uploadfile(this)" id="tradefile" name="Filedata"/></div>
                        </div>
                        <input type="hidden" name="activityaid" id="activityaid" />
                        <input type="hidden" name="activityaid_url" id="activityaid_url" />
                    </div>
                    <div class="imui_blocks_title cg">必填资料项</div>
                    <div class="imui_blocks b_f imui_blocks_checkbox size_16">
                        <label class="imui_block imui_check_label" for="userfield_realname">
                            <div class="imui_block_hd">
                                <input type="checkbox" name="userfield[]" id="userfield_realname" value="realname"  class="imui_check" />
                                <i class="imui_icon_checked"></i>
                            </div>
                            <div class="imui_block_bd flex">
                                <p>真实姓名</p>
                            </div>
                        </label>
                        <label class="imui_block imui_check_label" for="userfield_mobile">
                            <div class="imui_block_hd">
                                <input type="checkbox" name="userfield[]" id="userfield_mobile" value="mobile"  class="imui_check" />
                                <i class="imui_icon_checked"></i>
                            </div>
                            <div class="imui_block_bd flex">
                                <p>手机</p>
                            </div>
                        </label>
                        <label class="imui_block imui_check_label" for="userfield_qq">
                            <div class="imui_block_hd">
                                <input type="checkbox" name="userfield[]" id="userfield_qq" value="qq"  class="imui_check" />
                                <i class="imui_icon_checked"></i>
                            </div>
                            <div class="imui_block_bd flex">
                                <p>QQ</p>
                            </div>
                        </label>
                    </div>
                    <div class="imui_blocks_title cg">内容</div>
                    <div class="imui_blocks b_f size_16">
                        <div class="imui_block">
                            <div class="imui_block_bd flex">
                                <textarea class="imui_textarea autoheight" id="postmessage" name="message" placeholder="内容(必填)" rows="3" ></textarea>
                            </div>
                        </div>
                    </div>

                    {template 'default/templates/forum/post_common'}
                </form>
            </div>
        </div>
        <div class="footerarea"></div>
    </div>
</div>
<div id="modscript">
    <script src="{MODULE_URL}public/js/ajaxfileupload.js" type="text/javascript" id="script_ajaxfileupload"></script>
    <script src="{MODULE_URL}public/js/buildfileupload.js" type="text/javascript" id="script_buildfileupload"></script>
    <script type="text/javascript" id="script_upload" reload="1">
        var imgexts = typeof imgexts == 'undefined' ? 'jpg, jpeg, gif, png' : imgexts;
        var STATUSMSG = {
            '-1' : '内部服务器错误',
            '0' : '上传成功',
            '1' : '不支持此类扩展名',
            '2' : '服务器限制无法上传那么大的附件',
            '3' : '用户组限制无法上传那么大的附件',
            '4' : '不支持此类扩展名',
            '5' : '文件类型限制无法上传那么大的附件',
            '6' : '今日您已无法上传更多的附件',
            '7' : '请选择图片文件(' + imgexts + ')',
            '8' : '附件文件无法保存',
            '9' : '没有合法的文件被上传',
            '10' : '非法操作',
            '11' : '今日您已无法上传那么大的附件'
        };
        function uploadfile(the){
            var obj=$('#'+the.id);
            popup.open('<img src="' + IMGDIR + '/imageloading.gif">');
            if(obj.attr('alt')=='poll'){
            }else{
                uploadsuccess = function(data) {
                    if(data == '') {
                        popup.open('上传失败，请稍后再试', 'alert');
                    }
                    if(obj.attr('alt')=='album' || obj.attr('alt')=='blog'){
                        var dataarr = eval('('+data+')');
                        popup.close();
                        if(obj.attr('alt')=='album'){
                            $('#imglist').append('<li><span picid="'+dataarr['picid']+'" class="del" onclick="deletepic(this)" id="'+dataarr['picid']+'" alt="album"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr['picid']+'" title="'+dataarr['picid']+'" src="'+dataarr['bigimg']+'" /></a></span><input type="hidden" name="title['+dataarr['picid']+']" /></li>');
                        }else{
                            $('#imglist').append('<li><span picid="'+dataarr['picid']+'" class="del" onclick="deletepic(this)" id="'+dataarr['picid']+'" alt="album"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr['picid']+'" title="'+dataarr['picid']+'" src="'+dataarr['bigimg']+'" /></a></span><input type="hidden" name="picids['+dataarr['picid']+']" value="'+dataarr['picid']+'" /></li>');
                        }
                    }else{

                        var dataarr = data.split('|');
                        if(dataarr[0] == 'DISCUZUPLOAD' && dataarr[2] == 0) {
                            popup.close();

                            if(obj.attr('alt')=='sort'){
                                var id=$('.upfile').attr('alt');
                                $('#sortattach_image_'+obj.attr('id')).attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#sortaid_'+obj.attr('id')).val(dataarr[3]);
                                $('#sortaid_'+obj.attr('id')+'_url').val('data/attachment/forum/'+dataarr[5]);
                                $('#sortattachurl_'+obj.attr('id')).val('data/attachment/forum/'+dataarr[5]);
                                $('#alert_'+obj.attr('id')).removeClass('cc');
                            }else if(obj.attr('alt')=='trade'){
                                $('#trade_image').attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#tradeaid').val(dataarr[3]);
                                $('#tradeaid_url').val(dataarr[5]);

                            }else if(obj.attr('alt')=='act'){
                                $('#act_image').attr('src', 'data/attachment/forum/'+dataarr[5]);
                                $('#activityaid').val(dataarr[3]);
                                $('#activityaid_url').val(dataarr[5]);
                            }else{
                                $('#imglist').append('<li><span aid="'+dataarr[3]+'" class="del" onclick="deletepic(this)" id="'+dataarr[3]+'"><a href="javascript:;"><img src="static/image/mobile/images/icon_del.png"></a></span><span class="p_img"><a href="javascript:;"><img style="height:54px;width:54px;" id="aimg_'+dataarr[3]+'" title="'+dataarr[6]+'" src="data/attachment/forum/'+dataarr[5]+'" /></a></span><input type="hidden" name="attachnew['+dataarr[3]+'][description]" /></li>');
                            }

                        } else {
                            var sizelimit = '';
                            if(dataarr[7] == 'ban') {
                                sizelimit = '(附件类型被禁止)';
                            } else if(dataarr[7] == 'perday') {
                                sizelimit = '(不能超过'+Math.ceil(dataarr[8]/1024)+'K)';
                            } else if(dataarr[7] > 0) {
                                sizelimit = '(不能超过'+Math.ceil(dataarr[7]/1024)+'K)';
                            }
                            popup.open(STATUSMSG[dataarr[2]] + sizelimit, 'alert');
                        }
                    }
                }

                if(obj.attr('alt')=='album' || obj.attr('alt')=='blog'){
                    var upurl='misc.php?mod=swfupload&action=swfupload&operation=album&type=image&inajax=yes&infloat=yes';
                }else{
                    var upurl='misc.php?mod=swfupload&operation=upload&type=image&inajax=yes&infloat=yes&simple=2';
                }

                if(typeof FileReader != 'undefined' && the.files[0]) {
                    for (var i=0;i<the.files.length;i++){
                        $.buildfileupload({
                            uploadurl:upurl,
                            file:the.files[i],
                            uploadformdata:{uid:"4799", hash:"970b6084f5b81906a315d5a1325afa07"},
                            uploadinputname:'Filedata',
                            maxfilesize:"51200",
                            success:uploadsuccess,
                            error:function() {
                                popup.open('上传失败，请稍后再试', 'alert');
                            }
                        });
                    }
                } else {
                    $.ajaxfileupload({
                        url:upurl,
                        data:{uid:"4799", hash:"970b6084f5b81906a315d5a1325afa07"},
                        dataType:'text',
                        fileElementId:the.id,
                        success:uploadsuccess,
                        error: function() {
                            popup.open('上传失败，请稍后再试', 'alert');
                        }
                    });
                }
            }

        }
        function deletepic(the){

            obj=$('#'+the.id);
            if(obj.alt=='album'){
                var deleteurl='home.php?mod=spacecp&ac=album&op=editpic&albumid=-1&subop=delete&editpicsubmit=true&inajax=yes&formhash=c76475d3&ids[]=' + obj.attr('picid');
                var ajaxtype='POST';
            }else{
                var deleteurl='forum.php?mod=ajax&action=deleteattach&pid=&inajax=yes&aids[]=' + obj.attr('aid');
                var ajaxtype='GET';
            }
            alert(the.id);
            $.ajax({
                type:ajaxtype,
                url:deleteurl,
            })
                    .success(function(s) {
                        obj.parent().remove();
                    })
                    .error(function() {
                        popup.open('网络出现问题，请稍后再试', 'alert');
                    });
            return false;
        }

    </script>  <script type="text/javascript" id="script_addthread" reload="1">

    (function() {
        var needsubject = needmessage = false;


        $('#needsubject').on('keyup input', function() {
            var obj = $(this);
            if(obj.val()) {
                needsubject = true;
                if(needmessage == true) {
                    $('.imui_btn').removeClass('cg').addClass('cf');
                    $('#postsubmit').removeAttr("disabled");
                }
            } else {
                needsubject = false;
                $('.imui_btn').removeClass('cf').addClass('cg');
                $('#postsubmit').attrattr('disabled',"true");
            }
        });
        $('#postmessage').on('keyup input', function() {
            var obj = $(this);
            if(obj.val()) {
                needmessage = true;
                if(needsubject == true) {
                    $('.imui_btn').removeClass('cg').addClass('cf');
                    $('#postsubmit').removeAttr("disabled");
                }
            } else {
                needmessage = false;
                $('.imui_btn').removeClass('cf').addClass('cg');
                $('#postsubmit').attr('disabled',"true");
            }
        });

    })();

    /*tag*/
    function cnCode(str) {
        str = str.replace(/<\/?[^>]+>|\[\/?.+?\]|"/ig, "");
        str = str.replace(/\s{2,}/ig, ' ');
        return str;
    }
    function relatekw(subject,message) {

        if(isUndefined(subject) || subject == -1) {
            subject = cnCode(document.getElementById('needsubject').value);
        }
        if(isUndefined(message) || message == -1) {
            message = cnCode(document.getElementById('postmessage').value);
        }
        message = message.replace(/&/ig, '', message).substr(0, 500);

        $.ajax({
            type:'GET',
            url:'forum.php?mod=relatekw&form=mobile&subjectenc=' + subject + '&messageenc=' + message,
            dataType:'xml',
        })
                .success(function(s) {
                    $("#tags").val(s.lastChild.firstChild.nodeValue);
                })
                .error(function() {
                    return false;
                });
    }


    $('#postsubmit').on('click', function() {
        var obj = $(this);
        var form=$('#threadpostform');
        //obj.attr('disabled',"true").removeClass('cf').addClass('cg');
        popup.open('<img src="' + IMGDIR + '/imageloading.gif">');

        var postlocation = '';
        if(geo.errmsg === '' && geo.loc) {
            postlocation = geo.longitude + '|' + geo.latitude + '|' + geo.loc;
        }


        $.ajax({
            type:'POST',
            url:form.attr('action') + '&geoloc=' + postlocation + '&handlekey='+form.attr('id')+'&inajax=1',
            data:form.serialize(),
            dataType:'xml'
        })
                .success(function(s) {
                    evalscript(s.lastChild.firstChild.nodeValue);
                })
                .error(function() {
                    popup.open('网络出现问题，请稍后再试', 'alert');
                });
        return false;
    });

    function succeedhandle_threadpostform(locationhref, message, param) {
        var tid = param['tid'];
        goto('forum.php?mod=viewthread&tid='+tid,'viewthread');
    }
    function errorhandle_threadpostform(message, param) {
        popup.open(message, 'alert');
    }
</script>
</div>